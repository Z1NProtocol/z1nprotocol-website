<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Z1N Protocol â€“ Signals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #050812;
      --card-bg: #020617;
      --text-main: #ffffff;
      --text-soft: #8f9ab5;
      --accent: #66d69a;
      --accent-soft: #3a9f63;
      --keys-accent: #f5c842;
      --keys-accent-soft: #d4a012;
      --card-border: rgba(148, 163, 184, 0.25);
      --border-soft: rgba(148,163,184,0.35);
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    /* HEADER */
    header {
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 20px;
    }

    .nav-inner {
      width: 100%;
      max-width: 1200px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-link { display: inline-flex; align-items: center; gap: 8px; }

    .logo-dot {
      width: 24px; height: 24px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.35);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }

    .logo-text {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .nav-links {
      display: flex;
      gap: 22px;
      font-size: 13px;
      opacity: 0.85;
    }

    .nav-links a.active { color: var(--keys-accent); }

    /* MAIN */
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px 80px;
    }

    h1 {
      font-size: 40px;
      margin-bottom: 8px;
      color: var(--keys-accent);
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 15px;
      color: var(--text-soft);
      margin-bottom: 24px;
      max-width: 900px;
    }

    /* KEY HEADER CARD */
    .key-header-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .key-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .key-id {
      font-size: 20px;
      font-weight: 600;
    }

    .key-glyphs {
      font-size: 16px;
      font-family: "Segoe UI Symbol", "Apple Symbols", sans-serif;
    }

    .key-stats {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .stat-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-label { margin-right: 4px; line-height: 1; }

    .stat-dots {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Unified dot indicators */
    .dot-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid;
      vertical-align: middle;
    }
    .dot-indicator.filled {
      background: #4ade80;
      border-color: #4ade80;
    }
    .dot-indicator.open {
      background: transparent;
      border-color: var(--keys-accent);
    }
    /* Legacy text-based dots (fallback) */
    .dot-filled { color: #4ade80; font-size: 14px; }
    .dot-open { color: var(--keys-accent); font-size: 14px; }

    /* TWO COLUMN LAYOUT */
    .signals-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 800px) {
      .signals-layout { grid-template-columns: 1fr; }
    }

    /* CARDS */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-soft);
      margin-bottom: 16px;
    }

    /* POG card title in gold */
    .pog-card .card-title {
      color: var(--keys-accent);
    }

    /* Pure card - white styling */
    .pure-card {
      border-color: var(--border-soft);
    }

    .pure-card .card-title {
      color: var(--text-main);
    }

    /* SIGNAL TYPE TOGGLE */
    .toggle-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 16px;
    }

    .toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(245, 200, 66, 0.35);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn:hover {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.1);
    }

    .toggle-btn.active {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.2);
      color: var(--keys-accent);
    }

    /* INTENT GRID */
    .intent-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 16px;
    }

    .intent-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 6px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(245, 200, 66, 0.35);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .intent-btn:hover {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.1);
    }

    .intent-btn.selected {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.2);
    }

    .intent-symbol {
      font-size: 13px;
      font-weight: 700;
    }

    .intent-name {
      font-size: 9px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .intent-btn[data-intent="0"] .intent-symbol { color: #4ade80; }
    .intent-btn[data-intent="1"] .intent-symbol { color: #f87171; }
    .intent-btn[data-intent="2"] .intent-symbol { color: #fbbf24; }
    .intent-btn[data-intent="3"] .intent-symbol { color: #60a5fa; }

    /* TEXT INPUT */
    .input-group {
      margin-bottom: 12px;
    }

    .input-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }

    .char-count { color: var(--keys-accent); }

    textarea, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--keys-accent);
    }

    textarea::placeholder, input::placeholder {
      color: var(--text-soft);
      opacity: 0.6;
    }

    /* Pure card inputs - white border on focus */
    .pure-card textarea:focus, .pure-card input[type="text"]:focus, .pure-card input[type="number"]:focus {
      border-color: var(--text-main);
    }
    
    /* Number input - hide spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* Fee tooltip */
    .fee-tooltip {
      cursor: help;
      border-bottom: 1px dotted var(--text-soft);
    }
    .fee-tooltip:hover {
      color: var(--keys-accent);
    }

    /* Clickable stat groups */
    .stat-group.clickable {
      cursor: pointer;
      padding: 4px 8px;
      margin: -4px -8px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .stat-group.clickable:hover {
      background: rgba(245, 200, 66, 0.1);
    }

    /* CARD SPACER - pushes footer to bottom */
    .card-spacer {
      flex: 1;
    }

    /* SUBMIT ROW - at bottom of card */
    .submit-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 14px;
    }

    .fee-display {
      font-size: 12px;
      color: var(--text-soft);
    }

    .fee-amount {
      color: var(--keys-accent);
      font-weight: 600;
    }

    .fee-amount.free {
      color: var(--accent);
    }

    /* POG Submit button - gold */
    .btn-submit {
      padding: 10px 24px;
      border-radius: 999px;
      border: 1px solid var(--keys-accent-soft);
      background: linear-gradient(90deg, rgba(245,200,66,0.55), rgba(212,160,18,0.55));
      color: #061018;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-submit:hover:not([disabled]) {
      transform: translateY(-1px);
      background: linear-gradient(90deg, var(--keys-accent), var(--keys-accent-soft));
      box-shadow: 0 6px 16px rgba(0,0,0,0.3), 0 0 12px rgba(245,200,66,0.15);
    }

    .btn-submit[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Pure Submit button - mode-btn style from about.html */
    .btn-whisper {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 24px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease, background 180ms ease, color 180ms ease;
    }

    .btn-whisper:hover:not([disabled]) {
      border-color: var(--accent);
    }

    .btn-whisper[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* STATUS */
    .status-msg {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 10px;
    }

    .status-msg.error {
      background: rgba(249, 115, 115, 0.1);
      border: 1px solid rgba(249, 115, 115, 0.3);
      color: var(--danger);
    }

    .status-msg.success {
      background: rgba(102, 214, 154, 0.1);
      border: 1px solid rgba(102, 214, 154, 0.3);
      color: var(--accent);
    }

    .status-msg.pending {
      background: rgba(245, 200, 66, 0.1);
      border: 1px solid rgba(245, 200, 66, 0.3);
      color: var(--keys-accent);
    }

    /* CONNECT STATE */
    .connect-prompt {
      text-align: center;
      padding: 60px 20px;
    }

    .connect-prompt p {
      color: var(--text-soft);
      margin-bottom: 20px;
    }

    .btn-connect {
      padding: 12px 28px;
      border-radius: 999px;
      border: 1px solid var(--keys-accent);
      background: transparent;
      color: var(--keys-accent);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-connect:hover {
      background: rgba(245, 200, 66, 0.1);
    }

    /* BACK LINK */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
      font-size: 13px;
      margin-bottom: 20px;
      transition: color 0.2s;
    }

    .back-link:hover { color: var(--keys-accent); }

    /* LINK TO ATTESTS */
    .attests-link {
      text-align: center;
      margin-top: 24px;
    }

    .attests-link a {
      color: var(--keys-accent);
      font-size: 13px;
    }

    .attests-link a:hover {
      text-decoration: underline;
    }

    /* REPLY TO SECTION */
    .reply-section {
      display: none;
      margin-bottom: 12px;
      padding: 10px 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--card-border);
      border-radius: 8px;
    }

    .reply-section.active {
      display: block;
    }

    .reply-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .reply-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-family: monospace;
      font-size: 12px;
    }

    .reply-input:focus {
      outline: none;
      border-color: var(--keys-accent);
    }

    /* REPLY MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--keys-accent);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-soft);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-main);
    }

    .modal-filters {
      padding: 12px 20px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .filter-input {
      width: 70px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-size: 12px;
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--keys-accent);
    }

    .filter-select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--keys-accent);
    }

    .filter-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: transparent;
      color: var(--text-soft);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: var(--keys-accent);
      color: var(--keys-accent);
    }

    .filter-btn.active {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.15);
      color: var(--keys-accent);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px 20px;
    }

    .signals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .signal-card {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .signal-card:hover {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.05);
    }

    .signal-card.selected {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.1);
    }

    .signal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .signal-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .signal-key {
      font-weight: 600;
      color: var(--keys-accent);
    }
    
    /* NEW: Key glyphs in signal card */
    .signal-key-glyphs {
      font-size: 10px;
      color: var(--text-soft);
      font-family: "Segoe UI Symbol", "Apple Symbols", sans-serif;
    }

    .signal-intent {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .signal-intent.oc { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .signal-intent.oi { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    .signal-intent.ok { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .signal-intent.os { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }

    .signal-epoch {
      color: var(--text-soft);
      font-size: 11px;
      cursor: help;
    }

    .signal-attests {
      font-size: 11px;
      cursor: help;
    }

    .signal-time {
      color: var(--text-soft);
      font-size: 11px;
    }

    .signal-content {
      font-size: 13px;
      color: var(--text-main);
      line-height: 1.4;
      margin-bottom: 8px;
      word-break: break-word;
      max-height: 60px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .signal-content.expanded {
      max-height: none;
    }

    .signal-content:not(.expanded)::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, rgba(15, 23, 42, 0.9));
      pointer-events: none;
    }

    .signal-content.short::after {
      display: none;
    }

    .signal-content.silence {
      font-style: italic;
      color: var(--text-soft);
    }

    .expand-hint {
      font-size: 10px;
      color: var(--keys-accent);
      margin-top: 4px;
      opacity: 0.8;
    }

    .signal-stats {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .signal-stats .attests {
      color: var(--accent);
    }

    .signal-hash {
      font-family: monospace;
      font-size: 10px;
      color: var(--text-soft);
      opacity: 0.7;
    }

    .load-more-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px dashed var(--card-border);
      background: transparent;
      color: var(--text-soft);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .load-more-btn:hover {
      border-color: var(--keys-accent);
      color: var(--keys-accent);
    }

    .no-signals {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-soft);
    }

    .loading-signals {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-soft);
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .selected-signal-info {
      font-size: 12px;
      color: var(--text-soft);
    }

    .selected-signal-info .hash {
      font-family: monospace;
      color: var(--keys-accent);
    }

    .btn-select-signal {
      padding: 8px 20px;
      border-radius: 999px;
      border: 1px solid var(--keys-accent);
      background: rgba(245, 200, 66, 0.2);
      color: var(--keys-accent);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-select-signal:hover:not([disabled]) {
      background: rgba(245, 200, 66, 0.3);
    }

    .btn-select-signal[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* RESPONSIVE */
    @media (max-width: 600px) {
      .intent-grid { grid-template-columns: repeat(2, 1fr); }
      .key-header-card { flex-direction: column; align-items: flex-start; }
      .key-stats { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<header>
  <div class="nav-inner">
    <a href="/index.html" class="logo-link">
      <div class="logo-dot">Î©</div>
      <div class="logo-text">Z1N Protocol</div>
    </a>
    <nav class="nav-links">
      <a href="/about.html">About</a>
      <a href="/live-stats.html">Live Stats</a>
      <a href="/mint-key.html">Mint Key</a>
      <a href="/your-keys.html">Your Keys</a>
      <a href="/signals.html" class="active">Signals</a>
    </nav>
  </div>
</header>

<main class="page">
  <a href="/your-keys.html" class="back-link" id="backLink">â† Back to Your Keys</a>

  <h1>Signals</h1>
  <p class="subtitle">Participate in the Field's collective intelligence through Proof of Glyph signals.</p>

  <!-- CONNECT STATE -->
  <div id="connectState" class="connect-prompt">
    <p>Connect your wallet to send signals</p>
    <button class="btn-connect" id="btnConnect">Connect Wallet</button>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent" style="display:none;">

    <!-- KEY HEADER -->
    <div class="key-header-card">
      <div class="key-info">
        <span class="key-id" id="keyIdDisplay">Key #â€”</span>
        <span class="key-glyphs" id="keyGlyphs">â€”</span>
      </div>
      <div class="key-stats">
        <div class="stat-group">
          <span class="stat-label">Wallet:</span>
          <span id="activeWalletDisplay" style="font-family:monospace; font-size:11px; color:var(--keys-accent); position:relative; top:1px;">â€”</span>
        </div>
        <div class="stat-group clickable" onclick="focusSignalContent()" title="Click to compose signal">
          <span class="stat-label">Signals:</span>
          <div class="stat-dots" id="signalDots">
            <span class="dot-indicator open"></span>
            <span class="dot-indicator open"></span>
          </div>
        </div>
        <div class="stat-group clickable" onclick="goToAttests()" title="Click to view attestable signals">
          <span class="stat-label">Attests:</span>
          <div class="stat-dots" id="attestDots">
            <span class="dot-indicator open"></span>
            <span class="dot-indicator open"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- TWO COLUMN LAYOUT -->
    <div class="signals-layout">

      <!-- POG SIGNAL CARD -->
      <div class="card pog-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <div class="card-title" style="margin-bottom:0;">âš¡ PoG Signal</div>
          <span id="stealthBadge" style="display:none; background:rgba(255,255,255,0.15); color:#ffffff; padding:3px 10px; border-radius:4px; font-size:10px; cursor:help;" title="Stealth Mode: Signals sent via anonymous relayer. No protocol fee, identity protected on-chain.">ğŸ”’ STEALTH</span>
        </div>

        <!-- Signal Type Toggle -->
        <div class="toggle-grid">
          <button class="toggle-btn active" data-type="new" onclick="setSignalType('new')">New Signal</button>
          <button class="toggle-btn" data-type="reply" onclick="setSignalType('reply')">Reply To</button>
        </div>

        <!-- Reply To Section (hidden by default) -->
        <div class="reply-section" id="replySection">
          <div class="reply-label">Signal to reply to:</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" class="reply-input" id="replyToHash" placeholder="0x... or click Browse" style="flex:1;">
            <button type="button" onclick="openReplyModal()" style="padding:8px 14px; border-radius:6px; border:1px solid var(--keys-accent); background:transparent; color:var(--keys-accent); font-size:12px; cursor:pointer; white-space:nowrap;">ğŸ“‹ Browse</button>
          </div>
          <div id="selectedSignalPreview" style="display:none; margin-top:10px; padding:10px; background:rgba(245,200,66,0.1); border-radius:8px; font-size:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span id="previewMeta"></span>
              <button type="button" onclick="clearReplySelection()" style="background:none; border:none; color:var(--text-soft); cursor:pointer; font-size:14px;">âœ•</button>
            </div>
            <div id="previewContent" style="margin-top:6px; color:var(--text-main);"></div>
          </div>
        </div>

        <!-- Intent Selector -->
        <div class="input-label">Intent</div>
        <div class="intent-grid">
          <div class="intent-btn selected" data-intent="0" onclick="selectIntent(0)" title="Collective consciousness - What are we becoming together?">
            <div class="intent-symbol">Î©C</div>
            <div class="intent-name">Collective</div>
          </div>
          <div class="intent-btn" data-intent="1" onclick="selectIntent(1)" title="Individual expression - Who am I, uniquely?">
            <div class="intent-symbol">Î©I</div>
            <div class="intent-name">Individual</div>
          </div>
          <div class="intent-btn" data-intent="2" onclick="selectIntent(2)" title="Co-creation - How shall we build further?">
            <div class="intent-symbol">Î©K</div>
            <div class="intent-name">Co-Create</div>
          </div>
          <div class="intent-btn" data-intent="3" onclick="selectIntent(3)" title="Silence - The heaviest breath (1.5Ã— fee, 1.1Ã— weight)">
            <div class="intent-symbol">Î©S</div>
            <div class="intent-name">Silence</div>
          </div>
        </div>

        <!-- Content Input (hidden for Silence) -->
        <div class="input-group" id="signalContentCard">
          <div class="input-label">
            <span>Signal Content</span>
            <span class="char-count" id="charCount">0 / 280</span>
          </div>
          <textarea id="signalContent" placeholder="Your signal to the Field..." maxlength="280" oninput="updateCharCount()"></textarea>
        </div>

        <!-- Spacer -->
        <div class="card-spacer"></div>

        <!-- Submit -->
        <div class="submit-row">
          <div class="fee-display">
            <span class="fee-tooltip" title="Protocol fee goes to the Treasury for epoch winner distribution">Protocol Fee: <span class="fee-amount" id="pogFee">0.01 POL</span></span> <span style="font-size:10px; color:var(--text-soft);">+ gas</span>
          </div>
          <button class="btn-submit" id="btnSubmitPog" onclick="submitPoGSignal()">Submit Signal</button>
        </div>

        <div id="pogStatus"></div>
      </div>

      <!-- PURE SIGNAL CARD -->
      <div class="card pure-card">
        <div class="card-title">â— Pure Signal</div>
        <p style="font-size:12px;color:var(--text-soft);margin-bottom:14px;">
          No protocol fee, no attestation, no game impact. Unlimited whispers between Keys. Only gas costs apply.
        </p>

        <!-- Recipient Key ID (aligned with Intent row) -->
        <div class="input-group">
          <div class="input-label">Recipient Key ID (0 = broadcast)</div>
          <input type="number" id="pureRecipient" value="0" min="0" placeholder="0" oninput="debounceValidateRecipient()">
          <div id="recipientError" style="display:none; color:#f87171; font-size:11px; margin-top:4px;">âš ï¸ Key ID does not exist</div>
        </div>

        <!-- Message (aligned with Signal Content) -->
        <div class="input-group">
          <div class="input-label">
            <span>Message</span>
            <span class="char-count" id="pureCharCount">0 / 500</span>
          </div>
          <textarea id="pureContent" placeholder="Your whisper..." maxlength="500" oninput="updatePureCharCount()"></textarea>
        </div>

        <!-- Spacer -->
        <div class="card-spacer"></div>

        <!-- Submit -->
        <div class="submit-row">
          <div class="fee-display">
            <span>Protocol Fee: <span class="fee-amount free">Free</span></span>
            <span style="font-size:10px; color:var(--text-soft); margin-left:8px;">(gas only)</span>
          </div>
          <button class="btn-whisper" id="btnSubmitPure" onclick="submitPureSignal()">Send Whisper</button>
        </div>

        <div id="pureStatus"></div>
      </div>

    </div>

    <!-- LINK TO ATTESTS -->
    <div class="attests-link">
      <a href="/attests.html" id="attestsLink" onclick="goToAttests(); return false;">View Attestable Signals â†’</a>
    </div>

  </div>
</main>

<!-- REPLY TO MODAL -->
<div class="modal-overlay" id="replyModal">
  <div class="modal" style="max-width:700px;">
    <div class="modal-header">
      <span class="modal-title">ğŸ“‹ Browse Signals</span>
      <button class="modal-close" onclick="closeReplyModal()">&times;</button>
    </div>
    
    <div class="modal-filters">
      <div class="filter-group">
        <span class="filter-label">Key ID:</span>
        <input type="number" class="filter-input" id="filterKeyId" placeholder="All" min="0" oninput="debouncedFilter()" onchange="immediateFilter()">
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Epoch:</span>
        <input type="number" class="filter-input" id="filterEpochFrom" placeholder="From" min="0" style="width:55px;" oninput="debouncedFilter()" onchange="immediateFilter()">
        <span style="color:var(--text-soft);">â€“</span>
        <input type="number" class="filter-input" id="filterEpochTo" placeholder="To" min="0" style="width:55px;" oninput="debouncedFilter()" onchange="immediateFilter()">
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Sort:</span>
        <select class="filter-select" id="filterSort" onchange="immediateFilter()">
          <option value="recent">Most Recent</option>
          <option value="attested">Most Attested</option>
          <option value="oldest">Oldest First</option>
        </select>
      </div>
      
      <button class="filter-btn" onclick="resetFilters()" title="Clear all filters">â†º Clear</button>
      <button class="filter-btn" onclick="downloadSignalsCSV()" title="Download all filtered signals as CSV">ğŸ“¥ CSV</button>
    </div>
    
    <!-- LEGEND -->
    <div style="padding:8px 20px; border-bottom:1px solid var(--card-border); font-size:10px; color:var(--text-soft); display:flex; gap:16px; flex-wrap:wrap;">
      <span title="Key ID and Glyphs"><strong style="color:var(--keys-accent);">K#</strong> = Key ID</span>
      <span title="Intent Layer: Î©C=Collective, Î©I=Individual, Î©K=Co-Create, Î©S=Silence"><strong style="color:#4ade80;">Î©C</strong>/<strong style="color:#f87171;">Î©I</strong>/<strong style="color:#fbbf24;">Î©K</strong>/<strong style="color:#60a5fa;">Î©S</strong> = Intent</span>
      <span title="Epoch number"><strong>Epoch</strong> = Time period</span>
      <span title="Number of attestations received"><strong style="color:#fbbf24;">âœ“</strong> = Attestations</span>
    </div>
    
    <div class="modal-body">
      <div class="loading-signals" id="signalsLoading">Loading signals...</div>
      <div class="no-signals" id="noSignals" style="display:none;">No signals found matching your filters.</div>
      <div class="signals-list" id="signalsList"></div>
      <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreSignals()" style="display:none;">Load More Signals...</button>
    </div>
    
    <div class="modal-footer">
      <div class="selected-signal-info" id="selectedInfo">
        <span id="signalCountInfo" style="font-size:11px; color:var(--text-soft);">â€“ signals</span>
      </div>
      <button class="btn-select-signal" id="btnConfirmSelect" onclick="confirmSignalSelection()" disabled>Select Signal</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var CHAIN_ID = '0x13882';
  var Z1N_KEY = '0x71B31cb8FC0e4D538c2865FeBBfC8C56f41a00d6';
  var Z1N_CORE = '0xade14831356722154A39D40a8EBd4ee1FD4c7D6a';
  var Z1N_SIGNAL = '0x85f0A512cd246A6e659E2D188763482F587dc9f7';
  var RPC_URL = 'https://rpc-amoy.polygon.technology';
  var EXPLORER = 'https://amoy.polygonscan.com';
  var API_BASE = 'http://localhost:3001/api';  // Z1N API server for stealth relay

  // Fee constants (in wei)
  var SUBMISSION_FEE = '10000000000000000'; // 0.01 POL
  var SILENCE_FEE = '15000000000000000';    // 0.015 POL

  var SEL = {
    balanceOf: '0x70a08231',
    tokenOfOwnerByIndex: '0x2f745c59',
    ownerOf: '0x6352211e',
    glyphs: '0x887296c3',
    currentEpoch: '0x76671808',
    signalCount: '0xfd68f0e5',
    attestCount: '0xfe6569d7'
  };

  var GLYPHS = ['âˆ','Ï€','â‹®','âŠ•','âŠ—','âˆ´','âˆµ','â†”','â†»','â–³','â—‡','â—‹','â—','â–¡','â˜°','â˜·','âš‘','âœ±','âŠ¥','â‰¡','â—Š'];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var provider = null;
  var currentAccount = null;
  var currentKeyId = null;
  var currentEpoch = 0;
  var selectedIntent = 0;
  var signalType = 'new';
  var signalsUsed = 0;
  var attestsUsed = 0;
  var stealthMode = false;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STEALTH MODE CHECK
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function isStealthEnabled(keyId) {
    try {
      var settings = JSON.parse(localStorage.getItem('z1n_stealth_keys') || '{}');
      return settings[keyId] === true;
    } catch (e) {
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GET PROVIDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getProvider() {
    if (window.ethereum && window.ethereum.providers) {
      return window.ethereum.providers.find(function(p) { return p.isMetaMask; }) || window.ethereum;
    }
    return window.ethereum;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function encodeUint256(val) {
    return BigInt(val).toString(16).padStart(64, '0');
  }

  function encodeAddress(addr) {
    return addr.slice(2).toLowerCase().padStart(64, '0');
  }

  function encodeBytes32(str) {
    // Convert string to bytes32 hex (UTF-8, padded)
    var hex = '';
    for (var i = 0; i < str.length && i < 32; i++) {
      hex += str.charCodeAt(i).toString(16).padStart(2, '0');
    }
    return hex.padEnd(64, '0');
  }

  function stringToHex(str) {
    var hex = '';
    for (var i = 0; i < str.length; i++) {
      hex += str.charCodeAt(i).toString(16).padStart(2, '0');
    }
    return hex;
  }

  function keccak256Simple(str) {
    // Simple hash for signal hash - in production use proper keccak
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
      var char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return '0x' + Math.abs(hash).toString(16).padStart(64, '0');
  }

  async function rpcCall(method, params) {
    var response = await fetch(RPC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: method, params: params })
    });
    var data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return data.result;
  }

  function decodeGlyphs(len, pack) {
    if (len === 0 || pack === BigInt(0)) return null;
    var symbols = [];
    for (var i = 0; i < len; i++) {
      var shift = BigInt(5 * (7 - 1 - i));
      var idx = Number((pack >> shift) & BigInt(0x1F));
      if (idx < GLYPHS.length) symbols.push(GLYPHS[idx]);
    }
    return '<span style="color:#fff">' + symbols.join('</span><span style="color:#5d6680;margin:0 2px">Â·</span><span style="color:#fff">') + '</span>';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // URL PARAMS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getUrlParam(name) {
    var params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UI FUNCTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.selectIntent = function(intent) {
    selectedIntent = intent;
    document.querySelectorAll('.intent-btn').forEach(function(btn) {
      btn.classList.toggle('selected', parseInt(btn.dataset.intent) === intent);
    });
    var fee = intent === 3 ? '0.015 POL' : '0.01 POL';
    document.getElementById('pogFee').textContent = fee;
    
    // Show/hide content card based on Silence selection
    var contentCard = document.getElementById('signalContentCard');
    if (contentCard) {
      contentCard.style.display = intent === 3 ? 'none' : 'block';
    }
  };

  window.setSignalType = function(type) {
    signalType = type;
    document.querySelectorAll('.toggle-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.type === type);
    });
    document.getElementById('replySection').classList.toggle('active', type === 'reply');
  };

  window.updateCharCount = function() {
    var content = document.getElementById('signalContent').value;
    document.getElementById('charCount').textContent = content.length + ' / 280';
  };

  window.updatePureCharCount = function() {
    var content = document.getElementById('pureContent').value;
    document.getElementById('pureCharCount').textContent = content.length + ' / 500';
  };

  function updateStatusDots() {
    var signalDotsEl = document.getElementById('signalDots');
    var attestDotsEl = document.getElementById('attestDots');

    var s1 = signalsUsed >= 1 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    var s2 = signalsUsed >= 2 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    signalDotsEl.innerHTML = s1 + ' ' + s2;

    var a1 = attestsUsed >= 1 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    var a2 = attestsUsed >= 2 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    attestDotsEl.innerHTML = a1 + ' ' + a2;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VERIFY KEY OWNERSHIP
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function verifyKeyOwnership(tokenId, expectedOwner) {
    var data = SEL.ownerOf + encodeUint256(tokenId);
    var result = await rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest']);
    var owner = '0x' + result.slice(26).toLowerCase();
    return owner.toLowerCase() === expectedOwner.toLowerCase();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOAD KEY DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadKeyData(keyId) {
    try {
      // Verify ownership first
      var ownerData = SEL.ownerOf + encodeUint256(keyId);
      var ownerResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: ownerData }, 'latest']);
      var keyOwner = '0x' + ownerResult.slice(26).toLowerCase();
      
      if (keyOwner.toLowerCase() !== currentAccount.toLowerCase()) {
        // Key not owned by selected wallet - show warning
        document.getElementById('keyIdDisplay').textContent = 'Key #' + keyId;
        document.getElementById('keyGlyphs').innerHTML = '<span style="color:#f87171; font-size:13px;">âš ï¸ Key owned by ' + keyOwner.slice(0,6) + '...' + keyOwner.slice(-4) + ', not current wallet. <a href="/your-keys.html?wallet=' + encodeURIComponent(keyOwner) + '" style="color:var(--keys-accent);">Go back</a> to select the right wallet.</span>';
        
        // Disable submit buttons (both PoG and Pure)
        var submitBtn = document.getElementById('btnSubmitPog');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.5';
        }
        var pureBtn = document.getElementById('btnSubmitPure');
        if (pureBtn) {
          pureBtn.disabled = true;
          pureBtn.style.opacity = '0.5';
        }
        return;
      }
      
      // Enable submit buttons
      var submitBtn = document.getElementById('btnSubmitPog');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
      }
      var pureBtn = document.getElementById('btnSubmitPure');
      if (pureBtn) {
        pureBtn.disabled = false;
        pureBtn.style.opacity = '1';
      }
      
      // Get glyphs
      var glyphData = SEL.glyphs + encodeUint256(keyId);
      var glyphResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: glyphData }, 'latest']);
      var len = parseInt(glyphResult.slice(2, 66), 16);
      var pack = BigInt('0x' + glyphResult.slice(66, 130));
      var glyphStr = decodeGlyphs(len, pack);

      document.getElementById('keyIdDisplay').textContent = 'Key #' + keyId;
      document.getElementById('keyGlyphs').innerHTML = glyphStr || 'â€”';

      // Get current epoch
      var epochResult = await rpcCall('eth_call', [{ to: Z1N_CORE, data: SEL.currentEpoch }, 'latest']);
      currentEpoch = parseInt(epochResult, 16);

      // Get signal/attest counts
      var signalData = SEL.signalCount + encodeUint256(keyId) + encodeUint256(currentEpoch);
      var signalResult = await rpcCall('eth_call', [{ to: Z1N_SIGNAL, data: signalData }, 'latest']);
      signalsUsed = parseInt(signalResult, 16);

      var attestData = SEL.attestCount + encodeUint256(keyId) + encodeUint256(currentEpoch);
      var attestResult = await rpcCall('eth_call', [{ to: Z1N_SIGNAL, data: attestData }, 'latest']);
      attestsUsed = parseInt(attestResult, 16);

      updateStatusDots();

    } catch (e) {
      console.error('Error loading key data:', e);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ABI ENCODING WITH ETHERS.JS (loaded from CDN)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // We'll load ethers dynamically if needed
  var ethersLoaded = false;
  var ethersLib = null;
  
  async function loadEthers() {
    if (ethersLoaded) return ethersLib;
    
    return new Promise(function(resolve, reject) {
      var script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js';
      script.onload = function() {
        ethersLib = window.ethers;
        ethersLoaded = true;
        console.log('Ethers.js loaded');
        resolve(ethersLib);
      };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // Load ethers on page load
  loadEthers().catch(function(e) { console.warn('Could not load ethers.js:', e); });

  function createSignalHash(content, tokenId, epoch) {
    // Create a deterministic hash from content + tokenId + epoch + timestamp
    var combined = content + '|' + tokenId + '|' + epoch + '|' + Date.now() + '|' + Math.random();
    
    // Simple hash function (djb2 variant)
    var hash1 = 5381;
    var hash2 = 52711;
    for (var i = 0; i < combined.length; i++) {
      var char = combined.charCodeAt(i);
      hash1 = ((hash1 << 5) + hash1) ^ char;
      hash2 = ((hash2 << 5) + hash2) ^ char;
    }
    
    var hex1 = (hash1 >>> 0).toString(16).padStart(8, '0');
    var hex2 = (hash2 >>> 0).toString(16).padStart(8, '0');
    var timestamp = Date.now().toString(16).padStart(12, '0');
    var random = Math.floor(Math.random() * 0xFFFFFFFF).toString(16).padStart(8, '0');
    
    var hashHex = (hex1 + hex2 + timestamp + random).padEnd(64, '0').slice(0, 64);
    return '0x' + hashHex;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SUBMIT POG SIGNAL - Using ethers.js for encoding
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.submitPoGSignal = async function() {
    var statusEl = document.getElementById('pogStatus');
    var content = document.getElementById('signalContent').value.trim();

    // Silence intent doesn't need content
    if (selectedIntent !== 3 && !content) {
      statusEl.innerHTML = '<div class="status-msg error">Please enter signal content.</div>';
      return;
    }

    if (signalsUsed >= 2) {
      statusEl.innerHTML = '<div class="status-msg error">Maximum 2 PoG signals already sent this epoch.</div>';
      return;
    }

    if (!provider || !currentAccount) {
      statusEl.innerHTML = '<div class="status-msg error">Wallet not connected.</div>';
      return;
    }

    // Verify ownership first
    statusEl.innerHTML = '<div class="status-msg pending">Verifying key ownership...</div>';

    try {
      var isOwner = await verifyKeyOwnership(currentKeyId, currentAccount);
      if (!isOwner) {
        statusEl.innerHTML = '<div class="status-msg error">You do not own Key #' + currentKeyId + ' with this wallet.</div>';
        return;
      }

      // Load ethers if not already loaded
      statusEl.innerHTML = '<div class="status-msg pending">Preparing transaction...</div>';
      await loadEthers();

      // Parameters
      var tokenId = currentKeyId;
      var signalHash = createSignalHash(content || 'silence', tokenId, currentEpoch);
      var cid = selectedIntent === 3 ? '' : content.slice(0, 250);
      var symbolIndex = 0;
      var intent = selectedIntent;
      var signalTypeVal = selectedIntent === 3 ? 3 : 2; // SILENCE or META
      var epochRef = 0;
      var replyToBytes32 = '0x0000000000000000000000000000000000000000000000000000000000000000';

      // If replying
      if (signalType === 'reply') {
        var replyInput = document.getElementById('replyToHash').value.trim();
        if (replyInput && replyInput.startsWith('0x') && replyInput.length >= 66) {
          replyToBytes32 = replyInput.slice(0, 66);
          signalTypeVal = 1;
          epochRef = currentEpoch > 0 ? currentEpoch - 1 : 0;
        }
      }

      // Fee (stealth mode = no protocol fee)
      var feeWei = stealthMode ? '0' : (selectedIntent === 3 ? SILENCE_FEE : SUBMISSION_FEE);

      console.log('=== SIGNAL PARAMS ===');
      console.log('tokenId:', tokenId);
      console.log('signalHash:', signalHash);
      console.log('cid:', cid);
      console.log('symbolIndex:', symbolIndex);
      console.log('intent:', intent);
      console.log('signalType:', signalTypeVal);
      console.log('epochRef:', epochRef);
      console.log('replyTo:', replyToBytes32);
      console.log('fee:', feeWei);
      console.log('stealthMode:', stealthMode);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // STEALTH MODE: Use Relayer API with EIP-712 Typed Signing
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (stealthMode) {
        statusEl.innerHTML = '<div class="status-msg pending">ğŸ”’ Stealth: Preparing signature request...</div>';
        
        try {
          // Step 1: Get the EIP-712 typed data from relayer
          var relayerUrl = API_BASE + '/relay';
          var prepareUrl = relayerUrl + '/signal/prepare/' + tokenId + 
            '?signalHash=' + encodeURIComponent(signalHash) + 
            '&intent=' + intent + 
            '&symbolIndex=' + symbolIndex + 
            '&epochRef=' + epochRef +
            '&replyTo=' + encodeURIComponent(replyToBytes32);
          
          var prepareResponse = await fetch(prepareUrl);
          if (!prepareResponse.ok) {
            var errData = await prepareResponse.json();
            throw new Error(errData.error || 'Failed to prepare stealth signing data');
          }
          var typedData = await prepareResponse.json();
          
          // Step 2: Sign the EIP-712 typed data with user's wallet
          statusEl.innerHTML = '<div class="status-msg pending">ğŸ”’ Sign typed data to authorize anonymous relay...</div>';
          
          // eth_signTypedData_v4 is the standard for EIP-712
          var signature = await provider.request({
            method: 'eth_signTypedData_v4',
            params: [
              currentAccount,
              JSON.stringify({
                types: {
                  EIP712Domain: [
                    { name: 'name', type: 'string' },
                    { name: 'version', type: 'string' },
                    { name: 'chainId', type: 'uint256' },
                    { name: 'verifyingContract', type: 'address' }
                  ],
                  ...typedData.types
                },
                primaryType: typedData.primaryType,
                domain: typedData.domain,
                message: typedData.message
              })
            ]
          });
          
          // Step 3: Submit to relayer
          statusEl.innerHTML = '<div class="status-msg pending">ğŸ”’ Submitting via anonymous relayer...</div>';
          
          var submitResponse = await fetch(relayerUrl + '/signal/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              signature: signature,
              keyId: tokenId,
              signalHash: signalHash,
              intent: intent,
              symbolIndex: symbolIndex,
              epochRef: epochRef,
              replyTo: replyToBytes32,
              deadline: typedData.deadline
            })
          });
          
          var result = await submitResponse.json();
          
          if (result.success) {
            signalsUsed++;
            updateStatusDots();
            statusEl.innerHTML = '<div class="status-msg success">ğŸ”’ Stealth signal relayed!<br><a href="' + EXPLORER + '/tx/' + result.txHash + '" target="_blank">View on Polygonscan</a></div>';
            document.getElementById('signalContent').value = '';
            updateCharCount();
          } else {
            throw new Error(result.error || 'Relay failed');
          }
          
        } catch (stealthErr) {
          console.error('Stealth relay error:', stealthErr);
          var errMsg = stealthErr.message || 'Stealth relay failed';
          if (errMsg.includes('user rejected') || errMsg.includes('User denied')) {
            errMsg = 'Signature request cancelled';
          } else if (errMsg.includes('not available')) {
            errMsg = 'Stealth relayer service not available. Try normal mode.';
          }
          statusEl.innerHTML = '<div class="status-msg error">' + errMsg + '</div>';
        }
        
        return; // Exit early for stealth mode
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // NORMAL MODE: Direct contract call with fee
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      var data;
      var iface = new ethersLib.Interface([
        'function submitSignal(uint256 tokenId, bytes32 signalHash, string cid, uint8 symbolIndex, uint8 intent, uint8 signalType, uint16 epochRef, bytes32 replyTo) payable'
      ]);

      data = iface.encodeFunctionData('submitSignal', [
        tokenId,
        signalHash,
        cid,
        symbolIndex,
        intent,
        signalTypeVal,
        epochRef,
        replyToBytes32
      ]);
      
      statusEl.innerHTML = '<div class="status-msg pending">Confirm in wallet (fee: ' + (selectedIntent === 3 ? '0.015' : '0.01') + ' POL)...</div>';

      console.log('Encoded data:', data);
      console.log('Data length:', data.length, 'chars =', (data.length - 2) / 2, 'bytes');

      // Simulate first
      statusEl.innerHTML = '<div class="status-msg pending">Simulating transaction...</div>';
      
      try {
        await rpcCall('eth_call', [{
          from: currentAccount,
          to: Z1N_SIGNAL,
          value: '0x' + BigInt(feeWei).toString(16),
          data: data
        }, 'latest']);
        console.log('Simulation passed!');
      } catch (simErr) {
        console.error('Simulation failed:', simErr);
        var errMsg = parseContractError(simErr);
        statusEl.innerHTML = '<div class="status-msg error">' + errMsg + '</div>';
        return;
      }

      // Send transaction
      statusEl.innerHTML = '<div class="status-msg pending">Confirm in wallet...</div>';

      var txHash = await provider.request({
        method: 'eth_sendTransaction',
        params: [{
          from: currentAccount,
          to: Z1N_SIGNAL,
          value: '0x' + BigInt(feeWei).toString(16),
          data: data
        }]
      });

      statusEl.innerHTML = '<div class="status-msg pending">Transaction sent: ' + txHash.slice(0, 14) + '...</div>';

      // Poll for receipt
      pollForReceipt(txHash, statusEl, function() {
        signalsUsed++;
        updateStatusDots();
        document.getElementById('signalContent').value = '';
        updateCharCount();
      });

    } catch (e) {
      console.error('Submit error:', e);
      var errMsg = e.message || 'Transaction failed';
      if (errMsg.includes('rejected') || errMsg.includes('denied')) {
        statusEl.innerHTML = '<div class="status-msg error">Transaction rejected by user.</div>';
      } else if (errMsg.includes('Internal JSON-RPC')) {
        statusEl.innerHTML = '<div class="status-msg error">Wallet error - try refreshing the page or reconnecting your wallet.</div>';
      } else {
        statusEl.innerHTML = '<div class="status-msg error">' + errMsg.slice(0, 150) + '</div>';
      }
    }
  };

  function parseContractError(err) {
    var errStr = String(err.message || err);
    
    if (errStr.includes('NotTokenOwner') || errStr.includes('NotKeyOwner')) {
      return 'You do not own this Key with the connected wallet.';
    } else if (errStr.includes('MaxSignalsPerEpochReached')) {
      return 'Maximum 2 PoG signals already sent this epoch.';
    } else if (errStr.includes('InsufficientFee')) {
      return 'Insufficient fee - need 0.01 POL (0.015 for Silence).';
    } else if (errStr.includes('InvalidReplyTarget')) {
      return 'Invalid reply target - signal hash not found.';
    } else if (errStr.includes('epochRef without replyTo')) {
      return 'epochRef must be 0 for new signals.';
    } else if (errStr.includes('ReplyTo needs epochRef')) {
      return 'Reply signals require epochRef > 0.';
    } else if (errStr.includes('CID too long')) {
      return 'Signal content too long (max 256 chars).';
    } else if (errStr.includes('Invalid symbolIndex')) {
      return 'Invalid symbol index (must be 0-20).';
    } else if (errStr.includes('Invalid intent')) {
      return 'Invalid intent (must be 0-3).';
    } else if (errStr.includes('Invalid signalType')) {
      return 'Invalid signal type (must be 0-3).';
    }
    return errStr.slice(0, 200);
  }

  function pollForReceipt(txHash, statusEl, onSuccess) {
    var attempts = 0;
    var poll = setInterval(async function() {
      attempts++;
      if (attempts > 60) {
        clearInterval(poll);
        statusEl.innerHTML = '<div class="status-msg pending">Taking long... <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank" style="color:var(--keys-accent)">View on explorer</a></div>';
        return;
      }

      try {
        var receipt = await provider.request({
          method: 'eth_getTransactionReceipt',
          params: [txHash]
        });

        if (receipt) {
          clearInterval(poll);
          if (receipt.status === '0x1') {
            statusEl.innerHTML = '<div class="status-msg success">âœ… Signal submitted to the Field! <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank" style="color:var(--accent)">View tx</a></div>';
            if (onSuccess) onSuccess();
          } else {
            statusEl.innerHTML = '<div class="status-msg error">Transaction failed. <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank" style="color:var(--keys-accent)">View on explorer</a></div>';
          }
        }
      } catch (e) {}
    }, 2000);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLICKABLE STATS NAVIGATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.focusSignalContent = function() {
    var textarea = document.getElementById('signalContent');
    if (textarea) {
      textarea.focus();
      textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  window.goToAttests = function() {
    // Navigate to attests page with current key and wallet
    var url = '/attests.html?key=' + currentKeyId;
    if (currentAccount) {
      url += '&wallet=' + encodeURIComponent(currentAccount);
    }
    window.location.href = url;
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDATE RECIPIENT KEY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var recipientKeyValid = true;
  var validateTimeout = null;
  
  window.debounceValidateRecipient = function() {
    clearTimeout(validateTimeout);
    validateTimeout = setTimeout(validateRecipientKey, 500);
  };
  
  window.validateRecipientKey = async function() {
    var input = document.getElementById('pureRecipient');
    var errorEl = document.getElementById('recipientError');
    var submitBtn = document.getElementById('btnSubmitPure');
    var keyId = parseInt(input.value, 10);
    
    // 0 is always valid (broadcast)
    if (isNaN(keyId) || keyId === 0) {
      errorEl.style.display = 'none';
      input.style.borderColor = '';
      recipientKeyValid = true;
      return;
    }
    
    try {
      // Check if key exists by calling ownerOf
      var data = SEL.ownerOf + encodeUint256(keyId);
      var result = await rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest']);
      
      // If we get a result with an address (not all zeros), key exists
      if (result && result !== '0x' && result !== '0x0000000000000000000000000000000000000000000000000000000000000000') {
        errorEl.style.display = 'none';
        input.style.borderColor = 'rgba(74, 222, 128, 0.5)';
        recipientKeyValid = true;
      } else {
        throw new Error('Key does not exist');
      }
    } catch (e) {
      // Key doesn't exist
      errorEl.style.display = 'block';
      input.style.borderColor = '#f87171';
      recipientKeyValid = false;
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SUBMIT PURE SIGNAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.submitPureSignal = async function() {
    var statusEl = document.getElementById('pureStatus');
    var content = document.getElementById('pureContent').value.trim();
    var recipientInput = document.getElementById('pureRecipient').value.trim();
    
    // Default recipient to 0 (broadcast)
    var toKeyId = 0;
    if (recipientInput && recipientInput !== '') {
      toKeyId = parseInt(recipientInput, 10);
      if (isNaN(toKeyId) || toKeyId < 0) {
        statusEl.innerHTML = '<div class="status-msg error">Invalid recipient Key ID. Use 0 for broadcast.</div>';
        return;
      }
    }
    
    // Validate recipient key exists (if not 0)
    if (toKeyId !== 0) {
      await validateRecipientKey();
      if (!recipientKeyValid) {
        statusEl.innerHTML = '<div class="status-msg error">Recipient Key ID does not exist.</div>';
        return;
      }
    }

    if (!content) {
      statusEl.innerHTML = '<div class="status-msg error">Please enter a message.</div>';
      return;
    }
    
    if (content.length > 500) {
      statusEl.innerHTML = '<div class="status-msg error">Message too long. Maximum 500 characters.</div>';
      return;
    }

    if (!currentAccount || !currentKeyId) {
      statusEl.innerHTML = '<div class="status-msg error">Wallet not connected or no key selected.</div>';
      return;
    }

    statusEl.innerHTML = '<div class="status-msg pending">Preparing whisper...</div>';

    try {
      // Verify we're on the right chain
      var chainId = await provider.request({ method: 'eth_chainId' });
      if (chainId !== CHAIN_ID) {
        statusEl.innerHTML = '<div class="status-msg error">Wrong network. Please switch to Polygon Amoy.</div>';
        return;
      }
      
      // Load ethers if not already loaded
      await loadEthers();
      
      // Encode sendPure(uint256 fromKeyId, uint256 toKeyId, string cid)
      var iface = new ethersLib.Interface([
        'function sendPure(uint256 fromKeyId, uint256 toKeyId, string cid)'
      ]);
      
      var data = iface.encodeFunctionData('sendPure', [
        currentKeyId,  // fromKeyId
        toKeyId,       // toKeyId (0 = broadcast)
        content        // cid (message content)
      ]);
      
      console.log('Pure Signal params:', {
        fromKeyId: currentKeyId,
        toKeyId: toKeyId,
        cid: content.slice(0, 50) + '...'
      });
      
      statusEl.innerHTML = '<div class="status-msg pending">Confirm in wallet... (no fee)</div>';
      
      // Send transaction (no value - Pure signals are free!)
      var txHash = await provider.request({
        method: 'eth_sendTransaction',
        params: [{
          from: currentAccount,
          to: Z1N_SIGNAL,
          data: data,
          gas: '0x30D40' // 200000 gas limit
        }]
      });
      
      console.log('Pure Signal TX:', txHash);
      statusEl.innerHTML = '<div class="status-msg pending">Whisper sent! Waiting for confirmation...<br><a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank" style="color:var(--accent);">View on Polygonscan</a></div>';
      
      // Poll for receipt
      pollForPureReceipt(txHash, statusEl);
      
    } catch (err) {
      console.error('Pure Signal error:', err);
      console.error('Error details:', JSON.stringify(err, null, 2));
      var errorMsg = parsePureError(err);
      statusEl.innerHTML = '<div class="status-msg error">' + errorMsg + '</div>';
    }
  };
  
  function parsePureError(err) {
    var msg = err.message || err.toString();
    
    if (msg.includes('user rejected') || msg.includes('User denied')) {
      return 'Transaction cancelled.';
    }
    if (msg.includes('NotTokenOwner') || msg.includes('not the owner')) {
      return 'You do not own this Key.';
    }
    if (msg.includes('InvalidRecipient') || msg.includes('ERC721NonexistentToken')) {
      return 'Recipient Key ID does not exist.';
    }
    if (msg.includes('execution reverted')) {
      // Try to extract the reason
      var reason = msg.match(/reason="([^"]+)"/);
      if (reason) return 'Contract error: ' + reason[1];
      return 'Transaction reverted - check Key ownership and recipient.';
    }
    if (msg.includes('Internal JSON-RPC error')) {
      return 'Transaction failed - the recipient Key may not exist or you may not own the sending Key.';
    }
    
    // Generic error
    return 'Whisper failed: ' + msg.slice(0, 100);
  }
  
  function pollForPureReceipt(txHash, statusEl) {
    var attempts = 0;
    var maxAttempts = 60;
    
    var interval = setInterval(async function() {
      attempts++;
      
      try {
        var receipt = await rpcCall('eth_getTransactionReceipt', [txHash]);
        
        if (receipt) {
          clearInterval(interval);
          
          if (receipt.status === '0x1') {
            statusEl.innerHTML = '<div class="status-msg success">âœ“ Whisper delivered!<br><a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank" style="color:var(--accent);">View on Polygonscan</a></div>';
            
            // Clear form
            document.getElementById('pureContent').value = '';
            document.getElementById('pureRecipient').value = '';
            document.getElementById('pureCharCount').textContent = '0 / 500';
            
          } else {
            statusEl.innerHTML = '<div class="status-msg error">Transaction failed. <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank">View details</a></div>';
          }
        }
      } catch (e) {
        console.log('Poll error:', e);
      }
      
      if (attempts >= maxAttempts) {
        clearInterval(interval);
        statusEl.innerHTML = '<div class="status-msg pending">Taking longer than expected...<br><a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank" style="color:var(--accent);">Check status on Polygonscan</a></div>';
      }
    }, 2000);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONNECT WALLET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function connectWallet() {
    var eth = getProvider();
    if (!eth) {
      alert('Please install a Web3 wallet (e.g. MetaMask, Rabby, Coinbase Wallet)');
      return;
    }

    provider = eth;

    try {
      var accounts = await provider.request({ method: 'eth_accounts' });
      if (!accounts || accounts.length === 0) {
        accounts = await provider.request({ method: 'eth_requestAccounts' });
      }
      
      // Check if wallet was specified in URL (from Your Keys page)
      var walletParam = getUrlParam('wallet');
      if (walletParam) {
        // Verify the specified wallet is in the connected accounts
        var walletLower = walletParam.toLowerCase();
        var found = accounts.find(function(a) { return a.toLowerCase() === walletLower; });
        if (found) {
          currentAccount = found;
        } else {
          // Wallet from URL not connected - show error
          alert('The wallet ' + walletParam.slice(0,6) + '...' + walletParam.slice(-4) + ' is not connected. Please connect it in your wallet app or go back to Your Keys.');
          currentAccount = accounts[0];
        }
      } else {
        // No wallet specified, use first account
        currentAccount = accounts[0];
      }

      var chainId = await provider.request({ method: 'eth_chainId' });
      if (chainId !== CHAIN_ID) {
        try {
          await provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CHAIN_ID }]
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await provider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: CHAIN_ID,
                chainName: 'Polygon Amoy Testnet',
                nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                rpcUrls: ['https://rpc-amoy.polygon.technology'],
                blockExplorerUrls: ['https://amoy.polygonscan.com']
              }]
            });
          }
        }
      }

      var keyIdParam = getUrlParam('key');
      if (keyIdParam) {
        currentKeyId = parseInt(keyIdParam);
      } else {
        var balanceData = SEL.balanceOf + encodeAddress(currentAccount);
        var balanceResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: balanceData }, 'latest']);
        var balance = parseInt(balanceResult, 16);

        if (balance === 0) {
          alert('This wallet has no Z1N Keys. Please mint a key first.');
          window.location.href = '/mint-key.html';
          return;
        }

        var tokenData = SEL.tokenOfOwnerByIndex + encodeAddress(currentAccount) + encodeUint256(0);
        var tokenResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: tokenData }, 'latest']);
        currentKeyId = parseInt(tokenResult, 16);
      }

      document.getElementById('connectState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // Show which wallet is active
      var walletDisplay = document.getElementById('activeWalletDisplay');
      if (walletDisplay) {
        walletDisplay.textContent = currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
      }
      
      // Update back link to preserve wallet selection
      var backLink = document.getElementById('backLink');
      if (backLink) {
        backLink.href = '/your-keys.html?wallet=' + encodeURIComponent(currentAccount);
      }

      await loadKeyData(currentKeyId);
      
      // Check stealth mode for this key
      stealthMode = isStealthEnabled(currentKeyId);
      var stealthBadge = document.getElementById('stealthBadge');
      if (stealthBadge) {
        stealthBadge.style.display = stealthMode ? 'inline' : 'none';
      }
      
      // Update fee display if stealth mode (like Pure Signal style)
      if (stealthMode) {
        var feeDisplay = document.querySelector('.pog-card .fee-display');
        if (feeDisplay) {
          feeDisplay.innerHTML = '<span>Protocol Fee: <span class="fee-amount free" style="cursor:help;" title="Paid by Nexus Epoch">Free</span></span><span style="font-size:10px; color:var(--text-soft); margin-left:8px;">(gas only)</span>';
        }
      }

    } catch (e) {
      console.error('Connect error:', e);
      alert('Connection failed: ' + e.message);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // REPLY MODAL FUNCTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var modalSignals = [];
  var modalOffset = 0;
  var modalLimit = 20;
  var modalTotal = 0;
  var selectedSignal = null;
  var modalHasMore = false;
  var filterDebounceTimer = null;

  // Debounced filter - waits 300ms after typing stops, then auto-refreshes
  window.debouncedFilter = function() {
    clearTimeout(filterDebounceTimer);
    // Show loading indicator immediately
    var countInfo = document.getElementById('signalCountInfo');
    if (countInfo) countInfo.textContent = 'Filtering...';
    
    filterDebounceTimer = setTimeout(function() {
      console.log('Auto-refresh triggered by filter change');
      applyFilters();
    }, 300);
  };
  
  // Immediate filter (no debounce) - for select dropdowns
  window.immediateFilter = function() {
    clearTimeout(filterDebounceTimer);
    console.log('Immediate filter triggered');
    applyFilters();
  };

  window.openReplyModal = function() {
    document.getElementById('replyModal').classList.add('active');
    // Auto-load signals when modal opens
    loadSignalsForModal();
  };

  window.closeReplyModal = function() {
    document.getElementById('replyModal').classList.remove('active');
  };

  window.resetFilters = function() {
    document.getElementById('filterKeyId').value = '';
    document.getElementById('filterEpochFrom').value = '';
    document.getElementById('filterEpochTo').value = '';
    document.getElementById('filterSort').value = 'recent';
    modalOffset = 0;
    selectedSignal = null;
    updateSelectedInfo();
    loadSignalsForModal();
  };

  window.applyFilters = function() {
    console.log('applyFilters called');
    modalOffset = 0;
    selectedSignal = null;
    
    // Clear current list and show loading
    var listEl = document.getElementById('signalsList');
    var loadingEl = document.getElementById('signalsLoading');
    var noSignalsEl = document.getElementById('noSignals');
    
    listEl.innerHTML = '';
    loadingEl.style.display = 'block';
    noSignalsEl.style.display = 'none';
    
    updateSelectedInfo();
    loadSignalsForModal();
  };

  async function loadSignalsForModal(append) {
    var listEl = document.getElementById('signalsList');
    var loadingEl = document.getElementById('signalsLoading');
    var noSignalsEl = document.getElementById('noSignals');
    var loadMoreBtn = document.getElementById('loadMoreBtn');
    var countInfo = document.getElementById('signalCountInfo');
    
    if (!append) {
      listEl.innerHTML = '';
      loadingEl.style.display = 'block';
      noSignalsEl.style.display = 'none';
      loadMoreBtn.style.display = 'none';
      if (countInfo) countInfo.textContent = 'Loading...';
    }
    
    try {
      // Build query params
      var params = new URLSearchParams();
      params.append('limit', modalLimit);
      params.append('offset', modalOffset);
      // REMOVED: excludeSilence - now show ALL signals including silence
      // params.append('excludeSilence', 'true');
      
      var keyIdFilter = document.getElementById('filterKeyId').value.trim();
      if (keyIdFilter) {
        params.append('keyId', keyIdFilter);
      }
      
      // Epoch range filters
      var epochFrom = document.getElementById('filterEpochFrom').value.trim();
      var epochTo = document.getElementById('filterEpochTo').value.trim();
      
      if (epochFrom && epochTo) {
        // Both specified - use minEpoch and maxEpoch
        params.append('minEpoch', epochFrom);
        params.append('maxEpoch', epochTo);
      } else if (epochFrom) {
        // Only from - signals from this epoch onwards
        params.append('minEpoch', epochFrom);
      } else if (epochTo) {
        // Only to - signals up to this epoch
        params.append('maxEpoch', epochTo);
      }
      // No epoch filter = all epochs
      
      var sortFilter = document.getElementById('filterSort').value;
      params.append('sort', sortFilter);
      
      console.log('Fetching signals:', API_BASE + '/signals?' + params.toString());
      var response = await fetch(API_BASE + '/signals?' + params.toString());
      
      if (!response.ok) {
        throw new Error('Failed to load signals: ' + response.status);
      }
      
      var data = await response.json();
      console.log('Signals response:', data);
      
      loadingEl.style.display = 'none';
      
      // Update count
      modalTotal = data.total || 0;
      if (countInfo) {
        countInfo.textContent = modalTotal + ' signals found';
      }
      
      // Check if key exists (for unminted keys)
      if (keyIdFilter && data.keyExists === false) {
        noSignalsEl.innerHTML = '<span style="color:#f87171;">âš ï¸ Key #' + keyIdFilter + ' does not exist.</span><br><span style="font-size:12px; color:var(--text-soft);">This key has not been minted yet.</span>';
        noSignalsEl.style.display = 'block';
        loadMoreBtn.style.display = 'none';
        return;
      }
      
      if (data.signals.length === 0 && !append) {
        var msg = '';
        if (keyIdFilter && data.keyInfo) {
          msg = 'Key #' + keyIdFilter + ' (' + (data.keyInfo.glyphs || '?') + ') has not sent any signals yet.';
        } else if (keyIdFilter) {
          msg = 'No signals found for Key #' + keyIdFilter + '.';
        } else {
          msg = 'No signals found matching your filters.';
        }
        noSignalsEl.textContent = msg;
        noSignalsEl.style.display = 'block';
        loadMoreBtn.style.display = 'none';
        return;
      }
      
      modalSignals = append ? modalSignals.concat(data.signals) : data.signals;
      modalHasMore = data.hasMore;
      
      renderSignalsList(data.signals, append);
      
      loadMoreBtn.style.display = data.hasMore ? 'block' : 'none';
      
    } catch (err) {
      console.error('Load signals error:', err);
      loadingEl.style.display = 'none';
      noSignalsEl.textContent = 'Error loading signals. Make sure the API server is running.';
      noSignalsEl.style.display = 'block';
      if (countInfo) countInfo.textContent = 'Error';
    }
  }

  function renderSignalsList(signals, append) {
    var listEl = document.getElementById('signalsList');
    
    signals.forEach(function(sig) {
      var card = document.createElement('div');
      card.className = 'signal-card';
      card.dataset.hash = sig.hash;
      
      var intentClass = sig.intentSymbol.toLowerCase().replace('Ï‰', 'o');
      var contentClass = sig.intent === 3 ? 'silence' : '';
      
      // Show full CID content, not truncated "Signal ipfs://..."
      var contentText = sig.cid || sig.content || '[No content]';
      if (sig.intent === 3) contentText = '[Silence - no content]';
      var isLong = contentText.length > 100;
      
      // Glyphs display
      var glyphsDisplay = sig.keyGlyphs ? '<span class="signal-key-glyphs">' + sig.keyGlyphs + '</span>' : '';
      
      card.innerHTML = 
        '<div class="signal-header">' +
          '<div class="signal-meta">' +
            '<span class="signal-key">K#' + sig.keyId + '</span>' +
            glyphsDisplay +
            '<span class="signal-intent ' + intentClass + '">' + sig.intentSymbol + '</span>' +
            '<span class="signal-epoch" title="Epoch ' + sig.epoch + '">Epoch ' + sig.epoch + '</span>' +
            '<span class="signal-attests" style="color:#fbbf24;" title="' + (sig.attestCount || 0) + ' attestations">âœ“' + (sig.attestCount || 0) + '</span>' +
          '</div>' +
          '<span class="signal-time">' + sig.timeAgo + '</span>' +
        '</div>' +
        '<div class="signal-content ' + contentClass + (isLong ? '' : ' short') + '" onclick="toggleSignalContent(event)">' + 
          escapeHtml(contentText) + 
        '</div>' +
        (isLong ? '<div class="expand-hint">Click to expand</div>' : '') +
        '<div class="signal-stats">' +
          '<span class="signal-hash" style="font-family:monospace; font-size:10px;">' + sig.hash.slice(0, 18) + '...</span>' +
        '</div>';
      
      // Select on click (but not on content expand)
      card.addEventListener('click', function(e) {
        if (!e.target.classList.contains('signal-content')) {
          selectSignalCard(sig);
        }
      });
      
      listEl.appendChild(card);
    });
  }

  window.toggleSignalContent = function(e) {
    e.stopPropagation();
    var content = e.target;
    content.classList.toggle('expanded');
    
    // Update hint
    var hint = content.nextElementSibling;
    if (hint && hint.classList.contains('expand-hint')) {
      hint.textContent = content.classList.contains('expanded') ? 'Click to collapse' : 'Click to expand';
    }
  };

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function selectSignalCard(sig) {
    // Deselect previous
    document.querySelectorAll('.signal-card.selected').forEach(function(el) {
      el.classList.remove('selected');
    });
    
    // Select new
    var card = document.querySelector('.signal-card[data-hash="' + sig.hash + '"]');
    if (card) {
      card.classList.add('selected');
    }
    
    selectedSignal = sig;
    updateSelectedInfo();
  }

  function updateSelectedInfo() {
    var infoEl = document.getElementById('selectedInfo');
    var btnEl = document.getElementById('btnConfirmSelect');
    var countInfo = document.getElementById('signalCountInfo');
    
    if (selectedSignal) {
      infoEl.innerHTML = 'Selected: <span style="color:var(--keys-accent);">K#' + selectedSignal.keyId + '</span> Â· ' + 
                         selectedSignal.intentSymbol + ' Â· E' + selectedSignal.epoch;
      btnEl.disabled = false;
    } else {
      infoEl.innerHTML = '<span id="signalCountInfo" style="font-size:11px; color:var(--text-soft);">' + modalTotal + ' signals</span>';
      btnEl.disabled = true;
    }
  }

  window.loadMoreSignals = function() {
    modalOffset += modalLimit;
    loadSignalsForModal(true);
  };

  // CSV Download - ALL signals with Glyphs column
  window.downloadSignalsCSV = async function() {
    var btn = event.target;
    var originalText = btn.textContent;
    btn.textContent = 'â³ Loading...';
    btn.disabled = true;
    
    try {
      // Fetch ALL signals with current filters (up to 10000)
      var params = new URLSearchParams();
      params.append('limit', '10000');  // Request max
      params.append('offset', '0');
      // Include all signals (no excludeSilence)
      
      var keyIdFilter = document.getElementById('filterKeyId').value.trim();
      if (keyIdFilter) params.append('keyId', keyIdFilter);
      
      var epochFrom = document.getElementById('filterEpochFrom').value.trim();
      var epochTo = document.getElementById('filterEpochTo').value.trim();
      if (epochFrom) params.append('minEpoch', epochFrom);
      if (epochTo) params.append('maxEpoch', epochTo);
      
      params.append('sort', document.getElementById('filterSort').value);
      
      var url = API_BASE + '/signals?' + params.toString();
      console.log('CSV fetch URL:', url);
      
      btn.textContent = 'â³ Fetching...';
      var response = await fetch(url);
      
      if (!response.ok) {
        throw new Error('Server error: ' + response.status);
      }
      
      var data = await response.json();
      
      console.log('CSV response:', {
        total: data.total,
        returned: data.signals?.length,
        hasMore: data.hasMore
      });
      
      if (!data.signals || data.signals.length === 0) {
        alert('No signals to download');
        return;
      }
      
      btn.textContent = 'â³ Building CSV...';
      
      // Build CSV with UTF-8 BOM for proper encoding of Î© symbols
      var BOM = '\uFEFF';
      var csv = BOM + 'Hash,KeyID,Glyphs,Epoch,Intent,Attestations,CID,TimeAgo\n';
      
      data.signals.forEach(function(s) {
        // Escape quotes in CID
        var cidEscaped = (s.cid || '').replace(/"/g, '""');
        var glyphsEscaped = (s.keyGlyphs || '').replace(/"/g, '""');
        
        csv += '"' + s.hash + '",' + 
               s.keyId + ',' + 
               '"' + glyphsEscaped + '",' + 
               s.epoch + ',' + 
               '"' + s.intentSymbol + '",' + 
               (s.attestCount || 0) + ',' + 
               '"' + cidEscaped + '",' + 
               '"' + s.timeAgo + '"\n';
      });
      
      // Download with UTF-8 charset
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      var downloadUrl = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = downloadUrl;
      a.download = 'z1n_signals_' + new Date().toISOString().slice(0,10) + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(downloadUrl);
      
      // Show result
      var msg = 'âœ… Downloaded ' + data.signals.length + ' signals';
      if (data.total > data.signals.length) {
        msg += ' (out of ' + data.total + ' total - run indexer to sync all)';
      }
      alert(msg);
      
    } catch (err) {
      console.error('CSV download error:', err);
      alert('Failed to download CSV: ' + err.message);
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  };

  window.confirmSignalSelection = function() {
    if (!selectedSignal) return;
    
    // Set the hash in the input
    document.getElementById('replyToHash').value = selectedSignal.hash;
    
    // Show preview
    var previewEl = document.getElementById('selectedSignalPreview');
    var metaEl = document.getElementById('previewMeta');
    var contentEl = document.getElementById('previewContent');
    
    metaEl.innerHTML = '<span style="color:var(--keys-accent);">K#' + selectedSignal.keyId + '</span> Â· ' + 
                       '<span>' + selectedSignal.intentSymbol + '</span> Â· ' +
                       'Epoch ' + selectedSignal.epoch;
    
    var previewText = selectedSignal.content || selectedSignal.cid || '[Signal]';
    if (previewText.length > 100) {
      previewText = previewText.slice(0, 100) + '...';
    }
    contentEl.textContent = previewText;
    
    previewEl.style.display = 'block';
    
    // Close modal
    closeReplyModal();
  };

  window.clearReplySelection = function() {
    document.getElementById('replyToHash').value = '';
    document.getElementById('selectedSignalPreview').style.display = 'none';
    selectedSignal = null;
  };

  // Close modal on overlay click
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
      closeReplyModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeReplyModal();
    }
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.getElementById('btnConnect').onclick = connectWallet;

  var eth = getProvider();
  if (eth) {
    eth.request({ method: 'eth_accounts' }).then(function(accounts) {
      if (accounts.length > 0) {
        connectWallet();
      }
    }).catch(function(e) {
      console.log('Auto-connect check failed:', e);
    });
  }

})();
</script>

</body>
</html>
