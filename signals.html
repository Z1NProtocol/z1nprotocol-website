<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Z1N Protocol – Signals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #050812;
      --card-bg: #020617;
      --text-main: #ffffff;
      --text-soft: #8f9ab5;
      --accent: #66d69a;
      --accent-soft: #3a9f63;
      --keys-accent: #f5c842;
      --keys-accent-soft: #d4a012;
      --card-border: rgba(148, 163, 184, 0.25);
      --border-soft: rgba(148,163,184,0.35);
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    /* HEADER */
    header {
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 20px;
    }

    .nav-inner {
      width: 100%;
      max-width: 1200px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-link { display: inline-flex; align-items: center; gap: 8px; }

    .logo-dot {
      width: 24px; height: 24px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.35);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }

    .logo-text {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .nav-links {
      display: flex;
      gap: 22px;
      font-size: 13px;
      opacity: 0.85;
    }

    .nav-links a.active { color: var(--keys-accent); }

    /* MAIN */
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px 80px;
    }

    h1 {
      font-size: 40px;
      margin-bottom: 8px;
      color: var(--keys-accent);
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 15px;
      color: var(--text-soft);
      margin-bottom: 24px;
      max-width: 900px;
    }

    /* KEY HEADER CARD */
    .key-header-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .key-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .key-id {
      font-size: 20px;
      font-weight: 600;
    }

    .key-glyphs {
      font-size: 16px;
      font-family: "Segoe UI Symbol", "Apple Symbols", sans-serif;
    }

    .key-stats {
      display: flex;
      gap: 20px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .stat-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-label { margin-right: 4px; }

    .stat-dots {
      display: flex;
      gap: 4px;
    }

    .dot-filled { color: #4ade80; font-size: 14px; }
    .dot-open { color: var(--keys-accent); font-size: 14px; }

    /* TWO COLUMN LAYOUT */
    .signals-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 800px) {
      .signals-layout { grid-template-columns: 1fr; }
    }

    /* CARDS */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-soft);
      margin-bottom: 16px;
    }

    /* POG card title in gold */
    .pog-card .card-title {
      color: var(--keys-accent);
    }

    /* Pure card - white styling */
    .pure-card {
      border-color: var(--border-soft);
    }

    .pure-card .card-title {
      color: var(--text-main);
    }

    /* SIGNAL TYPE TOGGLE */
    .toggle-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 16px;
    }

    .toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(245, 200, 66, 0.35);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn:hover {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.1);
    }

    .toggle-btn.active {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.2);
      color: var(--keys-accent);
    }

    /* INTENT GRID */
    .intent-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 16px;
    }

    .intent-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 6px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(245, 200, 66, 0.35);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .intent-btn:hover {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.1);
    }

    .intent-btn.selected {
      border-color: var(--keys-accent);
      background: rgba(245, 200, 66, 0.2);
    }

    .intent-symbol {
      font-size: 13px;
      font-weight: 700;
    }

    .intent-name {
      font-size: 9px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .intent-btn[data-intent="0"] .intent-symbol { color: #4ade80; }
    .intent-btn[data-intent="1"] .intent-symbol { color: #f87171; }
    .intent-btn[data-intent="2"] .intent-symbol { color: #fbbf24; }
    .intent-btn[data-intent="3"] .intent-symbol { color: #60a5fa; }

    /* TEXT INPUT */
    .input-group {
      margin-bottom: 12px;
    }

    .input-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }

    .char-count { color: var(--keys-accent); }

    textarea, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    textarea:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--keys-accent);
    }

    textarea::placeholder, input::placeholder {
      color: var(--text-soft);
      opacity: 0.6;
    }

    /* Pure card inputs - white border on focus */
    .pure-card textarea:focus, .pure-card input[type="text"]:focus {
      border-color: var(--text-main);
    }

    /* CARD SPACER - pushes footer to bottom */
    .card-spacer {
      flex: 1;
    }

    /* SUBMIT ROW - at bottom of card */
    .submit-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 14px;
    }

    .fee-display {
      font-size: 12px;
      color: var(--text-soft);
    }

    .fee-amount {
      color: var(--keys-accent);
      font-weight: 600;
    }

    .fee-amount.free {
      color: var(--accent);
    }

    /* POG Submit button - gold */
    .btn-submit {
      padding: 10px 24px;
      border-radius: 999px;
      border: 1px solid var(--keys-accent-soft);
      background: linear-gradient(90deg, rgba(245,200,66,0.55), rgba(212,160,18,0.55));
      color: #061018;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-submit:hover:not([disabled]) {
      transform: translateY(-1px);
      background: linear-gradient(90deg, var(--keys-accent), var(--keys-accent-soft));
      box-shadow: 0 6px 16px rgba(0,0,0,0.3), 0 0 12px rgba(245,200,66,0.15);
    }

    .btn-submit[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Pure Submit button - mode-btn style from about.html */
    .btn-whisper {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 24px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease, background 180ms ease, color 180ms ease;
    }

    .btn-whisper:hover:not([disabled]) {
      border-color: var(--accent);
    }

    .btn-whisper[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* STATUS */
    .status-msg {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 10px;
    }

    .status-msg.error {
      background: rgba(249, 115, 115, 0.1);
      border: 1px solid rgba(249, 115, 115, 0.3);
      color: var(--danger);
    }

    .status-msg.success {
      background: rgba(102, 214, 154, 0.1);
      border: 1px solid rgba(102, 214, 154, 0.3);
      color: var(--accent);
    }

    .status-msg.pending {
      background: rgba(245, 200, 66, 0.1);
      border: 1px solid rgba(245, 200, 66, 0.3);
      color: var(--keys-accent);
    }

    /* CONNECT STATE */
    .connect-prompt {
      text-align: center;
      padding: 60px 20px;
    }

    .connect-prompt p {
      color: var(--text-soft);
      margin-bottom: 20px;
    }

    .btn-connect {
      padding: 12px 28px;
      border-radius: 999px;
      border: 1px solid var(--keys-accent);
      background: transparent;
      color: var(--keys-accent);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-connect:hover {
      background: rgba(245, 200, 66, 0.1);
    }

    /* BACK LINK */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
      font-size: 13px;
      margin-bottom: 20px;
      transition: color 0.2s;
    }

    .back-link:hover { color: var(--keys-accent); }

    /* LINK TO ATTESTS */
    .attests-link {
      text-align: center;
      margin-top: 24px;
    }

    .attests-link a {
      color: var(--keys-accent);
      font-size: 13px;
    }

    .attests-link a:hover {
      text-decoration: underline;
    }

    /* REPLY TO SECTION */
    .reply-section {
      display: none;
      margin-bottom: 12px;
      padding: 10px 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--card-border);
      border-radius: 8px;
    }

    .reply-section.active {
      display: block;
    }

    .reply-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .reply-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-family: monospace;
      font-size: 12px;
    }

    .reply-input:focus {
      outline: none;
      border-color: var(--keys-accent);
    }

    /* RESPONSIVE */
    @media (max-width: 600px) {
      .intent-grid { grid-template-columns: repeat(2, 1fr); }
      .key-header-card { flex-direction: column; align-items: flex-start; }
      .key-stats { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<header>
  <div class="nav-inner">
    <a href="/index.html" class="logo-link">
      <div class="logo-dot">Ω</div>
      <div class="logo-text">Z1N Protocol</div>
    </a>
    <nav class="nav-links">
      <a href="/about.html">About</a>
      <a href="/live-stats.html">Live Stats</a>
      <a href="/mint-key.html">Mint Key</a>
      <a href="/your-keys.html">Your Keys</a>
      <a href="/signals.html" class="active">Signals</a>
    </nav>
  </div>
</header>

<main class="page">
  <a href="/your-keys.html" class="back-link">← Back to Your Keys</a>

  <h1>Signals</h1>
  <p class="subtitle">Participate in the Field's collective intelligence through Proof of Glyph signals.</p>

  <!-- CONNECT STATE -->
  <div id="connectState" class="connect-prompt">
    <p>Connect your wallet to send signals</p>
    <button class="btn-connect" id="btnConnect">Connect Wallet</button>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent" style="display:none;">

    <!-- KEY HEADER -->
    <div class="key-header-card">
      <div class="key-info">
        <span class="key-id" id="keyIdDisplay">Key #—</span>
        <span class="key-glyphs" id="keyGlyphs">—</span>
      </div>
      <div class="key-stats">
        <div class="stat-group">
          <span class="stat-label">Signals:</span>
          <div class="stat-dots" id="signalDots">
            <span class="dot-open">○</span>
            <span class="dot-open">○</span>
          </div>
        </div>
        <div class="stat-group">
          <span class="stat-label">Attests:</span>
          <div class="stat-dots" id="attestDots">
            <span class="dot-open">○</span>
            <span class="dot-open">○</span>
          </div>
        </div>
      </div>
    </div>

    <!-- TWO COLUMN LAYOUT -->
    <div class="signals-layout">

      <!-- POG SIGNAL CARD -->
      <div class="card pog-card">
        <div class="card-title">⚡ PoG Signal</div>

        <!-- Signal Type Toggle -->
        <div class="toggle-grid">
          <button class="toggle-btn active" data-type="new" onclick="setSignalType('new')">New Signal</button>
          <button class="toggle-btn" data-type="reply" onclick="setSignalType('reply')">Reply To</button>
        </div>

        <!-- Reply To Section (hidden by default) -->
        <div class="reply-section" id="replySection">
          <div class="reply-label">Signal Hash to reply to:</div>
          <input type="text" class="reply-input" id="replyToHash" placeholder="0x...">
        </div>

        <!-- Intent Selector -->
        <div class="input-label">Intent</div>
        <div class="intent-grid">
          <div class="intent-btn selected" data-intent="0" onclick="selectIntent(0)" title="Collective consciousness - What are we becoming together?">
            <div class="intent-symbol">ΩC</div>
            <div class="intent-name">Collective</div>
          </div>
          <div class="intent-btn" data-intent="1" onclick="selectIntent(1)" title="Individual expression - Who am I, uniquely?">
            <div class="intent-symbol">ΩI</div>
            <div class="intent-name">Individual</div>
          </div>
          <div class="intent-btn" data-intent="2" onclick="selectIntent(2)" title="Co-creation - How shall we build further?">
            <div class="intent-symbol">ΩK</div>
            <div class="intent-name">Co-Create</div>
          </div>
          <div class="intent-btn" data-intent="3" onclick="selectIntent(3)" title="Silence - The heaviest breath (1.5× fee, 1.1× weight)">
            <div class="intent-symbol">ΩS</div>
            <div class="intent-name">Silence</div>
          </div>
        </div>

        <!-- Content Input -->
        <div class="input-group">
          <div class="input-label">
            <span>Signal Content</span>
            <span class="char-count" id="charCount">0 / 280</span>
          </div>
          <textarea id="signalContent" placeholder="Your signal to the Field..." maxlength="280" oninput="updateCharCount()"></textarea>
        </div>

        <!-- Spacer -->
        <div class="card-spacer"></div>

        <!-- Submit -->
        <div class="submit-row">
          <div class="fee-display">
            Fee: <span class="fee-amount" id="pogFee">0.01 POL</span>
          </div>
          <button class="btn-submit" id="btnSubmitPog" onclick="submitPoGSignal()">Submit Signal</button>
        </div>

        <div id="pogStatus"></div>
      </div>

      <!-- PURE SIGNAL CARD -->
      <div class="card pure-card">
        <div class="card-title">● Pure Signal</div>
        <p style="font-size:12px;color:var(--text-soft);margin-bottom:14px;">
          No fee, no attestation, no game impact. Direct whisper between Keys.
        </p>

        <div class="input-group">
          <div class="input-label">
            <span>Message</span>
            <span class="char-count" id="pureCharCount">0 / 500</span>
          </div>
          <textarea id="pureContent" placeholder="Your whisper..." maxlength="500" oninput="updatePureCharCount()"></textarea>
        </div>

        <div class="input-group">
          <div class="input-label">Recipient Key ID (0 = broadcast)</div>
          <input type="text" id="pureRecipient" placeholder="0">
        </div>

        <!-- Spacer -->
        <div class="card-spacer"></div>

        <!-- Submit -->
        <div class="submit-row">
          <div class="fee-display">Fee: <span class="fee-amount free">Free</span></div>
          <button class="btn-whisper" id="btnSubmitPure" onclick="submitPureSignal()">Send Whisper</button>
        </div>

        <div id="pureStatus"></div>
      </div>

    </div>

    <!-- LINK TO ATTESTS -->
    <div class="attests-link">
      <a href="/attests.html">View Attestable Signals →</a>
    </div>

  </div>
</main>

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════════════════════════
  // CONFIG
  // ═══════════════════════════════════════════════════════════════════
  var CHAIN_ID = '0x13882';
  var Z1N_KEY = '0x71B31cb8FC0e4D538c2865FeBBfC8C56f41a00d6';
  var Z1N_CORE = '0xade14831356722154A39D40a8EBd4ee1FD4c7D6a';
  var Z1N_SIGNAL = '0x85f0A512cd246A6e659E2D188763482F587dc9f7';
  var RPC_URL = 'https://rpc-amoy.polygon.technology';

  // Fee constants (in wei)
  var SUBMISSION_FEE = '10000000000000000'; // 0.01 POL
  var SILENCE_FEE = '15000000000000000';    // 0.015 POL

  var SEL = {
    balanceOf: '0x70a08231',
    tokenOfOwnerByIndex: '0x2f745c59',
    ownerOf: '0x6352211e',
    glyphs: '0x887296c3',
    currentEpoch: '0x76671808',
    signalCount: '0xfd68f0e5',
    attestCount: '0xfe6569d7'
  };

  var GLYPHS = ['∞','π','⋮','⊕','⊗','∴','∵','↔','↻','△','◇','○','●','□','☰','☷','⚑','✱','⊥','≡','◊'];

  // ═══════════════════════════════════════════════════════════════════
  // STATE
  // ═══════════════════════════════════════════════════════════════════
  var provider = null;
  var currentAccount = null;
  var currentKeyId = null;
  var currentEpoch = 0;
  var selectedIntent = 0;
  var signalType = 'new';
  var signalsUsed = 0;
  var attestsUsed = 0;

  // ═══════════════════════════════════════════════════════════════════
  // GET PROVIDER
  // ═══════════════════════════════════════════════════════════════════
  function getProvider() {
    if (window.ethereum && window.ethereum.providers) {
      return window.ethereum.providers.find(function(p) { return p.isMetaMask; }) || window.ethereum;
    }
    return window.ethereum;
  }

  // ═══════════════════════════════════════════════════════════════════
  // HELPERS
  // ═══════════════════════════════════════════════════════════════════
  function encodeUint256(val) {
    return BigInt(val).toString(16).padStart(64, '0');
  }

  function encodeAddress(addr) {
    return addr.slice(2).toLowerCase().padStart(64, '0');
  }

  function encodeBytes32(str) {
    // Convert string to bytes32 hex (UTF-8, padded)
    var hex = '';
    for (var i = 0; i < str.length && i < 32; i++) {
      hex += str.charCodeAt(i).toString(16).padStart(2, '0');
    }
    return hex.padEnd(64, '0');
  }

  function stringToHex(str) {
    var hex = '';
    for (var i = 0; i < str.length; i++) {
      hex += str.charCodeAt(i).toString(16).padStart(2, '0');
    }
    return hex;
  }

  function keccak256Simple(str) {
    // Simple hash for signal hash - in production use proper keccak
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
      var char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return '0x' + Math.abs(hash).toString(16).padStart(64, '0');
  }

  async function rpcCall(method, params) {
    var response = await fetch(RPC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: method, params: params })
    });
    var data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return data.result;
  }

  function decodeGlyphs(len, pack) {
    if (len === 0 || pack === BigInt(0)) return null;
    var symbols = [];
    for (var i = 0; i < len; i++) {
      var shift = BigInt(5 * (7 - 1 - i));
      var idx = Number((pack >> shift) & BigInt(0x1F));
      if (idx < GLYPHS.length) symbols.push(GLYPHS[idx]);
    }
    return '<span style="color:#fff">' + symbols.join('</span><span style="color:#5d6680;margin:0 2px">·</span><span style="color:#fff">') + '</span>';
  }

  // ═══════════════════════════════════════════════════════════════════
  // URL PARAMS
  // ═══════════════════════════════════════════════════════════════════
  function getUrlParam(name) {
    var params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // ═══════════════════════════════════════════════════════════════════
  // UI FUNCTIONS
  // ═══════════════════════════════════════════════════════════════════
  window.selectIntent = function(intent) {
    selectedIntent = intent;
    document.querySelectorAll('.intent-btn').forEach(function(btn) {
      btn.classList.toggle('selected', parseInt(btn.dataset.intent) === intent);
    });
    var fee = intent === 3 ? '0.015 POL' : '0.01 POL';
    document.getElementById('pogFee').textContent = fee;
  };

  window.setSignalType = function(type) {
    signalType = type;
    document.querySelectorAll('.toggle-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.type === type);
    });
    document.getElementById('replySection').classList.toggle('active', type === 'reply');
  };

  window.updateCharCount = function() {
    var content = document.getElementById('signalContent').value;
    document.getElementById('charCount').textContent = content.length + ' / 280';
  };

  window.updatePureCharCount = function() {
    var content = document.getElementById('pureContent').value;
    document.getElementById('pureCharCount').textContent = content.length + ' / 500';
  };

  function updateStatusDots() {
    var signalDotsEl = document.getElementById('signalDots');
    var attestDotsEl = document.getElementById('attestDots');

    var s1 = signalsUsed >= 1 ? '<span class="dot-filled">●</span>' : '<span class="dot-open">○</span>';
    var s2 = signalsUsed >= 2 ? '<span class="dot-filled">●</span>' : '<span class="dot-open">○</span>';
    signalDotsEl.innerHTML = s1 + s2;

    var a1 = attestsUsed >= 1 ? '<span class="dot-filled">●</span>' : '<span class="dot-open">○</span>';
    var a2 = attestsUsed >= 2 ? '<span class="dot-filled">●</span>' : '<span class="dot-open">○</span>';
    attestDotsEl.innerHTML = a1 + a2;
  }

  // ═══════════════════════════════════════════════════════════════════
  // VERIFY KEY OWNERSHIP
  // ═══════════════════════════════════════════════════════════════════
  async function verifyKeyOwnership(tokenId, expectedOwner) {
    var data = SEL.ownerOf + encodeUint256(tokenId);
    var result = await rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest']);
    var owner = '0x' + result.slice(26).toLowerCase();
    return owner.toLowerCase() === expectedOwner.toLowerCase();
  }

  // ═══════════════════════════════════════════════════════════════════
  // LOAD KEY DATA
  // ═══════════════════════════════════════════════════════════════════
  async function loadKeyData(keyId) {
    try {
      // Get glyphs
      var glyphData = SEL.glyphs + encodeUint256(keyId);
      var glyphResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: glyphData }, 'latest']);
      var len = parseInt(glyphResult.slice(2, 66), 16);
      var pack = BigInt('0x' + glyphResult.slice(66, 130));
      var glyphStr = decodeGlyphs(len, pack);

      document.getElementById('keyIdDisplay').textContent = 'Key #' + keyId;
      document.getElementById('keyGlyphs').innerHTML = glyphStr || '—';

      // Get current epoch
      var epochResult = await rpcCall('eth_call', [{ to: Z1N_CORE, data: SEL.currentEpoch }, 'latest']);
      currentEpoch = parseInt(epochResult, 16);

      // Get signal/attest counts
      var signalData = SEL.signalCount + encodeUint256(keyId) + encodeUint256(currentEpoch);
      var signalResult = await rpcCall('eth_call', [{ to: Z1N_SIGNAL, data: signalData }, 'latest']);
      signalsUsed = parseInt(signalResult, 16);

      var attestData = SEL.attestCount + encodeUint256(keyId) + encodeUint256(currentEpoch);
      var attestResult = await rpcCall('eth_call', [{ to: Z1N_SIGNAL, data: attestData }, 'latest']);
      attestsUsed = parseInt(attestResult, 16);

      updateStatusDots();

    } catch (e) {
      console.error('Error loading key data:', e);
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // SUBMIT POG SIGNAL
  // ═══════════════════════════════════════════════════════════════════
  window.submitPoGSignal = async function() {
    var statusEl = document.getElementById('pogStatus');
    var content = document.getElementById('signalContent').value.trim();

    if (!content) {
      statusEl.innerHTML = '<div class="status-msg error">Please enter signal content.</div>';
      return;
    }

    if (signalsUsed >= 2) {
      statusEl.innerHTML = '<div class="status-msg error">You have used all 2 signals for this epoch.</div>';
      return;
    }

    if (!provider || !currentAccount) {
      statusEl.innerHTML = '<div class="status-msg error">Wallet not connected.</div>';
      return;
    }

    // Verify ownership first
    statusEl.innerHTML = '<div class="status-msg pending">Verifying key ownership...</div>';

    try {
      var isOwner = await verifyKeyOwnership(currentKeyId, currentAccount);
      if (!isOwner) {
        statusEl.innerHTML = '<div class="status-msg error">You do not own Key #' + currentKeyId + ' with this wallet.</div>';
        return;
      }

      statusEl.innerHTML = '<div class="status-msg pending">Preparing transaction...</div>';

      // Get reply hash if replying
      var replyToHash = '0x0000000000000000000000000000000000000000000000000000000000000000';
      if (signalType === 'reply') {
        var replyInput = document.getElementById('replyToHash').value.trim();
        if (replyInput && replyInput.startsWith('0x')) {
          replyToHash = replyInput.padEnd(66, '0');
        }
      }

      // Fee
      var feeWei = selectedIntent === 3 ? SILENCE_FEE : SUBMISSION_FEE;
      var valueHex = '0x' + BigInt(feeWei).toString(16);

      // Create signal hash from content
      var signalHash = keccak256Simple(content + currentKeyId + currentEpoch);

      // Encode function call
      // submitSignal(uint256 tokenId, bytes32 signalHash, string cid, uint8 symbolIndex, uint8 intent, uint8 signalType, uint256 epochRef, bytes32 replyTo)
      // For now, use a simpler encoding - just tokenId and intent with content as data
      
      // Actually, let's use a simpler approach - many signal contracts accept:
      // submitSignal(uint256 tokenId, uint8 intent, bytes32 contentHash)
      // Function selector: keccak256("submitSignal(uint256,uint8,bytes32)").slice(0,10)
      
      var contentHash = encodeBytes32(content);
      
      // Try the simpler function signature
      // keccak256("submitSignal(uint256,uint8,bytes32)") = 0x5f396e5f (example, need to verify)
      // Let's calculate: submitSignal(uint256,uint8,bytes32)
      
      // For now, let's just send raw data and see what happens
      var data = '0x' + 
        'a3e1e3ab' +  // submitSignal selector (placeholder - needs verification)
        encodeUint256(currentKeyId) +
        encodeUint256(selectedIntent) +
        contentHash;

      statusEl.innerHTML = '<div class="status-msg pending">Confirm in wallet...</div>';

      var txHash = await provider.request({
        method: 'eth_sendTransaction',
        params: [{
          from: currentAccount,
          to: Z1N_SIGNAL,
          value: valueHex,
          data: data,
          gas: '0x50000'
        }]
      });

      statusEl.innerHTML = '<div class="status-msg pending">Transaction submitted: ' + txHash.slice(0, 14) + '...</div>';

      // Poll for receipt
      var attempts = 0;
      var poll = setInterval(async function() {
        attempts++;
        if (attempts > 60) {
          clearInterval(poll);
          statusEl.innerHTML = '<div class="status-msg pending">Taking long... <a href="https://amoy.polygonscan.com/tx/' + txHash + '" target="_blank" style="color:var(--keys-accent)">View on explorer</a></div>';
          return;
        }

        try {
          var receipt = await provider.request({
            method: 'eth_getTransactionReceipt',
            params: [txHash]
          });

          if (receipt) {
            clearInterval(poll);
            if (receipt.status === '0x1') {
              statusEl.innerHTML = '<div class="status-msg success">✅ Signal submitted to the Field!</div>';
              signalsUsed++;
              updateStatusDots();
              document.getElementById('signalContent').value = '';
              updateCharCount();
            } else {
              statusEl.innerHTML = '<div class="status-msg error">Transaction failed. <a href="https://amoy.polygonscan.com/tx/' + txHash + '" target="_blank" style="color:var(--keys-accent)">View on explorer</a></div>';
            }
          }
        } catch (e) {}
      }, 2000);

    } catch (e) {
      console.error('Submit error:', e);
      var errMsg = e.message || 'Transaction failed';
      if (errMsg.includes('rejected') || errMsg.includes('denied')) {
        statusEl.innerHTML = '<div class="status-msg error">Transaction rejected by user.</div>';
      } else {
        statusEl.innerHTML = '<div class="status-msg error">' + errMsg.slice(0, 100) + '</div>';
      }
    }
  };

  // ═══════════════════════════════════════════════════════════════════
  // SUBMIT PURE SIGNAL
  // ═══════════════════════════════════════════════════════════════════
  window.submitPureSignal = function() {
    var statusEl = document.getElementById('pureStatus');
    var content = document.getElementById('pureContent').value.trim();

    if (!content) {
      statusEl.innerHTML = '<div class="status-msg error">Please enter a message.</div>';
      return;
    }

    statusEl.innerHTML = '<div class="status-msg pending">Pure signal submission coming soon...</div>';
  };

  // ═══════════════════════════════════════════════════════════════════
  // CONNECT WALLET
  // ═══════════════════════════════════════════════════════════════════
  async function connectWallet() {
    var eth = getProvider();
    if (!eth) {
      alert('Please install MetaMask');
      return;
    }

    provider = eth;

    try {
      var accounts = await provider.request({ method: 'eth_accounts' });
      if (!accounts || accounts.length === 0) {
        accounts = await provider.request({ method: 'eth_requestAccounts' });
      }
      currentAccount = accounts[0];

      var chainId = await provider.request({ method: 'eth_chainId' });
      if (chainId !== CHAIN_ID) {
        try {
          await provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CHAIN_ID }]
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await provider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: CHAIN_ID,
                chainName: 'Polygon Amoy Testnet',
                nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                rpcUrls: ['https://rpc-amoy.polygon.technology'],
                blockExplorerUrls: ['https://amoy.polygonscan.com']
              }]
            });
          }
        }
      }

      var keyIdParam = getUrlParam('key');
      if (keyIdParam) {
        currentKeyId = parseInt(keyIdParam);
      } else {
        var balanceData = SEL.balanceOf + encodeAddress(currentAccount);
        var balanceResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: balanceData }, 'latest']);
        var balance = parseInt(balanceResult, 16);

        if (balance === 0) {
          alert('This wallet has no Z1N Keys. Please mint a key first.');
          window.location.href = '/mint-key.html';
          return;
        }

        var tokenData = SEL.tokenOfOwnerByIndex + encodeAddress(currentAccount) + encodeUint256(0);
        var tokenResult = await rpcCall('eth_call', [{ to: Z1N_KEY, data: tokenData }, 'latest']);
        currentKeyId = parseInt(tokenResult, 16);
      }

      document.getElementById('connectState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      await loadKeyData(currentKeyId);

    } catch (e) {
      console.error('Connect error:', e);
      alert('Connection failed: ' + e.message);
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // INIT
  // ═══════════════════════════════════════════════════════════════════
  document.getElementById('btnConnect').onclick = connectWallet;

  var eth = getProvider();
  if (eth) {
    eth.request({ method: 'eth_accounts' }).then(function(accounts) {
      if (accounts.length > 0) {
        connectWallet();
      }
    }).catch(function(e) {
      console.log('Auto-connect check failed:', e);
    });
  }

})();
</script>

</body>
</html>
