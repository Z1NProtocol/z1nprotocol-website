<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Z1N Protocol – Mint Live Artefact</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #050812;
      --card-bg: #020617;
      --text-main: #ffffff;
      --text-soft: #8f9ab5;
      --accent: #66d69a;
      --accent-soft: #3a9f63;
      --card-border: rgba(148,163,184,0.25);
      --keys-accent: #f5c842;
      --keys-accent-soft: #d4a012;
      --danger: #f44336;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scrollbar-gutter: stable; overflow-y: scroll; scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text-main); font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    a { color: inherit; text-decoration: none; }
    a:hover { opacity: 0.9; }

    header { height: 72px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
    .nav-inner { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; }
    .logo-link { display: inline-flex; align-items: center; gap: 8px; }
    .logo-dot { width: 24px; height: 24px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.35); display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
    .logo-text { font-size: 11px; letter-spacing: 0.18em; text-transform: uppercase; opacity: 0.7; }
    .nav-links { display: flex; gap: 22px; font-size: 13px; opacity: 0.85; }
    .nav-links a.active-keys { color: var(--keys-accent); }

    .page { max-width: 1200px; margin: 0 auto; padding: 40px 24px 72px; }
    .back-link { color: var(--text-soft); font-size: 13px; display: inline-flex; align-items: center; gap: 4px; margin-bottom: 16px; }
    .back-link:hover { color: var(--accent); }

    h1 { font-size: 32px; font-weight: 700; letter-spacing: -0.02em; margin: 0 0 10px 0; color: var(--accent); }
    .subtitle { font-size: 15px; line-height: 1.6; opacity: 0.85; max-width: 720px; margin-bottom: 32px; }

    .mint-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; align-items: stretch; }

    .mint-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 24px; display: flex; flex-direction: column; }
    .key-header { margin-bottom: 20px; }
    .key-id { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
    .key-glyphs { font-size: 18px; color: #aaa; letter-spacing: 2px; }
    .key-info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    .key-info-row:last-child { border-bottom: none; }
    .key-info-label { color: var(--text-soft); }
    .key-info-value { color: var(--text-main); font-weight: 500; }

    .info-notice { display: flex; align-items: flex-start; gap: 10px; background: rgba(102, 214, 154, 0.08); border: 1px solid rgba(102, 214, 154, 0.25); border-radius: 12px; padding: 14px; margin-top: auto; font-size: 13px; color: var(--text-soft); line-height: 1.5; }
    .info-notice::before { content: "◈"; color: var(--accent); font-size: 14px; }
    .info-notice.paid { background: rgba(245, 200, 66, 0.08); border-color: rgba(245, 200, 66, 0.25); }
    .info-notice.paid::before { content: "◇"; color: var(--keys-accent); }

    .preview-section { position: relative; display: flex; flex-direction: column; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 24px; }
    .preview-title { text-align: center; font-size: 11px; letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-soft); margin-bottom: 12px; }
    .preview-container { position: relative; width: 100%; flex: 1; display: flex; align-items: center; justify-content: center; }
    .preview-container img { width: 100%; max-width: 420px; height: auto; border-radius: 32px; display: block; transition: opacity 0.2s ease; }
    .preview-container img.loading { opacity: 0.5; }

    .preview-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; gap: 20px; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
    .preview-loading.active { opacity: 1; }
    .preview-loading-spinner { width: 56px; height: 56px; border: 3px solid rgba(102, 214, 154, 0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .preview-loading-text { font-size: 15px; color: var(--text-soft); }

    /* MINT BUTTON - GREEN themed */
    .mint-btn {
      position: absolute;
      top: 48%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(102, 214, 154, 0.25);
      border: 2px solid rgba(102, 214, 154, 0.6);
      color: var(--accent);
      padding: 18px 40px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.25s ease;
      z-index: 10;
      white-space: nowrap;
      backdrop-filter: blur(4px);
    }
    .mint-btn:hover:not(:disabled) {
      background: linear-gradient(90deg, var(--accent), var(--accent-soft));
      border-color: var(--accent);
      color: #000;
      transform: translate(-50%, -50%) scale(1.02);
      box-shadow: 0 8px 32px rgba(102, 214, 154, 0.4);
    }
    .mint-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .mint-btn.minting { background: rgba(143, 154, 181, 0.3); border-color: rgba(143, 154, 181, 0.5); color: var(--text-soft); transform: translate(-50%, -50%); }
    .mint-btn.success { background: linear-gradient(90deg, var(--accent), var(--accent-soft)); border-color: var(--accent); color: #000; transform: translate(-50%, -50%); }

    .status-area { margin-top: 16px; text-align: center; min-height: 40px; }
    .status-msg { padding: 10px 16px; border-radius: 8px; font-size: 13px; display: inline-block; max-width: 100%; text-align: left; }
    .status-msg.success { background: rgba(102, 214, 154, 0.15); color: var(--accent); }
    .status-msg.error { background: rgba(244, 67, 54, 0.15); color: #f44336; }
    .status-msg.pending { background: rgba(245, 200, 66, 0.15); color: var(--keys-accent); }

    footer { border-top: 1px solid rgba(255,255,255,0.05); padding: 20px; font-size: 12px; text-align: center; opacity: 0.85; margin-top: 40px; }
    footer .tagline { margin-bottom: 6px; font-size: 13px; }
    footer .links { display: flex; justify-content: center; gap: 18px; font-size: 13px; }

    .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; background: rgba(102, 214, 154, 0.95); color: #000; border-radius: 10px; font-size: 14px; font-weight: 600; z-index: 10000; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateY(0); }

    @media (max-width: 900px) {
      .mint-layout { grid-template-columns: 1fr; }
      .preview-section { order: -1; }
    }
  </style>
</head>
<body>
<div class="toast" id="toast"></div>

<header>
  <div class="nav-inner">
    <a href="index.html" class="logo-link">
      <div class="logo-dot">Ω</div>
      <div class="logo-text">Z1N PROTOCOL</div>
    </a>
    <nav class="nav-links">
      <a href="about.html">About</a>
      <a href="live-stats.html">Live Stats</a>
      <a href="artefacts.html">Artefacts</a>
      <a href="nbi-artefacts.html">4 NBIs</a>
      <a href="mint-key.html">Mint Key</a>
      <a href="your-keys.html" class="active-keys">Your Keys</a>
    </nav>
  </div>
</header>

<main class="page">
  <a href="#" class="back-link" id="backLink">← Back to Artefacts</a>

  <h1>Mint Live Artefact</h1>
  <p class="subtitle">A Live Artefact is a dynamic mirror of your Key's presence in the Field — always reflecting your current state.</p>

  <div class="mint-layout">
    <div class="mint-card">
      <div class="key-header">
        <div class="key-id" id="keyTitle">Key #—</div>
        <div class="key-glyphs" id="keyGlyphs">Loading...</div>
      </div>

      <div class="key-info-row">
        <span class="key-info-label">Wallet</span>
        <span class="key-info-value" id="walletDisplay">—</span>
      </div>
      <div class="key-info-row">
        <span class="key-info-label">Has Live Artefact</span>
        <span class="key-info-value" id="hasArtefactDisplay">—</span>
      </div>
      <div class="key-info-row">
        <span class="key-info-label">Price</span>
        <span class="key-info-value" id="priceDisplay">—</span>
      </div>

      <div class="info-notice" id="infoFree">
        Your first Live Artefact is free — a gift for joining the Field.
      </div>
      <div class="info-notice paid" id="infoPaid" style="display:none;">
        Extra Live Artefacts cost 0.021 POL each.
      </div>
    </div>

    <div class="preview-section">
      <div class="preview-title">Live Artefact Preview</div>
      <div class="preview-container">
        <img id="previewImg" src="" alt="Artefact Preview">
        
        <div class="preview-loading" id="previewLoading">
          <div class="preview-loading-spinner"></div>
          <div class="preview-loading-text">Loading preview...</div>
        </div>
        
        <button class="mint-btn" id="mintBtn">Mint Live Artefact — FREE</button>
      </div>
      <div class="status-area" id="statusArea"></div>
    </div>
  </div>
</main>

<footer>
  <div class="tagline">Your presence is real · The Field remembers</div>
  <div class="links">
    <a href="https://github.com/z1nprotocol" target="_blank">GitHub</a>
    <a href="https://x.com/z1n_AI" target="_blank">X</a>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
<script>
(function() {
  'use strict';

  var API = 'https://z1n-backend-production.up.railway.app/api';
  var CHAIN_ID = '0x89';
  var Z1N_KEY = '0xe27C2De6e8F1090EEAe18E1Ce3f51F1D2FeAf469';
  var Z1N_ARTEFACT = '0xf1887e8D53bbb61F64bfD16Ec41598618053bd2c';
  
  var MINT_PRICE = '0x4a9b6384488000';
  var MINT_PRICE_DISPLAY = '0.021 POL';

  var RPC_URLS = [
    'https://polygon-bor-rpc.publicnode.com',
    'https://polygon.blockpi.network/v1/rpc/public',
    'https://rpc-mainnet.maticvigil.com'
  ];
  var currentRpcIndex = 0;

  var provider = null;
  var account = null;
  var keyId = null;
  var walletParam = '';
  var hasFirstArtefact = false;
  var currentEpoch = 0;
  var keyOwner = '';

  var keyTitle = document.getElementById('keyTitle');
  var keyGlyphs = document.getElementById('keyGlyphs');
  var walletDisplay = document.getElementById('walletDisplay');
  var hasArtefactDisplay = document.getElementById('hasArtefactDisplay');
  var priceDisplay = document.getElementById('priceDisplay');
  var infoFree = document.getElementById('infoFree');
  var infoPaid = document.getElementById('infoPaid');
  var mintBtn = document.getElementById('mintBtn');
  var statusArea = document.getElementById('statusArea');
  var toast = document.getElementById('toast');
  var previewImg = document.getElementById('previewImg');
  var previewLoading = document.getElementById('previewLoading');
  var backLink = document.getElementById('backLink');

  function getParam(name) { 
    var url = new URL(window.location.href);
    var val = url.searchParams.get(name);
    if (val) return val;
    var hash = window.location.hash.substring(1);
    if (hash) {
      var hashParams = new URLSearchParams(hash);
      val = hashParams.get(name);
      if (val) return val;
    }
    return null;
  }
  
  function shortAddr(a) { return a ? a.slice(0,6) + '...' + a.slice(-4) : '—'; }
  function enc256(v) { return BigInt(v).toString(16).padStart(64, '0'); }

  function showToast(message, duration) {
    if (!toast) return;
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(function() { toast.classList.remove('show'); }, duration || 3000);
  }

  function showLoading() { previewLoading.classList.add('active'); previewImg.classList.add('loading'); }
  function hideLoading() { previewLoading.classList.remove('active'); previewImg.classList.remove('loading'); }

  function getProvider() {
    var eth = window.ethereum;
    if (!eth) {
      if (window.phantom && window.phantom.ethereum) return window.phantom.ethereum;
      return null;
    }
    if (eth.providers && eth.providers.length) {
      var mm = eth.providers.find(function(p) { return p.isMetaMask && !p.isBraveWallet; });
      if (mm) return mm;
      return eth.providers[0];
    }
    return eth;
  }

  async function rpc(method, params, retryCount) {
    retryCount = retryCount || 0;
    var maxRetries = RPC_URLS.length * 2;
    
    try {
      var rpcUrl = RPC_URLS[currentRpcIndex];
      var response = await fetch(rpcUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', id: Date.now(), method: method, params: params })
      });
      var data = await response.json();
      
      if (data.error) {
        if (data.error.message && (data.error.message.includes('rate') || data.error.message.includes('Too Many'))) {
          currentRpcIndex = (currentRpcIndex + 1) % RPC_URLS.length;
          if (retryCount < maxRetries) {
            await new Promise(function(r) { setTimeout(r, 300); });
            return rpc(method, params, retryCount + 1);
          }
        }
        throw new Error(data.error.message);
      }
      return data.result;
    } catch (err) {
      currentRpcIndex = (currentRpcIndex + 1) % RPC_URLS.length;
      if (retryCount < maxRetries) {
        await new Promise(function(r) { setTimeout(r, 300); });
        return rpc(method, params, retryCount + 1);
      }
      throw err;
    }
  }

  // Init
  var keyParam = getParam('key');
  keyId = keyParam !== null ? parseInt(keyParam) : NaN;
  
  if (isNaN(keyId)) {
    try {
      var ctx = JSON.parse(localStorage.getItem('z1n_signal_context') || '{}');
      keyId = typeof ctx.keyId === 'number' ? ctx.keyId : 0;
    } catch (e) { keyId = 0; }
  }

  walletParam = getParam('wallet') || '';
  if (!walletParam) {
    try {
      var ctx = JSON.parse(localStorage.getItem('z1n_signal_context') || '{}');
      walletParam = ctx.wallet || '';
    } catch (e) {}
  }

  var walletQuery = walletParam ? '&wallet=' + encodeURIComponent(walletParam) : '';
  backLink.href = 'key-artefacts.html?key=' + keyId + walletQuery;

  keyTitle.textContent = 'Key #' + keyId;
  walletDisplay.textContent = shortAddr(walletParam);
  keyOwner = walletParam.toLowerCase();
  showLoading();

  fetch(API + '/keys/' + keyId)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      keyGlyphs.textContent = data.glyphLine || '◇ · ∞ · ☰';
      return fetch(API + '/live');
    })
    .then(function(r) { return r.json(); })
    .then(function(live) {
      currentEpoch = live.currentEpoch || 0;
      updatePreview();
    })
    .catch(function(e) {
      console.error('Load error:', e);
      keyGlyphs.textContent = '◇ · ∞ · ☰';
      hideLoading();
    });

  function updatePreview() {
    var img = new Image();
    var src = API + '/artefact/' + keyId + '/static-preview?epoch=' + currentEpoch + '&t=' + Date.now();
    img.onload = function() { previewImg.src = src; hideLoading(); };
    img.onerror = function() { hideLoading(); };
    img.src = src;
  }

  async function checkHasFirstArtefact() {
    try {
      var data = '0xff84f877' + enc256(keyId);
      var result = await rpc('eth_call', [{ to: Z1N_ARTEFACT, data: data }, 'latest']);
      hasFirstArtefact = parseInt(result, 16) > 0;
      updatePriceDisplay();
    } catch (e) {
      console.warn('Could not check artefact status:', e);
      hasFirstArtefact = false;
      updatePriceDisplay();
    }
  }

  function updatePriceDisplay() {
    if (hasFirstArtefact) {
      hasArtefactDisplay.textContent = 'Yes';
      priceDisplay.textContent = MINT_PRICE_DISPLAY;
      infoFree.style.display = 'none';
      infoPaid.style.display = 'flex';
      mintBtn.textContent = 'Mint Extra Artefact — ' + MINT_PRICE_DISPLAY;
    } else {
      hasArtefactDisplay.textContent = 'No';
      priceDisplay.textContent = 'FREE';
      infoFree.style.display = 'flex';
      infoPaid.style.display = 'none';
      mintBtn.textContent = 'Mint Live Artefact — FREE';
    }
  }

  checkHasFirstArtefact();

  async function connectWallet() {
    var eth = getProvider();
    if (!eth) {
      statusArea.innerHTML = '<div class="status-msg error">No wallet found. Install MetaMask or another Web3 wallet.</div>';
      return false;
    }

    provider = eth;

    try {
      var accs = await provider.request({ method: 'eth_accounts' });
      if (!accs || accs.length === 0) {
        accs = await provider.request({ method: 'eth_requestAccounts' });
      }

      if (!accs || accs.length === 0) {
        statusArea.innerHTML = '<div class="status-msg error">No accounts found. Please unlock your wallet.</div>';
        return false;
      }

      var urlWallet = walletParam.toLowerCase();
      if (urlWallet) {
        account = accs.find(function(a) { return a.toLowerCase() === urlWallet; }) || accs[0];
      } else {
        account = accs[0];
      }
      account = account.toLowerCase();

      walletDisplay.textContent = shortAddr(account);

      var chainId = await provider.request({ method: 'eth_chainId' });
      if (chainId !== CHAIN_ID) {
        try {
          await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID }] });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await provider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: CHAIN_ID,
                chainName: 'Polygon',
                nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                rpcUrls: ['https://rpc-mainnet.maticvigil.com'],
                blockExplorerUrls: ['https://polygonscan.com']
              }]
            });
          } else {
            throw switchError;
          }
        }
      }

      // Verify key ownership
      var ownerData = '0x6352211e' + enc256(keyId);
      var ownerResult = await rpc('eth_call', [{ to: Z1N_KEY, data: ownerData }, 'latest']);
      keyOwner = '0x' + ownerResult.slice(26).toLowerCase();

      if (keyOwner !== account) {
        statusArea.innerHTML = '<div class="status-msg error">⚠️ This Key is owned by <strong>' + shortAddr(keyOwner) + '</strong><br><br>Switch to this wallet in your wallet app to mint.</div>';
        mintBtn.disabled = true;
        return false;
      }

      await checkHasFirstArtefact();
      return true;

    } catch (e) {
      console.error('Connection error:', e);
      statusArea.innerHTML = '<div class="status-msg error">' + (e.message || 'Connection failed') + '</div>';
      return false;
    }
  }

  mintBtn.addEventListener('click', async function() {
    if (!account || !provider) {
      statusArea.innerHTML = '<div class="status-msg pending">Connecting wallet...</div>';
      var connected = await connectWallet();
      if (!connected) return;
    }

    if (!provider) {
      statusArea.innerHTML = '<div class="status-msg error">Wallet not available</div>';
      return;
    }

    mintBtn.disabled = true;
    mintBtn.textContent = 'Preparing...';
    mintBtn.classList.add('minting');
    
    statusArea.innerHTML = '<div class="status-msg pending">Preparing transaction...</div>';

    try {
      var functionName = hasFirstArtefact ? 'mintExtraArtefact' : 'mintFirstArtefact';
      var iface = new ethers.Interface([
        'function mintFirstArtefact(uint256 keyId)',
        'function mintExtraArtefact(uint256 keyId) payable'
      ]);
      
      var encodedData = iface.encodeFunctionData(functionName, [BigInt(keyId)]);

      statusArea.innerHTML = '<div class="status-msg pending">Confirm in your wallet...</div>';
      mintBtn.textContent = 'Confirm in wallet...';

      var txParams = { from: account, to: Z1N_ARTEFACT, data: encodedData };
      if (hasFirstArtefact) txParams.value = MINT_PRICE;

      var txHash = await provider.request({ method: 'eth_sendTransaction', params: [txParams] });

      statusArea.innerHTML = '<div class="status-msg pending">Transaction sent... waiting for confirmation</div>';
      mintBtn.textContent = 'Confirming...';

      var success = await waitForReceipt(txHash);

      if (success) {
        statusArea.innerHTML = '<div class="status-msg success">✓ Live Artefact minted successfully!</div>';
        mintBtn.textContent = '✓ Minted!';
        mintBtn.classList.remove('minting');
        mintBtn.classList.add('success');
        showToast('✅ Live Artefact minted!', 4000);

        setTimeout(function() {
          window.location.href = 'key-artefacts.html?key=' + keyId + '&wallet=' + encodeURIComponent(account) + '&minted=live';
        }, 2500);
      } else {
        throw new Error('Transaction failed on-chain');
      }

    } catch (e) {
      console.error('Mint error:', e);
      var msg = e.message || 'Unknown error';
      var code = e.code || 0;
      
      if (msg.includes('reject') || msg.includes('denied') || msg.includes('User denied') || code === 4001) {
        msg = 'Transaction rejected by user';
      } else if (msg.includes('Internal JSON-RPC') || code === -32603 || msg.includes('execution reverted')) {
        msg = '<strong>Transaction failed</strong><br><br>' +
          'The connected wallet may not own this Key.<br><br>' +
          '<strong>Fix:</strong> Switch to the Key owner wallet and try again.';
      } else if (msg.includes('insufficient')) {
        msg = 'Insufficient funds for gas';
      } else {
        msg = 'Error: ' + msg.slice(0, 150);
      }
      
      statusArea.innerHTML = '<div class="status-msg error">' + msg + '</div>';
      mintBtn.disabled = false;
      mintBtn.classList.remove('minting');
      mintBtn.textContent = hasFirstArtefact ? 'Mint Extra Artefact — ' + MINT_PRICE_DISPLAY : 'Mint Live Artefact — FREE';
    }
  });

  async function waitForReceipt(txHash) {
    for (var i = 0; i < 60; i++) {
      await new Promise(function(r) { setTimeout(r, 2000); });
      try {
        var rc = await rpc('eth_getTransactionReceipt', [txHash]);
        if (rc && rc.status === '0x1') return true;
        if (rc && rc.status === '0x0') return false;
      } catch (e) { console.warn('Receipt check failed:', e); }
    }
    return false;
  }

  (async function() {
    var eth = getProvider();
    if (eth) {
      try {
        var accs = await eth.request({ method: 'eth_accounts' });
        if (accs && accs.length > 0) {
          await connectWallet();
        }
      } catch (e) {}
    }
  })();

})();
</script>
</body>
</html>

