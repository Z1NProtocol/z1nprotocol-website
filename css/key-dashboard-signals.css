/**
 * Z1N Fix v6 â€” 6 targeted fixes on current Key-dashboard.js
 * 
 * 1. getShortGlyphs: Return FULL glyph sequence instead of truncated 4
 * 2. Sent Signals: No K#/glyph for new signals; fix K#? for replies
 * 3. Received Attests: unread-glow already in JS â€” no JS change needed (CSS fix separate)
 * 4. Attestable signals: Full glyphs + white text on signal content
 * 5. Whispers sent: Full glyphs (via fix #1)
 * 6. Whispers received: K# yellow instead of green + unread-glow styling
 * 
 * Run: cd "C:\Users\bobva\Z1N Incl Pure\backend"; node fix-signals-v6.js
 */

const fs = require('fs');
const TARGET = 'C:\\Users\\bobva\\Z1N Incl Pure\\frontend\\z1nprotocol-website-main\\js\\Key-dashboard.js';

console.log('Reading:', TARGET);
let code = fs.readFileSync(TARGET, 'utf8');
const hadCRLF = code.includes('\r\n');
code = code.replace(/\r\n/g, '\n');

let changes = 0;
let failures = 0;

function applyFix(name, oldStr, newStr) {
  if (code.includes(oldStr)) {
    code = code.replace(oldStr, newStr);
    console.log('  âœ… ' + name);
    changes++;
  } else {
    console.log('  âŒ ' + name + ': NOT FOUND');
    failures++;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX 1: getShortGlyphs â€” return FULL glyphs, no truncation
// This fixes glyphs everywhere: sent signals, attests, whispers, attestable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applyFix(
  'FIX 1: getShortGlyphs â†’ full glyphs',
  "function getShortGlyphs(keyId) { var full = keyGlyphsCache[keyId] || ''; if (!full) return ''; return full.split(' Â· ').slice(0, 4).join('Â·'); }",
  "function getShortGlyphs(keyId) { var full = keyGlyphsCache[keyId] || ''; if (!full) return ''; return full; }"
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX 2a: Sent Signals â€” NON-REPLY: remove K# and glyphs entirely
// Current code for non-reply:
//   '<span style="color:var(--keys-accent);font-weight:600;">K#' + sig.keyId + '</span>' + gs +
// Replace with: no K# line, just intent + attests + epoch
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applyFix(
  'FIX 2a: Sent Signals non-reply â€” remove K# and glyphs',
  // The entire non-reply innerHTML block
  "it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span style=\"color:var(--keys-accent);font-weight:600;\">K#' + sig.keyId + '</span>' + gs + '<span class=\"intent-tag ' + ic + '\" style=\"margin-left:6px;\">' + isym + '</span><span class=\"signal-attests\" style=\"margin-left:6px;\">âœ“' + (sig.attestCount||0) + '</span><span style=\"color:var(--text-soft);margin-left:6px;\">Epoch ' + displayEpoch + '</span></div><div class=\"signal-content-preview\" style=\"white-space:pre-wrap;word-break:break-word;\">' + escapeHtml(content) + '</div></div><div style=\"display:flex;flex-direction:column;align-items:flex-end;gap:4px;\"><span class=\"signal-time\">' + (sig.timeAgo || '') + '</span></div>';",
  // New: no K#, no glyphs, just intent badge + attests + epoch
  "it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span class=\"intent-tag ' + ic + '\">' + isym + '</span><span class=\"signal-attests\" style=\"margin-left:6px;\">âœ“' + (sig.attestCount||0) + '</span><span style=\"color:var(--text-soft);margin-left:6px;\">Epoch ' + displayEpoch + '</span></div><div class=\"signal-content-preview\" style=\"white-space:pre-wrap;word-break:break-word;\">' + escapeHtml(content) + '</div></div><div style=\"display:flex;flex-direction:column;align-items:flex-end;gap:4px;\"><span class=\"signal-time\">' + (sig.timeAgo || '') + '</span></div>';"
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX 2b: Sent Signals â€” REPLY: fix K#? â†’ use replyToKeyId properly
// + use parent glyphs (pgs) from getShortGlyphs(parentKeyId)
// The parentKeyId variable is already set: var parentKeyId = sig.replyToKeyId || '?';
// Problem: replyToKeyId comes as undefined from API â†’ shows "K#?"
// We need to only show K# line when parentKeyId is a real number
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applyFix(
  'FIX 2b: Sent Signals reply â€” fix K#? display',
  // Current reply block â€” find the parentKeyId setup + innerHTML
  "var parentKeyId = sig.replyToKeyId || '?';\n        var parentGlyphs = parentKeyId !== '?' ? getShortGlyphs(parentKeyId) : '';\n        var pgs = parentGlyphs ? '<span style=\"font-size:10px;color:var(--text-soft);margin-left:4px;\">' + parentGlyphs + '</span>' : '';\n        it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span style=\"color:var(--keys-accent);font-weight:600;\">K#' + parentKeyId + '</span>' + pgs + '<span class=\"intent-tag ' + ic + '\" style=\"margin-left:6px;\">' + isym + '</span><span class=\"signal-attests\" style=\"margin-left:6px;\">âœ“' + (sig.attestCount||0) + '</span><span style=\"color:var(--text-soft);margin-left:6px;\">Epoch ' + displayEpoch + '</span></div><div class=\"signal-content-preview\" style=\"white-space:pre-wrap;word-break:break-word;\">' + escapeHtml(content) + '</div></div><div style=\"display:flex;flex-direction:column;align-items:flex-end;gap:4px;\"><span class=\"signal-time\">' + (sig.timeAgo || '') + '</span><button onclick=\"event.stopPropagation();switchTab(\\'whispers\\');setTimeout(function(){replyWhisper(' + parentKeyId + ')},100);\" style=\"padding:3px 8px;border-radius:4px;border:1px solid rgba(245,200,66,0.3);background:transparent;color:var(--keys-accent);font-size:9px;cursor:pointer;\">ğŸ’¬ Whisper</button></div>';",
  // New: only show K# when replyToKeyId is a real number, full glyphs
  "var parentKeyId = sig.replyToKeyId;\n        var hasParentKey = parentKeyId !== undefined && parentKeyId !== null;\n        var parentGlyphs = hasParentKey ? getShortGlyphs(parentKeyId) : '';\n        var pgs = parentGlyphs ? '<span style=\"font-size:10px;color:var(--text-soft);margin-left:4px;\">' + parentGlyphs + '</span>' : '';\n        var keyLine = hasParentKey ? '<span style=\"color:var(--keys-accent);font-weight:600;\">K#' + parentKeyId + '</span>' + pgs : '';\n        var whisperKeyId = hasParentKey ? parentKeyId : 0;\n        it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\">' + keyLine + '<span class=\"intent-tag ' + ic + '\" style=\"margin-left:6px;\">' + isym + '</span><span class=\"signal-attests\" style=\"margin-left:6px;\">âœ“' + (sig.attestCount||0) + '</span><span style=\"color:var(--text-soft);margin-left:6px;\">Epoch ' + displayEpoch + '</span></div><div class=\"signal-content-preview\" style=\"white-space:pre-wrap;word-break:break-word;\">' + escapeHtml(content) + '</div></div><div style=\"display:flex;flex-direction:column;align-items:flex-end;gap:4px;\"><span class=\"signal-time\">' + (sig.timeAgo || '') + '</span>' + (hasParentKey ? '<button onclick=\"event.stopPropagation();switchTab(\\'whispers\\');setTimeout(function(){replyWhisper(' + whisperKeyId + ')},100);\" style=\"padding:3px 8px;border-radius:4px;border:1px solid rgba(245,200,66,0.3);background:transparent;color:var(--keys-accent);font-size:9px;cursor:pointer;\">ğŸ’¬ Whisper</button>' : '') + '</div>';"
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX 3: Attestable signals â€” white text on signal content
// Current: '<div class="signal-content">'+escapeHtml(sig.cid||'[Silence]')+'</div>'
// Add: style="color:#fff;"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Find in renderAttestSignals the signal-content div
applyFix(
  'FIX 3: Attestable signals â€” white content text',
  "'<div class=\"signal-content\">'+escapeHtml(sig.cid||'[Silence]')+'</div>'",
  "'<div class=\"signal-content\" style=\"color:#fff;\">'+escapeHtml(sig.cid||'[Silence]')+'</div>'"
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX 4: Whispers received â€” K# yellow instead of green
// Current: color:var(--accent) (green)
// Change to: color:var(--keys-accent) (yellow)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// In loadReceivedWhispers:
applyFix(
  'FIX 4a: Received whispers K# â€” green to yellow',
  "it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span style=\"color:var(--accent);font-weight:600;\">K#' + w.fromKeyId + '</span>'",
  "it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span style=\"color:var(--keys-accent);font-weight:600;\">K#' + w.fromKeyId + '</span>'"
);

// Also in filterReceivedWhispers:
applyFix(
  'FIX 4b: Filtered received whispers K# â€” green to yellow',
  "it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span style=\"color:var(--accent);font-weight:600;\">K#' + w.fromKeyId + '</span>'",
  "it.innerHTML = '<div style=\"flex:1;\"><div class=\"signal-item-header\"><span style=\"color:var(--keys-accent);font-weight:600;\">K#' + w.fromKeyId + '</span>'"
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
if (changes > 0) {
  if (hadCRLF) code = code.replace(/\n/g, '\r\n');
  fs.writeFileSync(TARGET, code, 'utf8');
  console.log('âœ… ' + changes + ' fixes applied, ' + failures + ' failures');
} else {
  console.log('âŒ No changes made');
}
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

// Summary
console.log('\nWhat was fixed:');
console.log('  1. Glyphs: Full sequence everywhere (no more truncation)');
console.log('  2a. Sent signals (new): No K# or glyphs shown');
console.log('  2b. Sent signals (reply): K# only when replyToKeyId exists');
console.log('  3. Attestable signals: White text on content');
console.log('  4. Received whispers: K# yellow instead of green');
console.log('\nNOT changed (already correct in JS):');
console.log('  - Received attests: unread-glow logic already present');
console.log('  - Received whispers: unread-glow logic already present');
console.log('\nâš ï¸  CSS note: If unread-glow styling (yellow border/glow)');
console.log('   is not visible, check Key-dashboard.css for .unread-glow class');