<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Z1N Protocol – Live Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#050812;
      --card-bg:#020617;
      --text-main:#ffffff;
      --text-soft:#8f9ab5;
      --accent:#66d69a;
      --accent-soft:#3a9f63;
      --card-border:rgba(148,163,184,0.25);

      /* Artefact intent colors */
      --C:#4CAF50;
      --I:#F44336;
      --K:#FFEB3B;
      --S:#2196F3;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    html{
      scrollbar-gutter: stable;
      overflow-y: scroll;
      scroll-behavior: smooth;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ opacity:0.9; }

    /* HEADER (shared) */
    header{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom:1px solid rgba(255,255,255,0.05);
      margin-bottom:20px;
    }

    .nav-inner{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .logo-wrap{ display:flex; align-items:center; gap:8px; }
    .logo-link{ display:inline-flex; align-items:center; gap:8px; }

    .logo-dot{
      width:24px; height:24px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.35);
      display:flex; align-items:center; justify-content:center;
      font-size:14px; line-height:1;
    }

    .logo-text{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.7;
    }

    .nav-links{
      display:flex;
      gap:22px;
      font-size:13px;
      opacity:0.85;
    }

    .nav-links a{ position:relative; }
    .nav-links a.active{ color:var(--accent); }

    .nav-links a.active::after{
      content:"";
      position:absolute;
      left:0;
      bottom:-4px;
      width:100%;
      height:2px;
      border-radius:999px;
      background:linear-gradient(to right,var(--accent),var(--accent-soft));
    }

    @media(max-width:900px){
      .nav-inner{ padding:0 16px; }
      .nav-links{
        font-size:12px;
        gap:14px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
    }

    /* PAGE */
    .page{
      max-width:1200px;
      margin:0 auto;
      padding:40px 24px 72px;
    }
    @media(max-width:900px){
      .page{ padding:32px 18px 56px; }
    }

    h1{
      font-size:40px;
      margin:0 0 10px 0;
      letter-spacing:-0.02em;
    }

    .lead{
      font-size:17px;
      opacity:0.85;
      line-height:1.65;
      margin-bottom:8px;
      max-width:920px;
    }

    .lead-small{
      font-size:14px;
      opacity:0.7;
      line-height:1.65;
      margin-top:4px;
      margin-bottom:22px;
      max-width:920px;
    }

    /* ====== LATEST MINTED (index vibe) ====== */
    .latest-wrap{
      width:100%;
      margin: 10px 0 18px;
    }

    .latest-frame{
      position:relative;
      width:100%;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.18);
      background: radial-gradient(circle at top, rgba(102,214,154,0.08), rgba(2,6,23,0.0) 62%);
      padding: 14px 16px;

      --mx: 50%;
      --my: 50%;
    }

    .latest-spot{
      pointer-events:none;
      position:absolute;
      inset:-45%;
      background:
        radial-gradient(
          220px 110px at var(--mx) var(--my),
          rgba(102,214,154,0.22),
          rgba(102,214,154,0.08) 38%,
          rgba(102,214,154,0.00) 70%
        );
      opacity:0;
      transition: opacity 160ms ease;
    }
    .latest-frame:hover .latest-spot{ opacity:1; }

    .latest-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }

    .latest-left{
      min-width: 240px;
    }

    .latest-label{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.72);
      opacity:0.85;
      margin-bottom:6px;
    }

    .latest-key{
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.01em;
      margin-bottom:4px;
    }

    .latest-sub{
      font-size:12px;
      color: var(--text-soft);
      opacity:0.85;
    }

    .latest-glyphs{
      flex: 1 1 auto;
      text-align:right;
      font-size:22px;
      letter-spacing:0.02em;
      opacity:0.86;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .latest-glyphs .dot{
      color: rgba(148,163,184,0.55);
      padding: 0 6px;
    }

    @media(max-width:900px){
      .latest-row{
        flex-direction:column;
        align-items:flex-start;
      }
      .latest-glyphs{
        width:100%;
        text-align:left;
        font-size:20px;
      }
    }

    /* ====== TOP LEGEND (like artefact) ====== */
    .intent-legend{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin: 6px 0 14px;
      user-select:none;
    }

    .intent-legend .title{
      font-size:13px;
      color:var(--text-soft);
      opacity:0.95;
    }

    .intent-legend .row{
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      font-size:14px;
      letter-spacing:0.02em;
    }

    .intent-legend .c{ color:var(--C); }
    .intent-legend .i{ color:var(--I); }
    .intent-legend .k{ color:var(--K); }
    .intent-legend .s{ color:var(--S); }

    /* ====== DONUT DASHBOARD ====== */
    .donut-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:16px;
      margin-bottom: 18px;
    }

    .donut-card{
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 14px 14px 16px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease;
    }

    .donut-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:18px;
      background: radial-gradient(circle at top, rgba(102,214,154,0.10), rgba(2,6,23,0) 62%);
      opacity:0.85;
    }

    .donut-card > *{ position:relative; }

    .donut-top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .donut-top .label{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.75);
      opacity:0.9;
    }

    .donut-top .sub{
      font-size:12px;
      color: var(--text-soft);
      white-space:nowrap;
    }

    .donut-mid{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 4px 0 2px;
    }

    .donut-svg{
      width: 150px;
      height: 150px;
      display:block;
    }

    .donut-center-win{
      font-size:20px;
      font-weight:800;
      letter-spacing:0.01em;
    }

    .donut-card:hover{
      transform: translateY(-2px);
      border-color: rgba(102,214,154,0.45);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.35),
        0 0 0 1px rgba(102,214,154,0.14),
        0 0 18px rgba(102,214,154,0.10);
    }

    /* ACTIVE donut clearly */
    .donut-card.active{
      border-color: rgba(102,214,154,0.85);
      box-shadow:
        0 10px 28px rgba(0,0,0,0.45),
        0 0 0 1px rgba(102,214,154,0.22),
        0 0 28px rgba(102,214,154,0.18);
      transform: translateY(-1px);
    }

    /* Mobile swipe */
    .donut-swipe{
      display:none;
      margin-bottom: 14px;
    }

    .swipe-track{
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding: 2px 2px 12px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .swipe-track::-webkit-scrollbar{ height:10px; }
    .swipe-track::-webkit-scrollbar-thumb{
      background: rgba(148,163,184,0.25);
      border-radius:999px;
    }
    .swipe-track::-webkit-scrollbar-track{
      background: rgba(255,255,255,0.03);
      border-radius:999px;
    }

    .donut-card.swipe{
      flex: 0 0 86%;
      scroll-snap-align: center;
    }

    .swipe-hint{
      font-size:12px;
      color: var(--text-soft);
      margin-top: 6px;
      opacity:0.9;
      text-align:center;
    }

    @media(max-width:900px){
      .donut-grid{ display:none; }
      .donut-swipe{ display:block; }
    }

    /* ====== FIELD CARDS (dynamic values; fixed labels/subtext) ====== */
    .field-cards{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:16px;
      width:100%;
    }

    .field-card{
      background:var(--card-bg);
      border-radius:16px;
      border:1px solid var(--card-border);
      padding:14px 14px 16px;
      font-size:13px;
      transition:
        border-color 220ms ease,
        box-shadow 220ms ease,
        transform 220ms ease,
        background-color 220ms ease;
      position:relative;
      overflow:hidden;
    }

    .field-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:16px;
      background: radial-gradient(circle at top, rgba(102,214,154,0.08), rgba(2,6,23,0.0) 62%);
      opacity:0.9;
    }
    .field-card > *{ position:relative; }

    .fc-label{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      opacity:0.55;
      margin-bottom:6px;
    }

    .fc-value{
      font-size:18px;
      font-weight:600;
      margin-bottom:4px;
    }

    .fc-sub{
      font-size:12px;
      opacity:0.75;
      line-height:1.55;
    }

    .field-card:hover{
      transform: translateY(-2px);
      border-color: rgba(102,214,154,0.35);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.30),
        0 0 18px rgba(102,214,154,0.10);
      background-color: rgba(2,6,23,0.92);
    }

    @media(max-width:900px){
      .field-cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media(max-width:600px){
      .field-cards{ grid-template-columns: 1fr; }
    }

    /* ====== FIELD SIGNAL ====== */
    .field-signal{
      margin-top: 18px;
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--card-border);
      padding: 18px;
      overflow:hidden;
      position:relative;
    }

    .field-signal::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:18px;
      background: radial-gradient(circle at top, rgba(102,214,154,0.10), rgba(2,6,23,0.0) 65%);
      opacity:0.9;
    }
    .field-signal > *{ position:relative; }

    .fs-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }

    .fs-title{
      font-size:13px;
      color: var(--text-soft);
      font-weight:600;
      letter-spacing:0.02em;
    }

    .fs-epoch{
      font-size:12px;
      color: rgba(255,255,255,0.75);
      opacity:0.9;
      border:1px solid rgba(148,163,184,0.22);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.02);
      white-space:nowrap;
    }

    .fs-quote{
      font-size:16px;
      line-height:1.65;
      opacity:0.95;
      max-width: 980px;
    }

    .fs-sub{
      margin-top: 10px;
      font-size:12px;
      color: var(--text-soft);
      opacity:0.85;
    }

    /* FOOTER */
    footer{
      border-top:1px solid rgba(255,255,255,0.05);
      padding:20px;
      font-size:12px;
      text-align:center;
      opacity:0.85;
    }

    footer .tagline{
      margin-bottom:6px;
      font-size:13px;
    }

    footer .links{
      display:flex;
      justify-content:center;
      gap:18px;
      font-size:13px;
    }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; }
      .donut-card, .field-card{ transition:none; }
      .latest-spot{ transition:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="nav-inner">
    <div class="logo-wrap">
      <a href="index.html" class="logo-link" aria-label="Z1N Protocol home">
        <div class="logo-dot">Ω</div>
        <div class="logo-text">Z1N PROTOCOL</div>
      </a>
    </div>

    <nav class="nav-links">
      <a href="about.html">About</a>
      <a href="live-stats.html" class="active">Live Stats</a>
      <a href="artefacts.html">Artefacts</a>
      <a href="nbi-artefacts.html">4 NBIs</a>
      <a href="mint-key.html">Mint your Key</a>
    </nav>
  </div>
</header>

<main class="page">
  <h1>Live stats of the field</h1>

  <p class="lead">
    Read the field through signals first — the numbers follow.
  </p>

  <p class="lead-small">
    Hover to preview. Click to lock. On mobile: swipe to shift the lens.
  </p>

  <!-- Latest minted header bar -->
  <section class="latest-wrap" aria-label="Latest minted Key">
    <div class="latest-frame" id="latestFrame">
      <div class="latest-spot" aria-hidden="true"></div>

      <div class="latest-row">
        <div class="latest-left">
          <div class="latest-label">Latest minted Key</div>
          <div class="latest-key" id="latestKey">Z1N #721</div>
          <div class="latest-sub" id="latestSub">Freshly awakened — placeholder until wired on-chain.</div>
        </div>

        <div class="latest-glyphs" id="latestGlyphs" aria-label="Latest glyph line">
          ↔ <span class="dot">·</span> ⟡ <span class="dot">·</span> ∴ <span class="dot">·</span> ◇ <span class="dot">·</span> ○ <span class="dot">·</span> ●
        </div>
      </div>
    </div>
  </section>

  <!-- Single legend like artefact -->
  <div class="intent-legend" aria-label="Intent legend">
    <div class="title">Intent mix across epochs</div>
    <div class="row">
      <span class="c">ΩC - Collective</span>
      <span class="i">ΩI - Individual</span>
      <span class="k">ΩK - Creative</span>
      <span class="s">ΩS - Silence</span>
    </div>
  </div>

  <!-- Desktop donuts -->
  <section class="donut-grid" aria-label="Intent mix donuts (desktop)">
    <article class="donut-card"
      data-key="last"
      data-window="Last epoch"
      data-sub="last completed breath"
      data-c="23" data-i="18" data-k="39" data-s="20"></article>

    <article class="donut-card"
      data-key="21"
      data-window="21 epochs"
      data-sub="short lens"
      data-c="15" data-i="22" data-k="44" data-s="19"></article>

    <article class="donut-card"
      data-key="210"
      data-window="210 epochs"
      data-sub="pattern lens"
      data-c="12" data-i="19" data-k="47" data-s="22"></article>

    <article class="donut-card"
      data-key="total"
      data-window="Total epochs"
      data-sub="field memory"
      data-c="7" data-i="14" data-k="51" data-s="28"></article>
  </section>

  <!-- Mobile swipe donuts -->
  <section class="donut-swipe" aria-label="Intent mix donuts (mobile swipe)">
    <div class="swipe-track" id="swipeTrack">
      <article class="donut-card swipe"
        data-key="last"
        data-window="Last epoch"
        data-sub="last completed breath"
        data-c="23" data-i="18" data-k="39" data-s="20"></article>

      <article class="donut-card swipe"
        data-key="21"
        data-window="21 epochs"
        data-sub="short lens"
        data-c="15" data-i="22" data-k="44" data-s="19"></article>

      <article class="donut-card swipe"
        data-key="210"
        data-window="210 epochs"
        data-sub="pattern lens"
        data-c="12" data-i="19" data-k="47" data-s="22"></article>

      <article class="donut-card swipe"
        data-key="total"
        data-window="Total epochs"
        data-sub="field memory"
        data-c="7" data-i="14" data-k="51" data-s="28"></article>
    </div>
    <div class="swipe-hint">Swipe → the lens updates automatically</div>
  </section>

  <!-- Dynamic values only (labels/subtext stay stable) -->
  <section class="field-cards" aria-label="Field cards">
    <div class="field-card">
      <div class="fc-label">Keys awakened</div>
      <div class="fc-value" id="vKeys">—</div>
      <div class="fc-sub">Number of minted soulbound identities.</div>
    </div>

    <div class="field-card">
      <div class="fc-label">PoG signals</div>
      <div class="fc-value" id="vSignals">—</div>
      <div class="fc-sub">Signals send to the Field.</div>
    </div>

    <div class="field-card">
      <div class="fc-label">% signals attested</div>
      <div class="fc-value" id="vAttested">—</div>
      <div class="fc-sub">Share of signals that received attestation.</div>
    </div>

    <div class="field-card">
      <div class="fc-label">Artefacts minted</div>
      <div class="fc-value" id="vArtefacts">—</div>
      <div class="fc-sub">Mirrors as a memory of presence.</div>
    </div>
  </section>

  <!-- Field signal -->
  <section class="field-signal" aria-label="Field PoG signal">
    <div class="fs-top">
      <div class="fs-title">Field Signal</div>
      <div class="fs-epoch" id="fsEpoch">Epoch —</div>
    </div>
    <div class="fs-quote" id="fsQuote">"—"</div>
    <div class="fs-sub" id="fsSub">Winning PoG signal: —</div>
  </section>

</main>

<footer>
  <div class="tagline">Your presence is real · The Field remembers</div>
  <div class="links">
    <a href="https://github.com/z1nprotocol" target="_blank" rel="noreferrer">GitHub</a>
    <a href="https://x.com/z1n_AI" target="_blank" rel="noreferrer">X</a>
  </div>
</footer>

<script>
  (function () {
    // ═══════════════════════════════════════════════════════════════════════════
    // CONFIGURATION - Change for different environments
    // ═══════════════════════════════════════════════════════════════════════════
    const API_BASE = "http://localhost:3002/api";  // Local dev
    // const API_BASE = "https://api.z1nprotocol.xyz/api";  // Production

    const COLORS = { C: "#4CAF50", I: "#F44336", K: "#FFEB3B", S: "#2196F3" };
    const ORDER = ["C","I","K","S"];
    const r = 51;
    const circumference = 2 * Math.PI * r;

    // Detect "desktop-like hover"
    const HAS_HOVER = window.matchMedia && window.matchMedia("(hover: hover)").matches;

    // ═══════════════════════════════════════════════════════════════════════════
    // LENS DATA - Will be populated from API, fallback to these defaults
    // ═══════════════════════════════════════════════════════════════════════════
    let LENS_DATA = {
      last: {
        cards: { keys: "7 842", signals: "1 284", attested: "37%", artefacts: "19" },
        signal: { epoch: 41, quote: "De ruimte waar ΩS ademt" }
      },
      "21": {
        cards: { keys: "7 842", signals: "8 420", attested: "41%", artefacts: "112" },
        signal: { epoch: 40, quote: "Waar ΩK bouwt, blijft ΩC nabij" }
      },
      "210": {
        cards: { keys: "7 842", signals: "14 220", attested: "46%", artefacts: "880" },
        signal: { epoch: 35, quote: "ΩI kijkt terug — en kiest opnieuw" }
      },
      total: {
        cards: { keys: "7 842", signals: "14 220", attested: "44%", artefacts: "1 842" },
        signal: { epoch: 175, quote: "De stilte tussen attesten is ook een stem" }
      }
    };

    // Latest minted - will be populated from API
    let LATEST = {
      key: "Z1N #721",
      glyphs: ["↔","⟡","∴","◇","○","●"],
      sub: "Freshly awakened — placeholder until wired on-chain."
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // API FETCH
    // ═══════════════════════════════════════════════════════════════════════════
    async function fetchFieldData() {
      try {
        const res = await fetch(`${API_BASE}/field`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error("Failed to fetch field data:", e);
        return null;
      }
    }

    function formatNumber(n) {
      if (n === undefined || n === null || n === "—") return "—";
      return n.toLocaleString("en-US").replace(/,/g, " ");
    }

    // Update LENS_DATA and LATEST from API response
    function updateDataFromAPI(data) {
      if (!data) return;

      // Per-lens stats from API
      const lensStats = data.lensStats || {};
      
      // Build cards data for each lens
      const buildCards = (stats) => ({
        keys: formatNumber(stats?.keys ?? 0),
        signals: formatNumber(stats?.signals ?? 0),
        attested: (stats?.attestedPercent ?? 0) + "%",
        artefacts: formatNumber(stats?.artefacts ?? 0)
      });
      
      // Build signal info for each lens
      const buildSignal = (stats, epochLabel) => {
        const mas = stats?.mas;
        if (mas) {
          return {
            epoch: epochLabel,
            quote: `Most attested: ${mas.intent} signal (weight: ${mas.weight})`
          };
        }
        return {
          epoch: epochLabel,
          quote: "No signals in this period"
        };
      };

      LENS_DATA = {
        last: { 
          cards: buildCards(lensStats.lastEpoch), 
          signal: buildSignal(lensStats.lastEpoch, data.lastClosedEpoch)
        },
        "21": { 
          cards: buildCards(lensStats.last21Epochs), 
          signal: buildSignal(lensStats.last21Epochs, `${data.lastClosedEpoch - 20}-${data.lastClosedEpoch}`)
        },
        "210": { 
          cards: buildCards(lensStats.last210Epochs), 
          signal: buildSignal(lensStats.last210Epochs, `${Math.max(0, data.lastClosedEpoch - 209)}-${data.lastClosedEpoch}`)
        },
        total: { 
          cards: buildCards(lensStats.total), 
          signal: buildSignal(lensStats.total, `0-${data.lastClosedEpoch}`)
        }
      };

      // Update latest key - API now returns clean glyph line
      if (data.latestKey) {
        const glyphLine = data.latestKey.glyphLine || "";
        LATEST = {
          key: `Z1N #${data.latestKey.tokenId}`,
          glyphs: glyphLine.split("").filter(g => g.trim()),
          sub: data.latestKey.isGenesis ? "Genesis Key" : "Standard Key"
        };
      }

      // Update donut data attributes from API intent distribution
      if (data.intentDistribution) {
        const mapping = {
          last: data.intentDistribution.lastEpoch,
          "21": data.intentDistribution.last21Epochs,
          "210": data.intentDistribution.last210Epochs,
          total: data.intentDistribution.total
        };

        document.querySelectorAll(".donut-card").forEach(card => {
          const key = card.getAttribute("data-key");
          const intentData = mapping[key];

          if (intentData) {
            card.setAttribute("data-c", intentData.ΩC || 0);
            card.setAttribute("data-i", intentData.ΩI || 0);
            card.setAttribute("data-k", intentData.ΩK || 0);
            card.setAttribute("data-s", intentData.ΩS || 0);
            renderDonutCard(card);
          }
        });
      }
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // RENDER FUNCTIONS (unchanged from original)
    // ═══════════════════════════════════════════════════════════════════════════

    function renderLatest(){
      const latestKey = document.getElementById("latestKey");
      const latestGlyphs = document.getElementById("latestGlyphs");
      const latestSub = document.getElementById("latestSub");
      if (latestKey) latestKey.textContent = LATEST.key;
      if (latestSub) latestSub.textContent = LATEST.sub;

      if (latestGlyphs){
        latestGlyphs.innerHTML = LATEST.glyphs
          .map((g, i) => i === 0 ? g : `<span class="dot">·</span> ${g}`)
          .join(" ");
      }
    }

    // Spotlight cursor on latest frame (same vibe as index)
    (function latestSpotlight(){
      const frame = document.getElementById("latestFrame");
      if (!frame) return;

      function setPos(e){
        const r = frame.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        const y = ((e.clientY - r.top) / r.height) * 100;
        frame.style.setProperty("--mx", x.toFixed(2) + "%");
        frame.style.setProperty("--my", y.toFixed(2) + "%");
      }

      frame.addEventListener("mousemove", setPos, { passive: true });
    })();

    // ====== Donut helpers ======
    function dominantKey(intents){
      const entries = Object.entries(intents).sort((a,b) => b[1]-a[1]);
      return { key: entries[0][0], pct: entries[0][1] };
    }

    function buildDonutSVG(intents){
      const sum = intents.C + intents.I + intents.K + intents.S;
      const safe = sum === 0 ? {C:25,I:25,K:25,S:25} : {
        C: (intents.C / sum) * 100,
        I: (intents.I / sum) * 100,
        K: (intents.K / sum) * 100,
        S: (intents.S / sum) * 100,
      };

      // Rounded for display, but keep donut continuous
      const win = dominantKey({
        C: Math.round(safe.C),
        I: Math.round(safe.I),
        K: Math.round(safe.K),
        S: Math.round(safe.S),
      });
      const winColor = COLORS[win.key];

      let offsetDeg = -90;
      const segments = ORDER.map((k) => {
        const pct = safe[k];
        const arc = (pct / 100) * circumference;
        const dasharray = `${arc.toFixed(1)} ${(circumference - arc).toFixed(1)}`;
        const seg = { key:k, dasharray, rotate: offsetDeg };
        offsetDeg += (pct / 100) * 360;
        return seg;
      });

      return `
        <svg class="donut-svg" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg" aria-label="Intent donut">
          <defs>
            <radialGradient id="donutBg" cx="50%" cy="40%" r="70%">
              <stop offset="0%" stop-color="#0b101b"/>
              <stop offset="100%" stop-color="#1c2534"/>
            </radialGradient>
          </defs>

          <circle cx="70" cy="70" r="62" fill="url(#donutBg)"></circle>
          <circle cx="70" cy="70" r="43" fill="#0f141f"></circle>

          <circle cx="70" cy="70" r="${r}"
                  fill="none" stroke="#252c3b" stroke-width="11"
                  transform="rotate(-90 70 70)"></circle>

          ${segments.map(s => `
            <circle cx="70" cy="70" r="${r}"
                    fill="none" stroke="${COLORS[s.key]}" stroke-width="11"
                    stroke-linecap="butt"
                    stroke-dasharray="${s.dasharray}"
                    transform="rotate(${s.rotate} 70 70)"></circle>
          `).join("")}

          <!-- Only winner intent + % (both in winner color) -->
          <text x="70" y="78" text-anchor="middle" class="donut-center-win" fill="${winColor}">
            Ω${win.key} ${win.pct}%
          </text>
        </svg>
      `;
    }

    function renderDonutCard(card){
      const windowLabel = card.getAttribute("data-window") || "Window";
      const sub = card.getAttribute("data-sub") || "";
      const intents = {
        C: Number(card.getAttribute("data-c") || 0),
        I: Number(card.getAttribute("data-i") || 0),
        K: Number(card.getAttribute("data-k") || 0),
        S: Number(card.getAttribute("data-s") || 0),
      };

      card.innerHTML = `
        <div class="donut-top">
          <div class="label">${windowLabel}</div>
          <div class="sub">${sub}</div>
        </div>
        <div class="donut-mid">
          ${buildDonutSVG(intents)}
        </div>
      `;
    }

    // ====== State: hover-preview vs locked ======
    let lockedKey = "last";     // default lock
    let activeKey = lockedKey;  // current view

    function getWinnerFromCardKey(lensKey){
      const card = document.querySelector(`.donut-card[data-key="${lensKey}"]`);
      if (!card) return { key:"C", pct:0 };
      const intents = {
        C: Number(card.getAttribute("data-c") || 0),
        I: Number(card.getAttribute("data-i") || 0),
        K: Number(card.getAttribute("data-k") || 0),
        S: Number(card.getAttribute("data-s") || 0),
      };
      const sum = intents.C + intents.I + intents.K + intents.S || 1;
      const rounded = {
        C: Math.round((intents.C/sum)*100),
        I: Math.round((intents.I/sum)*100),
        K: Math.round((intents.K/sum)*100),
        S: Math.round((intents.S/sum)*100),
      };
      return dominantKey(rounded);
    }

    function setActiveLens(lensKey, opts){
      const { lock=false } = opts || {};
      if (lock) lockedKey = lensKey;
      activeKey = lensKey;

      // active class on ALL donuts with same data-key
      document.querySelectorAll(".donut-card").forEach(el => {
        el.classList.toggle("active", el.getAttribute("data-key") === lensKey);
      });

      const data = LENS_DATA[lensKey] || LENS_DATA.total;
      document.getElementById("vKeys").textContent = data.cards.keys;
      document.getElementById("vSignals").textContent = data.cards.signals;
      document.getElementById("vAttested").textContent = data.cards.attested;
      document.getElementById("vArtefacts").textContent = data.cards.artefacts;

      // Field signal
      document.getElementById("fsEpoch").textContent = "Epoch " + data.signal.epoch;
      document.getElementById("fsQuote").textContent = `"${data.signal.quote}"`;

      const win = getWinnerFromCardKey(lensKey);
      document.getElementById("fsSub").textContent = `Winning PoG signal: Ω${win.key}`;
    }

    // ====== Desktop hover-preview + click lock ======
    function wireDesktopBehavior(){
      const cards = Array.from(document.querySelectorAll(".donut-grid .donut-card"));

      cards.forEach(card => {
        const key = card.getAttribute("data-key") || "total";

        card.addEventListener("mouseenter", () => {
          setActiveLens(key, { lock:false });
        });

        card.addEventListener("mouseleave", () => {
          setActiveLens(lockedKey, { lock:false });
        });

        card.addEventListener("click", () => {
          setActiveLens(key, { lock:true });
        });
      });
    }

    // ====== Mobile swipe auto-select ======
    function wireMobileSwipeAutoSelect(){
      const track = document.getElementById("swipeTrack");
      if (!track) return;

      const swipeCards = Array.from(track.querySelectorAll(".donut-card.swipe"));
      if (!swipeCards.length) return;

      swipeCards.forEach(card => {
        const key = card.getAttribute("data-key") || "total";
        card.addEventListener("click", () => setActiveLens(key, { lock:true }));
      });

      const io = new IntersectionObserver((entries) => {
        let best = null;
        for (const e of entries){
          if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
        }
        if (best && best.isIntersecting){
          const key = best.target.getAttribute("data-key") || "total";
          setActiveLens(key, { lock:false });
        }
      }, {
        root: track,
        threshold: [0.35, 0.5, 0.65, 0.8]
      });

      swipeCards.forEach(c => io.observe(c));

      if (window.matchMedia && window.matchMedia("(max-width: 900px)").matches) {
        const first = swipeCards.find(c => (c.getAttribute("data-key") || "") === "last") || swipeCards[0];
        first.scrollIntoView({ behavior: "instant", inline: "center", block: "nearest" });
      }
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // INITIALIZE
    // ═══════════════════════════════════════════════════════════════════════════

    async function init() {
      // Render all donut card HTML first with default data
      document.querySelectorAll(".donut-card").forEach(card => renderDonutCard(card));

      // Latest minted (with default)
      renderLatest();

      // Default landing: LAST epoch locked
      setActiveLens("last", { lock:true });

      if (HAS_HOVER){
        wireDesktopBehavior();
      }
      wireMobileSwipeAutoSelect();

      // Fetch real data from API
      const apiData = await fetchFieldData();
      if (apiData) {
        updateDataFromAPI(apiData);
        renderLatest();
        setActiveLens(lockedKey, { lock: true }); // Re-render with new data
      }

      // Auto-refresh every 30 seconds
      setInterval(async () => {
        const newData = await fetchFieldData();
        if (newData) {
          updateDataFromAPI(newData);
          renderLatest();
          setActiveLens(activeKey, { lock: false }); // Update current view
        }
      }, 30000);
    }

    init();
  })();
</script>

</body>
</html>
