<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Z1N Protocol – Live Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#050812;
      --card-bg:#020617;
      --text-main:#ffffff;
      --text-soft:#8f9ab5;
      --accent:#66d69a;
      --accent-soft:#3a9f63;
      --card-border:rgba(148,163,184,0.25);

      /* Artefact intent colors */
      --C:#4CAF50;
      --I:#F44336;
      --K:#FFEB3B;
      --S:#2196F3;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    html{
      scrollbar-gutter: stable;
      overflow-y: scroll;
      scroll-behavior: smooth;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ opacity:0.9; }

    /* HEADER (shared) */
    header{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom:1px solid rgba(255,255,255,0.05);
      margin-bottom:20px;
    }

    .nav-inner{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .logo-wrap{ display:flex; align-items:center; gap:8px; }
    .logo-link{ display:inline-flex; align-items:center; gap:8px; }

    .logo-dot{
      width:24px; height:24px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.35);
      display:flex; align-items:center; justify-content:center;
      font-size:14px; line-height:1;
    }

    .logo-text{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.7;
    }

    .nav-links{
      display:flex;
      gap:22px;
      font-size:13px;
      opacity:0.85;
    }

    .nav-links a{ position:relative; }
    .nav-links a.active{ color:var(--accent); }

    .nav-links a.active::after{
      content:"";
      position:absolute;
      left:0;
      bottom:-4px;
      width:100%;
      height:2px;
      border-radius:999px;
      background:linear-gradient(to right,var(--accent),var(--accent-soft));
    }

    @media(max-width:900px){
      .nav-inner{ padding:0 16px; }
      .nav-links{
        font-size:12px;
        gap:14px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
    }

    /* PAGE */
    .page{
      max-width:1200px;
      margin:0 auto;
      padding:40px 24px 72px;
    }
    @media(max-width:900px){
      .page{ padding:32px 18px 56px; }
    }

    h1{
      font-size:40px;
      margin:0 0 10px 0;
      letter-spacing:-0.02em;
    }

    .lead{
      font-size:17px;
      opacity:0.85;
      line-height:1.65;
      margin-bottom:8px;
      max-width:920px;
    }

    .lead-small{
      font-size:14px;
      opacity:0.7;
      line-height:1.65;
      margin-top:4px;
      margin-bottom:22px;
      max-width:920px;
    }

    /* ====== LATEST MINTED (index vibe) ====== */
    .latest-wrap{
      width:100%;
      margin: 10px 0 18px;
    }

    .latest-frame{
      position:relative;
      width:100%;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.18);
      background: radial-gradient(circle at top, rgba(102,214,154,0.08), rgba(2,6,23,0.0) 62%);
      padding: 14px 16px;

      --mx: 50%;
      --my: 50%;
    }

    .latest-spot{
      pointer-events:none;
      position:absolute;
      inset:-45%;
      background:
        radial-gradient(
          220px 110px at var(--mx) var(--my),
          rgba(102,214,154,0.22),
          rgba(102,214,154,0.08) 38%,
          rgba(102,214,154,0.00) 70%
        );
      opacity:0;
      transition: opacity 160ms ease;
    }
    .latest-frame:hover .latest-spot{ opacity:1; }

    .latest-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }

    .latest-left{
      min-width: 240px;
    }

    .latest-label{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.72);
      opacity:0.85;
      margin-bottom:6px;
    }

    .latest-key{
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.01em;
      margin-bottom:4px;
    }

    .latest-sub{
      font-size:12px;
      color: var(--text-soft);
      opacity:0.85;
    }

    .latest-glyphs{
      flex: 1 1 auto;
      text-align:right;
      font-size:22px;
      letter-spacing:0.02em;
      opacity:0.86;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .latest-glyphs .dot{
      color: rgba(148,163,184,0.55);
      padding: 0 6px;
    }

    @media(max-width:900px){
      .latest-row{
        flex-direction:column;
        align-items:flex-start;
      }
      .latest-glyphs{
        width:100%;
        text-align:left;
        font-size:20px;
      }
    }

    /* ====== TOP LEGEND (like artefact) ====== */
    .intent-legend{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin: 6px 0 14px;
      user-select:none;
    }

    .intent-legend .title{
      font-size:13px;
      color:var(--text-soft);
      opacity:0.95;
    }

    .intent-legend .row{
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      font-size:14px;
      letter-spacing:0.02em;
    }

    .intent-legend .c{ color:var(--C); }
    .intent-legend .i{ color:var(--I); }
    .intent-legend .k{ color:var(--K); }
    .intent-legend .s{ color:var(--S); }

    /* ====== DONUT DASHBOARD ====== */
    .donut-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:16px;
      margin-bottom: 18px;
    }

    .donut-card{
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 14px 14px 16px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease;
    }

    .donut-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:18px;
      background: radial-gradient(circle at top, rgba(102,214,154,0.10), rgba(2,6,23,0) 62%);
      opacity:0.85;
    }

    .donut-card > *{ position:relative; }

    .donut-top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .donut-top .label{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.75);
      opacity:0.9;
    }

    .donut-top .sub{
      font-size:12px;
      color: var(--text-soft);
      white-space:nowrap;
    }

    .donut-mid{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 4px 0 2px;
    }

    .donut-svg{
      width: 150px;
      height: 150px;
      display:block;
    }

    .donut-center-win{
      font-size:20px;
      font-weight:800;
      letter-spacing:0.01em;
    }

    .donut-card:hover{
      transform: translateY(-2px);
      border-color: rgba(102,214,154,0.45);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.35),
        0 0 0 1px rgba(102,214,154,0.14),
        0 0 18px rgba(102,214,154,0.10);
    }

    /* ACTIVE donut clearly */
    .donut-card.active{
      border-color: rgba(102,214,154,0.85);
      box-shadow:
        0 10px 28px rgba(0,0,0,0.45),
        0 0 0 1px rgba(102,214,154,0.22),
        0 0 28px rgba(102,214,154,0.18);
      transform: translateY(-1px);
    }

    /* Mobile swipe */
    .donut-swipe{
      display:none;
      margin-bottom: 14px;
    }

    .swipe-track{
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding: 2px 2px 12px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .swipe-track::-webkit-scrollbar{ height:10px; }
    .swipe-track::-webkit-scrollbar-thumb{
      background: rgba(148,163,184,0.25);
      border-radius:999px;
    }
    .swipe-track::-webkit-scrollbar-track{
      background: rgba(255,255,255,0.03);
      border-radius:999px;
    }

    .donut-card.swipe{
      flex: 0 0 86%;
      scroll-snap-align: center;
    }

    .swipe-hint{
      font-size:12px;
      color: var(--text-soft);
      margin-top: 6px;
      opacity:0.9;
      text-align:center;
    }

    @media(max-width:900px){
      .donut-grid{ display:none; }
      .donut-swipe{ display:block; }
    }

    /* ====== FIELD CARDS (dynamic values; fixed labels/subtext) ====== */
    .field-cards{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:16px;
      width:100%;
    }

    .field-card{
      background:var(--card-bg);
      border-radius:16px;
      border:1px solid var(--card-border);
      padding:14px 14px 16px;
      font-size:13px;
      transition:
        border-color 220ms ease,
        box-shadow 220ms ease,
        transform 220ms ease,
        background-color 220ms ease;
      position:relative;
      overflow:hidden;
    }

    .field-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:16px;
      background: radial-gradient(circle at top, rgba(102,214,154,0.08), rgba(2,6,23,0.0) 62%);
      opacity:0.9;
    }
    .field-card > *{ position:relative; }

    .fc-label{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      opacity:0.55;
      margin-bottom:6px;
    }

    .fc-value{
      font-size:18px;
      font-weight:600;
      margin-bottom:4px;
    }

    .fc-sub{
      font-size:12px;
      opacity:0.75;
      line-height:1.55;
    }

    .field-card:hover{
      transform: translateY(-2px);
      border-color: rgba(102,214,154,0.35);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.30),
        0 0 18px rgba(102,214,154,0.10);
      background-color: rgba(2,6,23,0.92);
    }

    @media(max-width:900px){
      .field-cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media(max-width:600px){
      .field-cards{ grid-template-columns: 1fr; }
    }

    /* ====== FIELD SIGNAL ====== */
    .field-signal{
      margin-top: 18px;
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--card-border);
      padding: 18px;
      overflow:hidden;
      position:relative;
    }

    .field-signal::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:18px;
      background: radial-gradient(circle at top, rgba(102,214,154,0.10), rgba(2,6,23,0.0) 65%);
      opacity:0.9;
    }
    .field-signal > *{ position:relative; }

    .fs-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }

    .fs-title{
      font-size:13px;
      color: var(--text-soft);
      font-weight:600;
      letter-spacing:0.02em;
    }

    .fs-epoch{
      font-size:12px;
      color: rgba(255,255,255,0.75);
      opacity:0.9;
      border:1px solid rgba(148,163,184,0.22);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.02);
      white-space:nowrap;
    }

    .fs-quote{
      font-size:16px;
      line-height:1.65;
      opacity:0.95;
      max-width: 980px;
    }

    .fs-sub{
      margin-top: 10px;
      font-size:12px;
      color: var(--text-soft);
      opacity:0.85;
    }

    /* Loading state */
    .loading {
      opacity: 0.5;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    /* FOOTER */
    footer{
      border-top:1px solid rgba(255,255,255,0.05);
      padding:20px;
      font-size:12px;
      text-align:center;
      opacity:0.85;
    }

    footer .tagline{
      margin-bottom:6px;
      font-size:13px;
    }

    footer .links{
      display:flex;
      justify-content:center;
      gap:18px;
      font-size:13px;
    }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; }
      .donut-card, .field-card{ transition:none; }
      .latest-spot{ transition:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="nav-inner">
    <div class="logo-wrap">
      <a href="index.html" class="logo-link" aria-label="Z1N Protocol home">
        <div class="logo-dot">Ω</div>
        <div class="logo-text">Z1N PROTOCOL</div>
      </a>
    </div>

    <nav class="nav-links">
      <a href="about.html">About</a>
      <a href="live-stats.html" class="active">Live Stats</a>
      <a href="artefacts.html">Artefacts</a>
      <a href="nbi-artefacts.html">4 NBIs</a>
      <a href="mint-key.html">Mint your Key</a>
    </nav>
  </div>
</header>

<main class="page">
  <h1>Live stats of the field</h1>

  <p class="lead">
    Read the field through signals first — the numbers follow.
  </p>

  <p class="lead-small">
    Hover to preview. Click to lock. On mobile: swipe to shift the lens.
  </p>

  <!-- Latest minted header bar -->
  <section class="latest-wrap" aria-label="Latest minted Key">
    <div class="latest-frame" id="latestFrame">
      <div class="latest-spot" aria-hidden="true"></div>

      <div class="latest-row">
        <div class="latest-left">
          <div class="latest-label">Latest minted Key</div>
          <div class="latest-key" id="latestKey">Z1N #—</div>
          <div class="latest-sub" id="latestSub">Loading...</div>
        </div>

        <div class="latest-glyphs" id="latestGlyphs" aria-label="Latest glyph line">
          ◇ <span class="dot">·</span> ○ <span class="dot">·</span> ●
        </div>
      </div>
    </div>
  </section>

  <!-- Single legend like artefact -->
  <div class="intent-legend" aria-label="Intent legend">
    <div class="title">Intent mix across epochs</div>
    <div class="row">
      <span class="c">ΩC - Collective</span>
      <span class="i">ΩI - Individual</span>
      <span class="k">ΩK - Creative</span>
      <span class="s">ΩS - Silence</span>
    </div>
  </div>

  <!-- Desktop donuts -->
  <section class="donut-grid" aria-label="Intent mix donuts (desktop)">
    <article class="donut-card"
      data-key="last"
      data-window="Last epoch"
      data-sub="last completed breath"
      data-c="25" data-i="25" data-k="25" data-s="25"></article>

    <article class="donut-card"
      data-key="21"
      data-window="21 epochs"
      data-sub="short lens"
      data-c="25" data-i="25" data-k="25" data-s="25"></article>

    <article class="donut-card"
      data-key="210"
      data-window="210 epochs"
      data-sub="pattern lens"
      data-c="25" data-i="25" data-k="25" data-s="25"></article>

    <article class="donut-card"
      data-key="total"
      data-window="Total epochs"
      data-sub="field memory"
      data-c="25" data-i="25" data-k="25" data-s="25"></article>
  </section>

  <!-- Mobile swipe donuts -->
  <section class="donut-swipe" aria-label="Intent mix donuts (mobile swipe)">
    <div class="swipe-track" id="swipeTrack">
      <article class="donut-card swipe"
        data-key="last"
        data-window="Last epoch"
        data-sub="last completed breath"
        data-c="25" data-i="25" data-k="25" data-s="25"></article>

      <article class="donut-card swipe"
        data-key="21"
        data-window="21 epochs"
        data-sub="short lens"
        data-c="25" data-i="25" data-k="25" data-s="25"></article>

      <article class="donut-card swipe"
        data-key="210"
        data-window="210 epochs"
        data-sub="pattern lens"
        data-c="25" data-i="25" data-k="25" data-s="25"></article>

      <article class="donut-card swipe"
        data-key="total"
        data-window="Total epochs"
        data-sub="field memory"
        data-c="25" data-i="25" data-k="25" data-s="25"></article>
    </div>
    <div class="swipe-hint">Swipe → the lens updates automatically</div>
  </section>

  <!-- Dynamic values only (labels/subtext stay stable) -->
  <section class="field-cards" aria-label="Field cards">
    <div class="field-card">
      <div class="fc-label">Keys awakened</div>
      <div class="fc-value" id="vKeys">—</div>
      <div class="fc-sub">Number of minted soulbound identities.</div>
    </div>

    <div class="field-card">
      <div class="fc-label">PoG signals</div>
      <div class="fc-value" id="vSignals">—</div>
      <div class="fc-sub">Signals sent to the Field.</div>
    </div>

    <div class="field-card">
      <div class="fc-label">Attestations</div>
      <div class="fc-value" id="vAttestations">—</div>
      <div class="fc-sub">Peer validations of signals.</div>
    </div>

    <div class="field-card">
      <div class="fc-label">Treasury</div>
      <div class="fc-value" id="vTreasury">—</div>
      <div class="fc-sub">POL in the reward pool.</div>
    </div>
  </section>

  <!-- Field signal -->
  <section class="field-signal" aria-label="Field PoG signal">
    <div class="fs-top">
      <div class="fs-title">Current Epoch</div>
      <div class="fs-epoch" id="fsEpoch">Epoch —</div>
    </div>
    <div class="fs-quote" id="fsQuote">"The field is listening..."</div>
    <div class="fs-sub" id="fsSub">Epochs closed: — | Last closed: —</div>
  </section>

</main>

<footer>
  <div class="tagline">Your presence is real · The Field remembers</div>
  <div class="links">
    <a href="https://github.com/z1nprotocol" target="_blank" rel="noreferrer">GitHub</a>
    <a href="https://x.com/z1n_AI" target="_blank" rel="noreferrer">X</a>
  </div>
</footer>

<script>
(function () {
  // ═══════════════════════════════════════════════════════════════════════════
  // CONFIGURATION - Change this for different environments
  // ═══════════════════════════════════════════════════════════════════════════
  const API_BASE = "http://localhost:3002/api";  // Local dev
  // const API_BASE = "https://api.z1nprotocol.xyz/api";  // Production
  
  const COLORS = { C: "#4CAF50", I: "#F44336", K: "#FFEB3B", S: "#2196F3" };
  const ORDER = ["C","I","K","S"];
  const r = 51;
  const circumference = 2 * Math.PI * r;

  // Detect "desktop-like hover"
  const HAS_HOVER = window.matchMedia && window.matchMedia("(hover: hover)").matches;

  // ═══════════════════════════════════════════════════════════════════════════
  // STATE
  // ═══════════════════════════════════════════════════════════════════════════
  let fieldData = null;
  let lockedKey = "last";
  let activeKey = lockedKey;

  // ═══════════════════════════════════════════════════════════════════════════
  // API FETCH
  // ═══════════════════════════════════════════════════════════════════════════
  async function fetchFieldData() {
    try {
      const res = await fetch(`${API_BASE}/field`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (e) {
      console.error("Failed to fetch field data:", e);
      return null;
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // RENDER FUNCTIONS
  // ═══════════════════════════════════════════════════════════════════════════
  
  function formatNumber(n) {
    if (n === undefined || n === null) return "—";
    return n.toLocaleString("en-US").replace(/,/g, " ");
  }

  function renderLatest(data) {
    const latestKey = document.getElementById("latestKey");
    const latestGlyphs = document.getElementById("latestGlyphs");
    const latestSub = document.getElementById("latestSub");

    if (!data || !data.latestKey) {
      if (latestKey) latestKey.textContent = "Z1N #—";
      if (latestSub) latestSub.textContent = "No keys minted yet";
      return;
    }

    const key = data.latestKey;
    if (latestKey) latestKey.textContent = `Z1N #${key.tokenId}`;
    if (latestSub) latestSub.textContent = key.isGenesis ? "Genesis Key" : "Standard Key";

    if (latestGlyphs && key.glyphLine) {
      const glyphs = key.glyphLine.split("");
      latestGlyphs.innerHTML = glyphs
        .filter(g => g.trim())
        .map((g, i) => i === 0 ? g : `<span class="dot">·</span> ${g}`)
        .join(" ");
    }
  }

  function renderFieldCards(data) {
    if (!data) return;

    const vKeys = document.getElementById("vKeys");
    const vSignals = document.getElementById("vSignals");
    const vAttestations = document.getElementById("vAttestations");
    const vTreasury = document.getElementById("vTreasury");

    if (vKeys) vKeys.textContent = formatNumber(data.totalKeys);
    if (vSignals) vSignals.textContent = formatNumber(data.totalSignals);
    if (vAttestations) vAttestations.textContent = formatNumber(data.totalAttestations);
    if (vTreasury) vTreasury.textContent = `${data.treasuryBalancePOL} POL`;
  }

  function renderFieldSignal(data) {
    if (!data) return;

    const fsEpoch = document.getElementById("fsEpoch");
    const fsQuote = document.getElementById("fsQuote");
    const fsSub = document.getElementById("fsSub");

    if (fsEpoch) fsEpoch.textContent = `Epoch ${data.currentEpoch}`;
    
    // Calculate dominant intent from total distribution
    const dist = data.intentDistribution?.total || { ΩC: 25, ΩI: 25, ΩK: 25, ΩS: 25 };
    const dominant = Object.entries(dist).sort((a, b) => b[1] - a[1])[0];
    
    if (fsQuote) {
      const quotes = {
        "ΩC": "The collective breathes as one",
        "ΩI": "Individual voices shape the field",
        "ΩK": "Co-creation weaves new patterns",
        "ΩS": "In silence, the field listens"
      };
      fsQuote.textContent = `"${quotes[dominant[0]] || "The field is listening..."}"`;
    }

    if (fsSub) {
      fsSub.textContent = `Epochs closed: ${data.lastClosedEpoch + 1} | Dominant: ${dominant[0]} (${dominant[1]}%)`;
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // DONUT HELPERS
  // ═══════════════════════════════════════════════════════════════════════════
  
  function dominantKey(intents) {
    const entries = Object.entries(intents).sort((a, b) => b[1] - a[1]);
    return { key: entries[0][0], pct: entries[0][1] };
  }

  function buildDonutSVG(intents) {
    const sum = intents.C + intents.I + intents.K + intents.S;
    const safe = sum === 0 ? { C: 25, I: 25, K: 25, S: 25 } : {
      C: (intents.C / sum) * 100,
      I: (intents.I / sum) * 100,
      K: (intents.K / sum) * 100,
      S: (intents.S / sum) * 100,
    };

    const win = dominantKey({
      C: Math.round(safe.C),
      I: Math.round(safe.I),
      K: Math.round(safe.K),
      S: Math.round(safe.S),
    });
    const winColor = COLORS[win.key];

    let offsetDeg = -90;
    const segments = ORDER.map((k) => {
      const pct = safe[k];
      const arc = (pct / 100) * circumference;
      const dasharray = `${arc.toFixed(1)} ${(circumference - arc).toFixed(1)}`;
      const seg = { key: k, dasharray, rotate: offsetDeg };
      offsetDeg += (pct / 100) * 360;
      return seg;
    });

    return `
      <svg class="donut-svg" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg" aria-label="Intent donut">
        <defs>
          <radialGradient id="donutBg" cx="50%" cy="40%" r="70%">
            <stop offset="0%" stop-color="#0b101b"/>
            <stop offset="100%" stop-color="#1c2534"/>
          </radialGradient>
        </defs>

        <circle cx="70" cy="70" r="62" fill="url(#donutBg)"></circle>
        <circle cx="70" cy="70" r="43" fill="#0f141f"></circle>

        <circle cx="70" cy="70" r="${r}"
                fill="none" stroke="#252c3b" stroke-width="11"
                transform="rotate(-90 70 70)"></circle>

        ${segments.map(s => `
          <circle cx="70" cy="70" r="${r}"
                  fill="none" stroke="${COLORS[s.key]}" stroke-width="11"
                  stroke-linecap="butt"
                  stroke-dasharray="${s.dasharray}"
                  transform="rotate(${s.rotate} 70 70)"></circle>
        `).join("")}

        <text x="70" y="78" text-anchor="middle" class="donut-center-win" fill="${winColor}">
          Ω${win.key} ${win.pct}%
        </text>
      </svg>
    `;
  }

  function renderDonutCard(card) {
    const windowLabel = card.getAttribute("data-window") || "Window";
    const sub = card.getAttribute("data-sub") || "";
    const intents = {
      C: Number(card.getAttribute("data-c") || 0),
      I: Number(card.getAttribute("data-i") || 0),
      K: Number(card.getAttribute("data-k") || 0),
      S: Number(card.getAttribute("data-s") || 0),
    };

    card.innerHTML = `
      <div class="donut-top">
        <div class="label">${windowLabel}</div>
        <div class="sub">${sub}</div>
      </div>
      <div class="donut-mid">
        ${buildDonutSVG(intents)}
      </div>
    `;
  }

  function updateDonutData(data) {
    if (!data || !data.intentDistribution) return;

    const dist = data.intentDistribution;

    // Map API data to donut cards
    const mapping = {
      last: dist.lastEpoch,
      "21": dist.last21Epochs,
      "210": dist.last210Epochs,
      total: dist.total
    };

    document.querySelectorAll(".donut-card").forEach(card => {
      const key = card.getAttribute("data-key");
      const intentData = mapping[key];

      if (intentData) {
        card.setAttribute("data-c", intentData.ΩC || 0);
        card.setAttribute("data-i", intentData.ΩI || 0);
        card.setAttribute("data-k", intentData.ΩK || 0);
        card.setAttribute("data-s", intentData.ΩS || 0);
        renderDonutCard(card);
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // LENS STATE MANAGEMENT
  // ═══════════════════════════════════════════════════════════════════════════
  
  function setActiveLens(lensKey, opts) {
    const { lock = false } = opts || {};
    if (lock) lockedKey = lensKey;
    activeKey = lensKey;

    document.querySelectorAll(".donut-card").forEach(el => {
      el.classList.toggle("active", el.getAttribute("data-key") === lensKey);
    });
  }

  function wireDesktopBehavior() {
    const cards = Array.from(document.querySelectorAll(".donut-grid .donut-card"));

    cards.forEach(card => {
      const key = card.getAttribute("data-key") || "total";

      card.addEventListener("mouseenter", () => {
        setActiveLens(key, { lock: false });
      });

      card.addEventListener("mouseleave", () => {
        setActiveLens(lockedKey, { lock: false });
      });

      card.addEventListener("click", () => {
        setActiveLens(key, { lock: true });
      });
    });
  }

  function wireMobileSwipeAutoSelect() {
    const track = document.getElementById("swipeTrack");
    if (!track) return;

    const swipeCards = Array.from(track.querySelectorAll(".donut-card.swipe"));
    if (!swipeCards.length) return;

    swipeCards.forEach(card => {
      const key = card.getAttribute("data-key") || "total";
      card.addEventListener("click", () => setActiveLens(key, { lock: true }));
    });

    const io = new IntersectionObserver((entries) => {
      let best = null;
      for (const e of entries) {
        if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if (best && best.isIntersecting) {
        const key = best.target.getAttribute("data-key") || "total";
        setActiveLens(key, { lock: false });
      }
    }, {
      root: track,
      threshold: [0.35, 0.5, 0.65, 0.8]
    });

    swipeCards.forEach(c => io.observe(c));

    if (window.matchMedia && window.matchMedia("(max-width: 900px)").matches) {
      const first = swipeCards.find(c => (c.getAttribute("data-key") || "") === "last") || swipeCards[0];
      first.scrollIntoView({ behavior: "instant", inline: "center", block: "nearest" });
    }
  }

  // Spotlight cursor on latest frame
  (function latestSpotlight() {
    const frame = document.getElementById("latestFrame");
    if (!frame) return;

    function setPos(e) {
      const r = frame.getBoundingClientRect();
      const x = ((e.clientX - r.left) / r.width) * 100;
      const y = ((e.clientY - r.top) / r.height) * 100;
      frame.style.setProperty("--mx", x.toFixed(2) + "%");
      frame.style.setProperty("--my", y.toFixed(2) + "%");
    }

    frame.addEventListener("mousemove", setPos, { passive: true });
  })();

  // ═══════════════════════════════════════════════════════════════════════════
  // INITIALIZE
  // ═══════════════════════════════════════════════════════════════════════════
  
  async function init() {
    // Render initial donuts with placeholder data
    document.querySelectorAll(".donut-card").forEach(card => renderDonutCard(card));
    setActiveLens("last", { lock: true });

    if (HAS_HOVER) {
      wireDesktopBehavior();
    }
    wireMobileSwipeAutoSelect();

    // Fetch real data
    fieldData = await fetchFieldData();

    if (fieldData) {
      renderLatest(fieldData);
      renderFieldCards(fieldData);
      renderFieldSignal(fieldData);
      updateDonutData(fieldData);
    }

    // Auto-refresh every 30 seconds
    setInterval(async () => {
      const newData = await fetchFieldData();
      if (newData) {
        fieldData = newData;
        renderLatest(fieldData);
        renderFieldCards(fieldData);
        renderFieldSignal(fieldData);
        updateDonutData(fieldData);
      }
    }, 30000);
  }

  init();
})();
</script>

</body>
</html>
