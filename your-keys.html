<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Z1N Protocol – Your Keys</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#050812;
      --card-bg:#020617;
      --text-main:#ffffff;
      --text-soft:#9aa3bb;
      --accent:#66d69a;
      --card-border: rgba(148,163,184,0.25);
      --keys-accent:#f5c842;
      --danger: #e05555;
      --treasury-blue: #60a5fa;
      --canon-purple: #c084fc;
      --claim-green: #4ade80;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html{ scrollbar-gutter: stable; overflow-y: scroll; }
    body{ background:var(--bg); color:var(--text-main); font-family:system-ui,-apple-system,"Segoe UI",sans-serif; }
    a{ color:inherit; text-decoration:none; }

    header{ height:72px; display:flex; align-items:center; justify-content:center; border-bottom:1px solid rgba(255,255,255,0.05); margin-bottom:20px; }
    .nav-inner{ width:100%; max-width:1200px; margin:0 auto; padding:0 24px; display:flex; align-items:center; justify-content:space-between; }
    .logo-link{ display:inline-flex; align-items:center; gap:8px; }
    .logo-dot{ width:24px; height:24px; border-radius:999px; border:1px solid rgba(255,255,255,0.35); display:flex; align-items:center; justify-content:center; font-size:14px; }
    .logo-text{ font-size:11px; letter-spacing:0.18em; text-transform:uppercase; opacity:0.7; }
    .nav-links{ display:flex; gap:22px; font-size:13px; opacity:0.85; }
    .nav-links a.active-keys{ color:var(--keys-accent); }

    .page{ max-width:1200px; margin:0 auto; padding:40px 24px 72px; }
    h1{ font-size:40px; letter-spacing:-0.02em; margin:0 0 10px 0; color: var(--keys-accent); }
    .lead{ font-size:17px; line-height:1.6; opacity:0.85; max-width:900px; margin-bottom:6px; }
    .lead-small{ font-size:14px; line-height:1.6; opacity:0.7; max-width:900px; margin-bottom:18px; }

    .mode-row{ display:flex; gap:12px; margin-top:55px; margin-bottom:22px; flex-wrap:wrap; }
    .mode-btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 16px; border-radius:999px; border:1px solid rgba(148,163,184,0.5); background:transparent; color:#e5e7eb; font-size:14px; cursor:pointer; transition:all 180ms ease; }
    .mode-btn:hover{ border-color:var(--keys-accent); }
    .mode-btn.active{ background:rgba(245,200,66,0.2); border-color:var(--keys-accent); color:var(--keys-accent); }

    footer{ border-top:1px solid rgba(255,255,255,0.05); padding:20px; font-size:12px; text-align:center; opacity:0.85; margin-top:40px; }

    /* WALLETS SECTION */
    .wallets-section { margin: 20px 0; padding: 16px; background: rgba(15, 23, 42, 0.3); border: 1px solid var(--card-border); border-radius: 12px; }
    .wallets-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .wallets-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-soft); }
    .wallets-count { font-size: 11px; color: var(--text-soft); }
    .wallets-grid { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-start; }
    .wallet-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; border-radius: 8px; font-size: 12px; cursor: default; transition: all 0.2s; }
    .wallet-chip .wallet-dot { width: 10px; height: 10px; border-radius: 50%; }
    .wallet-chip .wallet-info { display: flex; flex-direction: column; gap: 2px; }
    .wallet-chip .wallet-name { font-weight: 600; }
    .wallet-chip .wallet-keys { font-size: 10px; opacity: 0.8; }
    
    /* Active wallet - golden accent */
    .wallet-chip.is-active { 
      box-shadow: 0 0 0 2px var(--keys-accent);
    }
    .wallet-chip.is-active .wallet-name::after {
      content: ' ◉';
      color: var(--keys-accent);
      font-size: 10px;
    }
    
    /* Other wallets - same styling, no dim */
    
    .add-wallet-btn { background: transparent; border: 1px dashed rgba(148,163,184,0.4); color: var(--text-soft); padding: 8px 14px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .add-wallet-btn:hover { border-color: var(--keys-accent); color: var(--keys-accent); }
    .max-wallets-hint { font-size: 11px; color: var(--text-soft); opacity: 0.7; margin-left: auto; }

    /* KEYS GRID */
    .keys-grid{ display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; margin-top: 22px; }
    @media (max-width: 1100px) { .keys-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 800px) { .keys-grid { grid-template-columns: repeat(2, 1fr); gap:14px; } }
    @media (max-width: 500px) { .keys-grid { grid-template-columns: 1fr; } }

    /* KEY CARD */
    .key-card-wrapper { display: flex; flex-direction: column; gap: 6px; }
    .wallet-badge-above { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 10px; width: fit-content; transition: all 0.2s; }
    .wallet-badge-above .wallet-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .wallet-badge-above .wallet-label { font-weight: 600; }
    .wallet-badge-above .wallet-addr { font-family: monospace; opacity: 0.85; }
    
    /* Active wallet badge */
    .wallet-badge-above.is-active {
      box-shadow: 0 0 0 1px var(--keys-accent);
    }
    .wallet-badge-above.is-active::after {
      content: '◉';
      font-size: 8px;
      color: var(--keys-accent);
      margin-left: 4px;
    }
    
    /* Other wallet cards - same styling, no dim */

    .key-card{ background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 18px; position: relative; overflow: hidden; transition: all 220ms ease; cursor: pointer; }
    .key-card:hover{ transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.25); border-color: var(--keys-accent); }

    .key-header{ display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .key-id{ font-size: 18px; font-weight: 600; color: var(--keys-accent); }
    
    .header-indicators { display: flex; gap: 6px; align-items: center; }
    .indicator-dot { width: 10px; height: 10px; border-radius: 50%; }
    .indicator-dot.treasury-indicator { background: var(--treasury-blue); animation: pulse-blue 1.5s infinite; }
    
    @keyframes pulse-blue {
      0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 0 rgba(96,165,250,0); }
      50% { opacity: 0.7; transform: scale(0.9); box-shadow: 0 0 8px rgba(96,165,250,0.5); }
    }

    .genesis-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--keys-accent); opacity: 0.7; margin-bottom: 6px; }
    .key-glyphs{ font-size: 12px; letter-spacing: 0.5px; margin-bottom: 8px; font-family: "Segoe UI Symbol", sans-serif; color: var(--text-soft); }
    .key-meta{ display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text-soft); margin-bottom: 12px; }
    .key-meta a{ color: var(--accent); }
    .key-meta a:hover{ text-decoration: underline; }

    .status-section { padding-top: 12px; border-top: 1px solid rgba(148,163,184,0.15); margin-bottom: 12px; }
    .status-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .status-group { display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
    .status-group:hover { background: rgba(245,200,66,0.15); border-color: rgba(245,200,66,0.4); }
    .status-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-soft); }
    .dots-row { display: flex; gap: 5px; }
    .dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid; }
    .dot.filled { background: #4ade80; border-color: #4ade80; }
    .dot.open { background: transparent; border-color: var(--keys-accent); }

    .bottom-row-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .mini-stat { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 4px; border-radius: 8px; font-size: 10px; cursor: pointer; transition: all 0.2s; text-align: center; min-height: 72px; }
    .mini-stat:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .mini-stat .icon { font-size: 15px; margin-bottom: 4px; line-height: 1; }
    .mini-stat .value { font-weight: 700; font-size: 14px; line-height: 1.2; }
    .mini-stat .label { font-size: 8px; text-transform: uppercase; letter-spacing: 0.03em; color: var(--text-soft); margin-top: 3px; }
    
    .mini-stat.artefacts { background: rgba(102,214,154,0.1); border: 1px solid rgba(102,214,154,0.2); }
    .mini-stat.artefacts .icon, .mini-stat.artefacts .value { color: var(--accent); }
    .mini-stat.artefacts.empty { opacity: 0.35; }
    
    .mini-stat.canons { background: rgba(192,132,252,0.1); border: 1px solid rgba(192,132,252,0.2); }
    .mini-stat.canons .icon, .mini-stat.canons .value { color: var(--canon-purple); }
    .mini-stat.canons.empty { opacity: 0.35; }
    
    .mini-stat.unseen { background: rgba(245,200,66,0.1); border: 1px solid rgba(245,200,66,0.2); }
    .mini-stat.unseen .icon { font-size: 16px; margin-bottom: 5px; }
    .mini-stat.unseen .icon, .mini-stat.unseen .value { color: var(--keys-accent); }
    .mini-stat.unseen .value { font-weight: 400; }
    .mini-stat.unseen.empty { opacity: 0.35; }
    
    .mini-stat.treasury { background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.2); }
    .mini-stat.treasury .icon, .mini-stat.treasury .value { color: var(--treasury-blue); }
    .mini-stat.treasury.empty { opacity: 0.35; }
    .mini-stat.treasury.has-claim { animation: glow-blue 2s infinite; }
    
    @keyframes glow-blue {
      0%, 100% { box-shadow: 0 0 0 rgba(96,165,250,0); border-color: rgba(96,165,250,0.2); }
      50% { box-shadow: 0 0 10px rgba(96,165,250,0.4); border-color: rgba(96,165,250,0.6); }
    }

    .filter-toolbar { background: rgba(15, 23, 42, 0.5); border: 1px solid var(--card-border); border-radius: 10px; padding: 12px 14px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filter-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; border: 1px solid rgba(148,163,184,0.3); background: transparent; color: var(--text-soft); font-size: 11px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .filter-toggle:hover { border-color: var(--keys-accent); color: var(--text-main); }
    .filter-toggle.active { background: rgba(245, 200, 66, 0.15); border-color: var(--keys-accent); color: var(--keys-accent); }
    .filter-toggle .toggle-dot { width: 8px; height: 8px; border-radius: 50%; border: 1px solid currentColor; transition: all 0.2s; }
    .filter-toggle.active .toggle-dot { background: var(--keys-accent); }
    .filter-group { display: flex; align-items: center; gap: 6px; }
    .filter-label { font-size: 10px; color: var(--text-soft); text-transform: uppercase; }
    .filter-select { background: rgba(5, 8, 18, 0.8); border: 1px solid rgba(148,163,184,0.3); border-radius: 6px; padding: 7px 26px 7px 10px; font-size: 11px; color: var(--text-main); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%239aa3bb' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; min-width: 100px; }
    .filter-select:focus { outline: none; border-color: var(--keys-accent); }
    .search-input { background: rgba(5, 8, 18, 0.8); border: 1px solid rgba(148,163,184,0.3); border-radius: 6px; padding: 7px 10px; font-size: 11px; color: var(--text-main); min-width: 140px; }
    .search-input:focus { outline: none; border-color: var(--keys-accent); }
    .no-results { text-align: center; padding: 40px 20px; color: var(--text-soft); border: 1px dashed rgba(148,163,184,0.2); border-radius: 10px; margin-top: 20px; }
    #btnManageWallets:hover { border-color: var(--keys-accent); color: var(--keys-accent); }

    .loading{ color:var(--text-soft); font-size:14px; margin-top:22px; }
    .wallet-loading { position: fixed; inset: 0; background: rgba(5, 8, 18, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .wallet-loading.active { opacity: 1; pointer-events: all; }
    .wallet-loading-spinner { width: 56px; height: 56px; border: 3px solid rgba(245, 200, 66, 0.2); border-top-color: var(--keys-accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .wallet-loading-text { font-size: 15px; color: var(--text-soft); text-align: center; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; background: rgba(102, 214, 154, 0.95); color: #000; border-radius: 10px; font-size: 14px; font-weight: 600; z-index: 10000; opacity: 0; transform: translateY(-20px); transition: all 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: rgba(224, 85, 85, 0.95); color: #fff; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(5, 8, 18, 0.92); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .claim-modal { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; width: 90%; max-width: 480px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.25s; }
    .modal-overlay.active .claim-modal { transform: translateY(0); }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid rgba(148,163,184,0.15); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 18px; font-weight: 600; color: var(--keys-accent); }
    .modal-close { background: none; border: none; color: var(--text-soft); font-size: 24px; cursor: pointer; padding: 0; line-height: 1; transition: color 0.2s; }
    .modal-close:hover { color: var(--text-main); }
    .modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
    .claim-key-info { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(15, 23, 42, 0.5); border-radius: 10px; margin-bottom: 20px; }
    .claim-key-id { font-size: 16px; font-weight: 600; color: var(--keys-accent); }
    .claim-key-wallet { font-size: 11px; color: var(--text-soft); font-family: monospace; }
    .claim-total { display: flex; align-items: baseline; gap: 8px; margin-bottom: 20px; }
    .claim-total-label { font-size: 12px; color: var(--text-soft); }
    .claim-total-amount { font-size: 24px; font-weight: 700; color: var(--claim-green); }
    .claim-total-unit { font-size: 14px; color: var(--text-soft); }
    .claim-epochs-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); margin-bottom: 10px; }
    .claim-epoch-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .claim-epoch-item { background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(148,163,184,0.2); border-radius: 10px; padding: 14px 16px; }
    .claim-epoch-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .claim-epoch-id { font-size: 13px; font-weight: 600; color: var(--text-main); }
    .claim-epoch-amount { font-size: 14px; font-weight: 600; color: var(--claim-green); }
    .claim-options { display: flex; gap: 8px; }
    .claim-option { flex: 1; padding: 12px 8px 10px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: transparent; color: var(--text-soft); font-size: 11px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .claim-option:hover { border-color: var(--text-main); color: var(--text-main); }
    .claim-option.selected { border-color: var(--claim-green); background: rgba(74, 222, 128, 0.1); color: var(--claim-green); }
    .claim-option.selected.recycle { border-color: var(--keys-accent); background: rgba(245, 200, 66, 0.1); color: var(--keys-accent); }
    .claim-option.selected.nexus { border-color: #a78bfa; background: rgba(167, 139, 250, 0.1); color: #a78bfa; }
    .claim-option-icon { font-size: 18px; margin-bottom: 4px; }
    .claim-option-label { font-weight: 600; margin-bottom: 4px; }
    .claim-option-desc { font-size: 9px; opacity: 0.7; line-height: 1.3; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid rgba(148,163,184,0.15); display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 14px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .modal-btn-cancel { background: transparent; border: 1px solid rgba(148,163,184,0.3); color: var(--text-soft); }
    .modal-btn-cancel:hover { border-color: var(--text-main); color: var(--text-main); }
    .modal-btn-confirm { background: var(--claim-green); border: 1px solid var(--claim-green); color: #000; }
    .modal-btn-confirm:hover { background: #22c55e; border-color: #22c55e; }
    .modal-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
    .no-claims { text-align: center; padding: 30px 20px; color: var(--text-soft); }
    .no-claims-icon { font-size: 32px; margin-bottom: 10px; opacity: 0.5; }
  </style>
</head>

<body>
<div class="wallet-loading" id="walletLoading">
  <div>
    <div class="wallet-loading-spinner"></div>
    <div class="wallet-loading-text" id="loadingText">Loading...</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="claimModal">
  <div class="claim-modal">
    <div class="modal-header">
      <span class="modal-title">Claim Rewards</span>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-body" id="claimModalBody"></div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" id="modalCancel">Cancel</button>
      <button class="modal-btn modal-btn-confirm" id="modalConfirm">Confirm Claims</button>
    </div>
  </div>
</div>

<header>
  <div class="nav-inner">
    <a href="./index.html" class="logo-link"><div class="logo-dot">Ω</div><div class="logo-text">Z1N PROTOCOL</div></a>
    <nav class="nav-links">
      <a href="./about.html">About</a>
      <a href="./live-stats.html">Live Stats</a>
      <a href="./artefacts.html">Artefacts</a>
      <a href="./mint-key.html">Mint Key</a>
      <a href="./your-keys.html" class="active-keys">Your Keys</a>
    </nav>
  </div>
</header>

<main class="page">
  <h1>Your Keys</h1>
  <p class="lead">Your Keys are soulbound proofs of presence in the Field — each one a unique coordinate in the 21M-Key manifold.</p>
  <p class="lead-small">From here you can manage your signals, attestations, and artefacts. Each Key unlocks its own dashboard.</p>

  <div id="connectState">
    <div class="mode-row">
      <button id="btnConnect" class="mode-btn active" type="button">Connect Wallet</button>
    </div>
  </div>

  <div id="walletsSection" class="wallets-section" style="display:none;">
    <div class="wallets-header">
      <span class="wallets-title">Connected Wallets</span>
      <span class="wallets-count" id="walletsCount">0 / 10</span>
    </div>
    <div class="wallets-grid" id="walletsGrid"></div>
  </div>

  <div id="loadingState" class="loading" style="display:none;">Loading your Keys...</div>
  <div id="noKeysState" style="display:none;">
    <p class="lead-small" id="noKeysMessage">No Keys found across connected wallets.</p>
    <div class="mode-row" style="margin-top:16px;"><a href="./mint-key.html" class="mode-btn">Mint your first Key</a></div>
  </div>

  <div id="keysToolbar" style="display:none;">
    <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
      <span style="font-size:14px;"><span id="totalKeysCount">0</span> Keys</span>
      <span style="font-size:12px; color:var(--text-soft);">Epoch: <span id="currentEpoch" style="color:var(--keys-accent); font-weight:600;">—</span></span>
      <button id="btnManageWallets" style="margin-left:auto; background:transparent; border:1px solid rgba(148,163,184,0.3); color:var(--text-soft); padding:6px 12px; border-radius:6px; font-size:11px; cursor:pointer; transition:all 0.2s;">± Manage Wallets</button>
    </div>
  </div>

  <div id="filterToolbar" class="filter-toolbar" style="display:none;">
    <button class="filter-toggle" id="onlyActiveToggle" style="display:none;">
      <span class="toggle-dot"></span>
      <span>Only Active</span>
    </button>
    <div class="filter-group">
      <span class="filter-label">Sort</span>
      <select class="filter-select" id="sortSelect">
        <option value="id-desc">ID ↓</option>
        <option value="id-asc">ID ↑</option>
        <option value="signals-desc">Signals ↓</option>
        <option value="wallet-asc">Wallet</option>
      </select>
    </div>
    <div class="filter-group" id="walletFilterGroup" style="display:none;">
      <span class="filter-label">Wallet</span>
      <select class="filter-select" id="walletFilter">
        <option value="all">All Wallets</option>
      </select>
    </div>
    <div class="filter-group" style="flex:1;">
      <input type="text" class="search-input" id="searchInput" placeholder="Search by ID...">
    </div>
  </div>

  <div id="keysContainer" class="keys-grid" style="display:none;"></div>
  <div id="noResultsState" class="no-results" style="display:none;">No Keys match your filters</div>
  <div id="mintMoreSection" style="display:none; margin-top:24px;"><a href="./mint-key.html" class="mode-btn">+ Mint another Key</a></div>
</main>

<footer>Your presence is real · The Field remembers</footer>

<script>
// WALLET REGISTRY
(function(global) {
  var STORAGE_KEY = 'z1n_wallet_registry';
  var MAX_WALLETS = 10;
  var WALLET_COLORS = [
    { name: 'gold',   hex: '#f5c842', bg: 'rgba(245, 200, 66, 0.15)',  border: 'rgba(245, 200, 66, 0.4)' },
    { name: 'green',  hex: '#66d69a', bg: 'rgba(102, 214, 154, 0.15)', border: 'rgba(102, 214, 154, 0.4)' },
    { name: 'blue',   hex: '#60a5fa', bg: 'rgba(96, 165, 250, 0.15)',  border: 'rgba(96, 165, 250, 0.4)' },
    { name: 'purple', hex: '#a78bfa', bg: 'rgba(167, 139, 250, 0.15)', border: 'rgba(167, 139, 250, 0.4)' },
    { name: 'pink',   hex: '#f472b6', bg: 'rgba(244, 114, 182, 0.15)', border: 'rgba(244, 114, 182, 0.4)' },
    { name: 'orange', hex: '#fb923c', bg: 'rgba(251, 146, 60, 0.15)',  border: 'rgba(251, 146, 60, 0.4)' },
    { name: 'cyan',   hex: '#22d3ee', bg: 'rgba(34, 211, 238, 0.15)',  border: 'rgba(34, 211, 238, 0.4)' },
    { name: 'lime',   hex: '#a3e635', bg: 'rgba(163, 230, 53, 0.15)',  border: 'rgba(163, 230, 53, 0.4)' },
    { name: 'indigo', hex: '#818cf8', bg: 'rgba(129, 140, 248, 0.15)', border: 'rgba(129, 140, 248, 0.4)' },
    { name: 'teal',   hex: '#2dd4bf', bg: 'rgba(45, 212, 191, 0.15)',  border: 'rgba(45, 212, 191, 0.4)' }
  ];
  var DISCONNECTED = { name: 'red', hex: '#e05555', bg: 'rgba(224, 85, 85, 0.15)', border: 'rgba(224, 85, 85, 0.4)' };

  function loadRegistry() { try { var d = localStorage.getItem(STORAGE_KEY); return d ? JSON.parse(d).slice(0, MAX_WALLETS) : []; } catch(e) { return []; } }
  function saveRegistry(w) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(w.slice(0, MAX_WALLETS))); } catch(e) {} }
  function register(addr) {
    if (!addr) return -1;
    var lower = addr.toLowerCase(), reg = loadRegistry();
    var idx = reg.findIndex(function(w) { return w.toLowerCase() === lower; });
    if (idx !== -1) return idx;
    if (reg.length >= MAX_WALLETS) return -1;
    reg.push(addr);
    saveRegistry(reg);
    return reg.length - 1;
  }
  function getIndex(addr) {
    if (!addr) return -1;
    var lower = addr.toLowerCase(), reg = loadRegistry();
    return reg.findIndex(function(w) { return w.toLowerCase() === lower; });
  }
  function getColor(addr, autoReg) {
    var idx = getIndex(addr);
    if (idx === -1 && autoReg) idx = register(addr);
    return (idx >= 0 && idx < WALLET_COLORS.length) ? WALLET_COLORS[idx] : DISCONNECTED;
  }
  function shortAddr(a) { return a ? a.slice(0,6) + '...' + a.slice(-4) : '—'; }

  /* Format POL value for compact card display:
   * 0         → '–'
   * 0.86      → '1'       (no decimals, rounded)
   * 2.02      → '2'       
   * 999       → '999'
   * 1500      → '1.5k'    (over 1k: one decimal)
   * 10000     → '10k'     (over 10k: no decimal)
   * 123456    → '123k'
   */
  function formatPol(val) {
    if (!val || val <= 0) return '–';
    if (val >= 10000) return Math.round(val / 1000) + 'k';
    if (val >= 1000) {
      var k = val / 1000;
      return (k % 1 === 0) ? k + 'k' : k.toFixed(1) + 'k';
    }
    return Math.round(val).toString();
  }

  /* Count unseen activity for a key.
   * Dashboard builds ActivityFeed.activities with IDs containing Math.random() fallbacks,
   * then stores read IDs in localStorage. We can't replicate random IDs, so instead:
   * - Count total RECEIVED items from same API endpoints as dashboard
   * - Subtract number of read items from localStorage
   * - Result = unseen count (may differ slightly but close enough)
   */
  function getUnseenCount(tokenId) {
    var API_BASE = 'https://z1n-backend-production.up.railway.app/api';

    // Read how many items dashboard has marked as read
    var readCount = 0;
    try {
      var stored = localStorage.getItem('z1n_activity_read_' + tokenId);
      if (stored) readCount = JSON.parse(stored).length;
    } catch (e) {}

    return Promise.all([
      fetch(apiBase + '/attestations?toKeyId=' + tokenId + '&limit=50').then(function(r) { return r.ok ? r.json() : {}; }).catch(function() { return {}; }),
      fetch(apiBase + '/pure?keyId=' + tokenId + '&limit=50').then(function(r) { return r.ok ? r.json() : {}; }).catch(function() { return {}; }),
      fetch(apiBase + '/pure?toKeyId=' + tokenId + '&limit=50').then(function(r) { return r.ok ? r.json() : {}; }).catch(function() { return {}; })
    ]).then(function(results) {
      var totalReceived = 0;

      // Attests received
      totalReceived += (results[0].attestations || []).length;

      // Whispers received — deduplicate, count only incoming
      var fromW = results[1].whispers || results[1].messages || results[1].pure || [];
      var toW = results[2].whispers || results[2].messages || results[2].pure || [];
      var allW = fromW.concat(toW);
      var seen = {};
      allW.forEach(function(w) {
        var k = w.txHash || (w.fromKeyId + '-' + w.toKeyId + '-' + w.blockNumber);
        if (seen[k]) return;
        seen[k] = true;
        // Only count received (toKeyId matches, fromKeyId doesn't)
        if (w.toKeyId == tokenId && w.fromKeyId != tokenId) {
          totalReceived++;
        }
      });

      var unseen = Math.max(0, totalReceived - readCount);
      return unseen;
    }).catch(function() { return 0; });
  }

  /* Read total earned from dashboard's localStorage claimed history */
  function getTotalEarned(tokenId) {
    try {
      var stored = localStorage.getItem('z1n_claimed_epochs_' + tokenId);
      if (!stored) return 0;
      var epochs = JSON.parse(stored);
      if (!Array.isArray(epochs)) return 0;
      return epochs.reduce(function(sum, e) { return sum + parseFloat(e.amount || '0'); }, 0);
    } catch (e) { return 0; }
  }

  global.formatPol = formatPol;
  global.getTotalEarned = getTotalEarned;
  global.getUnseenCount = getUnseenCount;

  global.Z1NWallets = {
    MAX_WALLETS: MAX_WALLETS,
    COLORS: WALLET_COLORS,
    DISCONNECTED: DISCONNECTED,
    register: register,
    getIndex: getIndex,
    getColor: getColor,
    getAll: function() { return loadRegistry().map(function(a,i) { return { address: a, index: i, color: WALLET_COLORS[i] }; }); },
    shortAddr: shortAddr
  };
})(window);
</script>

<script>
// ================================================================================
// REPLACEMENT JAVASCRIPT FOR your-keys.html
// Copy everything between the <script> tags (the main app script, NOT the wallet registry)
// This replaces all direct RPC calls with backend API calls
// ================================================================================

(function() {
  "use strict";

  // Contract address only needed for explorer links
  var Z1N_KEY = '0xe27C2De6e8F1090EEAe18E1Ce3f51F1D2FeAf469';
  var EXPLORER = 'https://polygonscan.com';
  var API_BASE = 'https://z1n-backend-production.up.railway.app/api';
  var FILTER_STORAGE_KEY = 'z1n_keys_filters';

  var allConnectedAccounts = [];
  var primaryWallet = null;
  var allKeys = [];
  var currentEpochNum = 0;
  var filters = { sort: 'id-desc', wallet: 'all', search: '', onlyActive: false };
  var claimModalKeyId = null;
  var claimModalWallet = null;
  var claimSelections = {};

  // Load saved filters from localStorage
  function loadSavedFilters() {
    try {
      var saved = localStorage.getItem(FILTER_STORAGE_KEY);
      if (saved) {
        var parsed = JSON.parse(saved);
        if (parsed.sort) filters.sort = parsed.sort;
        if (parsed.wallet) filters.wallet = parsed.wallet;
        if (parsed.onlyActive !== undefined) filters.onlyActive = parsed.onlyActive;
      }
    } catch (e) {}
  }

  // Save filters to localStorage
  function saveFilters() {
    try {
      localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify({ sort: filters.sort, wallet: filters.wallet, onlyActive: filters.onlyActive }));
    } catch (e) {}
  }

  function showToast(msg, dur, isError) { 
    var t = document.getElementById('toast'); 
    t.textContent = msg; 
    t.classList.toggle('error', !!isError);
    t.classList.add('show'); 
    setTimeout(function() { t.classList.remove('show'); }, dur || 3000); 
  }
  function showLoading(text) { document.getElementById('loadingText').textContent = text || 'Loading...'; document.getElementById('walletLoading').classList.add('active'); }
  function hideLoading() { document.getElementById('walletLoading').classList.remove('active'); }

  function getProvider() {
    if (window.ethereum && window.ethereum.providers) {
      var mm = window.ethereum.providers.find(function(p) { return p.isMetaMask; });
      if (mm) return mm;
      return window.ethereum.providers[0];
    }
    return window.ethereum || (window.phantom && window.phantom.ethereum) || null;
  }

  function saveContext(keyId, wallet) { try { localStorage.setItem('z1n_signal_context', JSON.stringify({ keyId: keyId, wallet: wallet })); } catch (e) {} }
  
  function isPrimaryWallet(addr) {
    return primaryWallet && addr.toLowerCase() === primaryWallet.toLowerCase();
  }

  function renderWalletsSection() {
    var section = document.getElementById('walletsSection');
    var grid = document.getElementById('walletsGrid');
    var count = document.getElementById('walletsCount');
    
    if (allConnectedAccounts.length <= 1) { section.style.display = 'none'; return; }
    
    section.style.display = 'block';
    count.textContent = allConnectedAccounts.length + ' / ' + Z1NWallets.MAX_WALLETS;
    
    var keysPerWallet = {};
    allKeys.forEach(function(k) { var w = k.wallet.toLowerCase(); keysPerWallet[w] = (keysPerWallet[w] || 0) + 1; });
    
    var html = '';
    allConnectedAccounts.forEach(function(addr, i) {
      var color = Z1NWallets.getColor(addr, true);
      var idx = Z1NWallets.getIndex(addr);
      var keyCount = keysPerWallet[addr.toLowerCase()] || 0;
      var isPrimary = isPrimaryWallet(addr);
      var chipClass = isPrimary ? 'is-active' : '';
      
      html += '<div class="wallet-chip ' + chipClass + '" style="background:' + color.bg + '; border:1px solid ' + color.border + '; color:' + color.hex + ';">' +
        '<span class="wallet-dot" style="background:' + color.hex + ';"></span>' +
        '<span class="wallet-info">' +
          '<span class="wallet-name">W' + (idx + 1) + ' · ' + Z1NWallets.shortAddr(addr) + '</span>' +
          '<span class="wallet-keys">' + keyCount + ' key' + (keyCount !== 1 ? 's' : '') + '</span>' +
        '</span>' +
      '</div>';
    });
    
    if (allConnectedAccounts.length < Z1NWallets.MAX_WALLETS) {
      html += '<button class="add-wallet-btn" id="btnAddWallet">+ Add or Remove Wallets</button>';
    } else {
      html += '<span class="max-wallets-hint">Max wallets reached</span>';
    }
    
    grid.innerHTML = html;
    
    var addBtn = document.getElementById('btnAddWallet');
    if (addBtn) addBtn.onclick = addAnotherWallet;
    
    var walletFilter = document.getElementById('walletFilter');
    var walletFilterGroup = document.getElementById('walletFilterGroup');
    walletFilterGroup.style.display = 'flex';
    walletFilter.innerHTML = '<option value="all">All Wallets</option>';
    allConnectedAccounts.forEach(function(addr, i) {
      var idx = Z1NWallets.getIndex(addr);
      var isPrimary = isPrimaryWallet(addr);
      var label = 'W' + (idx + 1) + ' · ' + Z1NWallets.shortAddr(addr) + (isPrimary ? ' ◉' : '');
      walletFilter.innerHTML += '<option value="' + addr.toLowerCase() + '">' + label + '</option>';
    });
    
    // Restore saved wallet filter if valid
    if (filters.wallet !== 'all') {
      var isValid = allConnectedAccounts.some(function(a) { return a.toLowerCase() === filters.wallet; });
      if (isValid) {
        walletFilter.value = filters.wallet;
      } else {
        filters.wallet = 'all';
        saveFilters();
      }
    }
  }
  
  function updateFilterToolbar() {
    var walletFilterGroup = document.getElementById('walletFilterGroup');
    var onlyActiveToggle = document.getElementById('onlyActiveToggle');
    
    if (allConnectedAccounts.length > 1) {
      walletFilterGroup.style.display = 'flex';
      onlyActiveToggle.style.display = 'inline-flex';
      
      // Restore toggle state
      if (filters.onlyActive) {
        onlyActiveToggle.classList.add('active');
      } else {
        onlyActiveToggle.classList.remove('active');
      }
    } else {
      walletFilterGroup.style.display = 'none';
      onlyActiveToggle.style.display = 'none';
      if (filters.wallet !== 'all' || filters.onlyActive) {
        filters.wallet = 'all';
        filters.onlyActive = false;
        saveFilters();
        renderKeys();
      }
    }
    
    // Restore sort selection
    document.getElementById('sortSelect').value = filters.sort;
  }

  function applyFilters() {
    var filtered = allKeys.slice();
    
    // Only Active toggle takes precedence
    if (filters.onlyActive && primaryWallet) {
      filtered = filtered.filter(function(k) { return k.wallet.toLowerCase() === primaryWallet; });
    } else if (filters.wallet !== 'all') {
      filtered = filtered.filter(function(k) { return k.wallet.toLowerCase() === filters.wallet; });
    }
    
    if (filters.search) { var s = filters.search.toLowerCase(); filtered = filtered.filter(function(k) { return k.tokenId.toString().includes(s); }); }
    
    filtered.sort(function(a, b) {
      switch(filters.sort) {
        case 'id-asc': return a.tokenId - b.tokenId;
        case 'signals-desc': return (b.signalsUsed || 0) - (a.signalsUsed || 0);
        case 'wallet-asc': 
          var idxA = Z1NWallets.getIndex(a.wallet);
          var idxB = Z1NWallets.getIndex(b.wallet);
          if (idxA !== idxB) return idxA - idxB;
          return a.tokenId - b.tokenId;
        default: return b.tokenId - a.tokenId;
      }
    });
    return filtered;
  }

  function openClaimModal(key) {
    claimModalKeyId = key.tokenId;
    claimModalWallet = key.wallet;
    claimSelections = {};

    var body = document.getElementById('claimModalBody');
    var color = Z1NWallets.getColor(key.wallet);
    var walletIdx = Z1NWallets.getIndex(key.wallet);

    if (!key.claimableEpochs || key.claimableEpochs.length === 0) {
      body.innerHTML = '<div class="no-claims"><div class="no-claims-icon">◇</div><p>No rewards to claim for this Key</p></div>';
      document.getElementById('modalConfirm').disabled = true;
    } else {
      var totalAmount = key.claimableEpochs.reduce(function(sum, e) { return sum + parseFloat(e.amount); }, 0);

      var html = '<div class="claim-key-info">' +
        '<span class="claim-key-id">Key #' + key.tokenId + '</span>' +
        '<span class="claim-key-wallet" style="color:' + color.hex + ';">W' + (walletIdx + 1) + ' · ' + Z1NWallets.shortAddr(key.wallet) + '</span>' +
      '</div>' +
      '<div class="claim-total">' +
        '<span class="claim-total-label">Total Claimable:</span>' +
        '<span class="claim-total-amount">' + totalAmount.toFixed(4) + '</span>' +
        '<span class="claim-total-unit">POL</span>' +
      '</div>' +
      '<div class="claim-epochs-label">' + key.claimableEpochs.length + ' Epoch' + (key.claimableEpochs.length > 1 ? 's' : '') + ' Available</div>' +
      '<div class="claim-epoch-list">';

      key.claimableEpochs.forEach(function(epoch) {
        claimSelections[epoch.epochId] = 'self';
        html += '<div class="claim-epoch-item" data-epoch="' + epoch.epochId + '">' +
          '<div class="claim-epoch-header">' +
            '<span class="claim-epoch-id">Epoch ' + epoch.epochId + '</span>' +
            '<span class="claim-epoch-amount">' + parseFloat(epoch.amount).toFixed(4) + ' POL</span>' +
          '</div>' +
          '<div class="claim-options">' +
            '<button class="claim-option selected" data-epoch="' + epoch.epochId + '" data-type="self">' +
              '<div class="claim-option-icon">↓</div>' +
              '<div class="claim-option-label">To Me</div>' +
              '<div class="claim-option-desc">Claim to your wallet</div>' +
            '</button>' +
            '<button class="claim-option recycle" data-epoch="' + epoch.epochId + '" data-type="recycle">' +
              '<div class="claim-option-icon">↻</div>' +
              '<div class="claim-option-label">Recycle</div>' +
              '<div class="claim-option-desc">Return to next epoch\'s pool</div>' +
            '</button>' +
            '<button class="claim-option nexus" data-epoch="' + epoch.epochId + '" data-type="nexus">' +
              '<div class="claim-option-icon">Ω</div>' +
              '<div class="claim-option-label">Nexus</div>' +
              '<div class="claim-option-desc">Gift to Nexus Epoch Wallet</div>' +
            '</button>' +
          '</div>' +
        '</div>';
      });

      html += '</div>';
      body.innerHTML = html;
      document.getElementById('modalConfirm').disabled = false;

      body.querySelectorAll('.claim-option').forEach(function(btn) {
        btn.onclick = function() {
          var epochId = btn.dataset.epoch;
          var type = btn.dataset.type;
          claimSelections[epochId] = type;
          var parent = btn.closest('.claim-epoch-item');
          parent.querySelectorAll('.claim-option').forEach(function(b) { b.classList.remove('selected'); });
          btn.classList.add('selected');
        };
      });
    }

    document.getElementById('claimModal').classList.add('active');
  }

  function closeClaimModal() {
    document.getElementById('claimModal').classList.remove('active');
    claimModalKeyId = null;
    claimModalWallet = null;
    claimSelections = {};
  }

  async function executeClaimsSequentially() {
    var key = allKeys.find(function(k) { return k.tokenId === claimModalKeyId && k.wallet === claimModalWallet; });
    if (!key || !key.claimableEpochs || key.claimableEpochs.length === 0) return;

    var eth = getProvider();
    if (!eth) { showToast('Wallet not connected', 3000, true); return; }

    var accounts = await eth.request({ method: 'eth_accounts' });
    if (!accounts.some(function(a) { return a.toLowerCase() === claimModalWallet.toLowerCase(); })) {
      showToast('Please switch to wallet ' + Z1NWallets.shortAddr(claimModalWallet), 4000, true);
      return;
    }

    closeClaimModal();
    showLoading('Processing claims...');

    var successCount = 0;
    var failCount = 0;

    for (var i = 0; i < key.claimableEpochs.length; i++) {
      var epoch = key.claimableEpochs[i];
      var claimType = claimSelections[epoch.epochId] || 'self';

      try {
        document.getElementById('loadingText').textContent = 'Claiming Epoch ' + epoch.epochId + ' (' + (i+1) + '/' + key.claimableEpochs.length + ')...';

        var claimDataResp = await fetch(API_BASE + '/treasury/claim-data?epochId=' + epoch.epochId + '&wallet=' + encodeURIComponent(claimModalWallet) + '&claimType=' + claimType);
        
        if (!claimDataResp.ok) throw new Error('Failed to get claim data');
        
        var claimData = await claimDataResp.json();
        
        var txHash = await eth.request({
          method: 'eth_sendTransaction',
          params: [{ from: claimModalWallet, to: claimData.to, data: claimData.data, gas: '0x30000' }]
        });
        
        await new Promise(function(r) { setTimeout(r, 2000); });
        
        successCount++;
        showToast('Claimed Epoch ' + epoch.epochId + '!', 2000);

      } catch (err) {
        console.error('Claim failed for epoch', epoch.epochId, err);
        failCount++;
        if (err.code === 4001) { showToast('Transaction cancelled', 3000, true); break; }
      }
    }

    hideLoading();

    if (successCount > 0 && failCount === 0) {
      showToast('Successfully claimed ' + successCount + ' epoch(s)!', 4000);
    } else if (successCount > 0) {
      showToast('Claimed ' + successCount + ', failed ' + failCount, 4000);
    } else if (failCount > 0) {
      showToast('Claims failed', 3000, true);
    }

    await loadAllKeys(true);
  }

  document.getElementById('modalClose').onclick = closeClaimModal;
  document.getElementById('modalCancel').onclick = closeClaimModal;
  document.getElementById('modalConfirm').onclick = executeClaimsSequentially;
  document.getElementById('claimModal').onclick = function(e) { if (e.target === this) closeClaimModal(); };

  function renderKeyCard(key) {
    var wrapper = document.createElement('div');
    wrapper.className = 'key-card-wrapper';
    
    var color = Z1NWallets.getColor(key.wallet);
    var walletIdx = Z1NWallets.getIndex(key.wallet);
    var walletParam = encodeURIComponent(key.wallet);
    var baseUrl = './key-dashboard?key=' + key.tokenId + '&wallet=' + walletParam;
    var isPrimary = isPrimaryWallet(key.wallet);
    
    if (allConnectedAccounts.length > 1) {
      var badge = document.createElement('div');
      badge.className = 'wallet-badge-above' + (isPrimary ? ' is-active' : '');
      badge.style.background = color.bg;
      badge.style.border = '1px solid ' + color.border;
      badge.style.color = color.hex;
      badge.innerHTML = '<span class="wallet-dot" style="background:' + color.hex + ';"></span>' +
        '<span class="wallet-label">W' + (walletIdx + 1) + '</span>' +
        '<span class="wallet-addr">' + Z1NWallets.shortAddr(key.wallet) + '</span>';
      wrapper.appendChild(badge);
    }

    var card = document.createElement('div');
    card.className = 'key-card';
    
    var hasClaimable = key.claimableEpochs && key.claimableEpochs.length > 0;
    var claimableAmount = hasClaimable ? key.claimableEpochs.reduce(function(sum, e) { return sum + parseFloat(e.amount || 0); }, 0) : 0;
    var claimedTotal = getTotalEarned(key.tokenId);
    var totalPol = claimedTotal + claimableAmount;
    var headerIndicator = hasClaimable ? '<span class="indicator-dot treasury-indicator" title="' + claimableAmount.toFixed(4) + ' POL claimable"></span>' : '';
    var genesisHtml = key.genesis ? '<div class="genesis-label">✶ Genesis Key</div>' : '';

    var signal1 = key.signalsUsed >= 1 ? '<span class="dot filled"></span>' : '<span class="dot open"></span>';
    var signal2 = key.signalsUsed >= 2 ? '<span class="dot filled"></span>' : '<span class="dot open"></span>';
    var attest1 = key.attestsUsed >= 1 ? '<span class="dot filled"></span>' : '<span class="dot open"></span>';
    var attest2 = key.attestsUsed >= 2 ? '<span class="dot filled"></span>' : '<span class="dot open"></span>';

    var artefactsCount = key.liveArtefacts || 0;
    var canonsCount = key.canonCount || 0;
    var unseenCount = key.unseenCount || 0;

    var treasuryValue = formatPol(totalPol);
    var treasuryClass = 'mini-stat treasury' + (hasClaimable ? ' has-claim' : (totalPol === 0 ? ' empty' : ''));

    var artefactsDisplay = artefactsCount > 0 ? artefactsCount : '–';
    var canonsDisplay = canonsCount > 0 ? canonsCount : '–';
    var unseenDisplay = unseenCount > 0 ? unseenCount : '–';
    var unseenClass = 'mini-stat unseen' + (unseenCount === 0 ? ' empty' : '');

    card.innerHTML =
      '<div class="key-header">' +
        '<span class="key-id">Key #' + key.tokenId + '</span>' +
        '<div class="header-indicators">' + headerIndicator + '</div>' +
      '</div>' +
      genesisHtml +
      '<div class="key-glyphs">' + (key.glyphSymbols || '...') + '</div>' +
      '<div class="key-meta">' +
        '<span>Birth Epoch ' + (key.epoch || '—') + '</span>' +
        '<a href="' + EXPLORER + '/token/' + Z1N_KEY + '?a=' + key.tokenId + '" target="_blank" onclick="event.stopPropagation()">View on chain ↗</a>' +
      '</div>' +
      '<div class="status-section">' +
        '<div class="status-row">' +
          '<div class="status-group" data-tab="signals">' +
            '<span class="status-label">Signals</span>' +
            '<div class="dots-row">' + signal1 + signal2 + '</div>' +
          '</div>' +
          '<div class="status-group" data-tab="attests">' +
            '<span class="status-label">Attests</span>' +
            '<div class="dots-row">' + attest1 + attest2 + '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="bottom-row-4">' +
        '<div class="' + unseenClass + '" data-tab="overview">' +
          '<span class="icon">●</span>' +
          '<span class="value">' + unseenDisplay + '</span>' +
          '<span class="label">Unseen</span>' +
        '</div>' +
        '<div class="mini-stat artefacts' + (artefactsCount === 0 ? ' empty' : '') + '" data-tab="artefacts">' +
          '<span class="icon">◈</span>' +
          '<span class="value">' + artefactsDisplay + '</span>' +
          '<span class="label">Artf</span>' +
        '</div>' +
        '<div class="mini-stat canons' + (canonsCount === 0 ? ' empty' : '') + '" data-tab="canon">' +
          '<span class="icon">Ω</span>' +
          '<span class="value">' + canonsDisplay + '</span>' +
          '<span class="label">Canon</span>' +
        '</div>' +
        '<div class="' + treasuryClass + '" data-tab="treasury">' +
          '<span class="icon">⬡</span>' +
          '<span class="value">' + treasuryValue + '</span>' +
          '<span class="label">POL</span>' +
        '</div>' +
      '</div>';

    card.onclick = function(e) {
      var link = e.target.closest('a');
      if (link) return;
      
      var clickable = e.target.closest('.mini-stat, .status-group');
      if (clickable && clickable.dataset.tab) {
        saveContext(key.tokenId, key.wallet);
        window.location.href = baseUrl + '&tab=' + clickable.dataset.tab;
        return;
      }
      
      saveContext(key.tokenId, key.wallet);
      window.location.href = baseUrl;
    };

    wrapper.appendChild(card);
    return wrapper;
  }

  function renderKeys() {
    var filtered = applyFilters();
    var container = document.getElementById('keysContainer');
    var noResults = document.getElementById('noResultsState');
    
    container.innerHTML = '';
    
    if (!filtered.length && allKeys.length > 0) {
      noResults.style.display = 'block';
      container.style.display = 'none';
    } else {
      noResults.style.display = 'none';
      container.style.display = 'grid';
      filtered.forEach(function(key) { container.appendChild(renderKeyCard(key)); });
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // INDEXED VERSION - Uses backend API instead of direct RPC calls
  // ═══════════════════════════════════════════════════════════════════
  async function loadKeysForWallet(walletAddr) {
    console.log('Loading wallet via API:', walletAddr);
    var keys = [];
    try {
      var response = await fetch(API_BASE + '/wallet/' + walletAddr + '/keys-summary');
      if (!response.ok) {
        console.error('API error:', response.status);
        return [];
      }
      var data = await response.json();
      
      // Update current epoch from API response
      if (data.currentEpoch) {
        currentEpochNum = data.currentEpoch;
      }
      
      // Map API response to expected format
      keys = (data.keys || []).map(function(k) {
        return {
          tokenId: k.tokenId,
          wallet: walletAddr,
          genesis: k.genesis,
          glyphSymbols: k.glyphSymbols,
          epoch: k.epoch,
          signalsUsed: k.signalsUsed || 0,
          attestsUsed: k.attestsUsed || 0,
          liveArtefacts: k.liveArtefacts || 0,
          canonCount: k.canonCount || 0,
          unseenCount: 0,
          totalClaimed: 0,
          claimableEpochs: []
        };
      });
      
      console.log('Loaded', keys.length, 'keys for wallet [INDEXED]');
      
    } catch (err) { 
      console.error('Error loading keys for ' + walletAddr + ':', err); 
    }
    return keys;
  }

  async function loadAllKeys(silent) {
    if (!silent) { showLoading('Loading Keys...'); }

    try {
      // Load keys from all wallets via API (epoch is included in response)
      var results = await Promise.all(allConnectedAccounts.map(loadKeysForWallet));
      allKeys = results.flat();
      
      // Update epoch display
      document.getElementById('currentEpoch').textContent = currentEpochNum;

      renderWalletsSection();
      updateFilterToolbar();

      if (!allKeys.length) {
        document.getElementById('connectState').style.display = 'none';
        document.getElementById('noKeysState').style.display = 'block';
        document.getElementById('keysToolbar').style.display = 'none';
        document.getElementById('filterToolbar').style.display = 'none';
        document.getElementById('keysContainer').style.display = 'none';
        document.getElementById('mintMoreSection').style.display = 'none';
        hideLoading();
        return;
      }

      document.getElementById('totalKeysCount').textContent = allKeys.length;
      document.getElementById('connectState').style.display = 'none';
      document.getElementById('noKeysState').style.display = 'none';
      document.getElementById('keysToolbar').style.display = 'block';
      document.getElementById('filterToolbar').style.display = allKeys.length >= 5 ? 'flex' : 'none';
      document.getElementById('keysContainer').style.display = 'grid';
      document.getElementById('mintMoreSection').style.display = 'block';

      renderKeys();
      hideLoading();

      // Second pass: fetch claimable data and unseen counts asynchronously
      Promise.all(allKeys.map(function(key) {
        return Promise.all([
          fetch(API_BASE + '/key/' + key.tokenId + '/claimable').then(function(r) { return r.ok ? r.json() : { epochs: [] }; }).catch(function() { return { epochs: [] }; }),
          getUnseenCount(key.tokenId)
        ]).then(function(results) {
          var treasury = results[0];
          key.unseenCount = results[1];
          key.claimableEpochs = (treasury.epochs || []).map(function(e) {
            return { epochId: e.epochId, amount: e.amountFormatted || '0' };
          });
        });
      })).then(function() {
        renderKeys(); // Re-render with real data
      }).catch(function() {});
      
    } catch (err) {
      console.error('Error:', err);
      document.getElementById('noKeysMessage').textContent = 'Error: ' + err.message;
      document.getElementById('noKeysState').style.display = 'block';
      hideLoading();
    }
  }

  async function connectWallet() {
    var eth = getProvider();
    if (!eth) { alert('Please install MetaMask or another Web3 wallet'); return; }
    showLoading('Connecting wallet...');
    try {
      var accounts = await eth.request({ method: 'eth_requestAccounts' });
      if (accounts && accounts.length) {
        primaryWallet = accounts[0].toLowerCase();
        accounts.forEach(function(a) { Z1NWallets.register(a); });
        allConnectedAccounts = accounts;
        await loadAllKeys();
      }
    } catch (e) { console.error(e); hideLoading(); }
  }

  async function addAnotherWallet() {
    var eth = getProvider();
    if (!eth) return;
    showLoading('Managing wallets...');
    try {
      await eth.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] });
      var accounts = await eth.request({ method: 'eth_accounts' });
      
      if (accounts && accounts.length) {
        if (accounts.length > Z1NWallets.MAX_WALLETS) {
          showToast('Max ' + Z1NWallets.MAX_WALLETS + ' wallets - using first ' + Z1NWallets.MAX_WALLETS, 3000);
          accounts = accounts.slice(0, Z1NWallets.MAX_WALLETS);
        }
        primaryWallet = accounts[0].toLowerCase();
        accounts.forEach(function(a) { Z1NWallets.register(a); });
        allConnectedAccounts = accounts;
        await loadAllKeys();
      } else {
        allConnectedAccounts = [];
        allKeys = [];
        primaryWallet = null;
        renderWalletsSection();
        document.getElementById('connectState').style.display = 'block';
        document.getElementById('keysToolbar').style.display = 'none';
        document.getElementById('filterToolbar').style.display = 'none';
        document.getElementById('keysContainer').style.display = 'none';
        document.getElementById('noKeysState').style.display = 'none';
        document.getElementById('mintMoreSection').style.display = 'none';
      }
    } catch (e) { console.error(e); }
    hideLoading();
  }

  // Load saved filters on init
  loadSavedFilters();

  document.getElementById('sortSelect').onchange = function() { 
    filters.sort = this.value; 
    saveFilters();
    renderKeys(); 
  };
  document.getElementById('walletFilter').onchange = function() { 
    filters.wallet = this.value;
    filters.onlyActive = false;
    document.getElementById('onlyActiveToggle').classList.remove('active');
    saveFilters();
    renderKeys(); 
  };
  document.getElementById('onlyActiveToggle').onclick = function() {
    filters.onlyActive = !filters.onlyActive;
    this.classList.toggle('active', filters.onlyActive);
    if (filters.onlyActive) {
      filters.wallet = 'all';
      document.getElementById('walletFilter').value = 'all';
    }
    saveFilters();
    renderKeys();
  };
  var searchDb;
  document.getElementById('searchInput').oninput = function() { var self = this; clearTimeout(searchDb); searchDb = setTimeout(function() { filters.search = self.value; renderKeys(); }, 200); };

  document.getElementById('btnConnect').onclick = connectWallet;
  document.getElementById('btnManageWallets').onclick = addAnotherWallet;

  (async function() {
    var eth = getProvider();
    if (eth) {
      try {
        var accounts = await eth.request({ method: 'eth_accounts' });
        if (accounts && accounts.length) {
          primaryWallet = accounts[0].toLowerCase();
          accounts.forEach(function(a) { Z1NWallets.register(a); });
          allConnectedAccounts = accounts;
          showLoading('Loading your Keys...');
          loadAllKeys();
        }
      } catch (e) {}
    }
  })();
})();
</script>
</body>
</html>