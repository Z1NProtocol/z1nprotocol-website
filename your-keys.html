<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Z1N Protocol â€“ Your Keys</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#050812;
      --card-bg:#020617;
      --text-main:#ffffff;
      --text-soft:#9aa3bb;

      --accent:#66d69a;
      --accent-soft:#3a9f63;

      --border-soft: rgba(148,163,184,0.35);
      --border-strong: rgba(102,214,154,0.75);

      --chip-active-bg: linear-gradient(90deg, rgba(102,214,154,0.55), rgba(58,159,99,0.55));
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    html{
      scrollbar-gutter: stable;
      overflow-y: scroll;
      scroll-behavior:smooth;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ opacity:0.9; }

    /* HEADER â€” align like artefacts.html */
    header{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom:1px solid rgba(255,255,255,0.05);
      margin-bottom:20px;
    }

    .nav-inner{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .logo-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .logo-dot{
      width:24px;
      height:24px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      line-height:1;
    }

    .logo-text{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.7;
    }

    .nav-links{
      display:flex;
      gap:22px;
      font-size:13px;
      opacity:0.85;
    }

    .nav-links a{ position:relative; }
    .nav-links a.active{ color:var(--accent); }
    .nav-links a.active-keys{ color:var(--keys-accent, #f5c842); }

    .nav-links a.active::after{
      content:"";
      position:absolute;
      left:0;
      bottom:-4px;
      width:100%;
      height:2px;
      border-radius:999px;
      background:linear-gradient(to right, var(--accent), var(--accent-soft));
    }

    .nav-links a.active-keys::after{
      content:"";
      position:absolute;
      left:0;
      bottom:-4px;
      width:100%;
      height:2px;
      border-radius:999px;
      background:linear-gradient(to right, #f5c842, #d4a012);
    }

    @media(max-width:900px){
      .nav-inner{ padding:0 16px; }
      .nav-links{
        font-size:12px;
        gap:14px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
    }

    /* PAGE */
    .page{
      max-width:1200px;
      margin:0 auto;
      padding:40px 24px 72px;
    }

    @media(max-width:900px){
      .page{ padding:32px 18px 56px; }
    }

    h1{
      font-size:40px;
      letter-spacing:-0.02em;
      margin:0 0 10px 0;
    }

    .lead{
      font-size:17px;
      line-height:1.6;
      opacity:0.85;
      max-width:900px;
      margin-bottom:6px;
    }

    .lead-small{
      font-size:14px;
      line-height:1.6;
      opacity:0.7;
      max-width:900px;
      margin-bottom:18px;
    }

    /* MODE BUTTONS â€” mint-key style */
    .mode-row{
      display:flex;
      gap:12px;
      margin-top:55px;
      margin-bottom:22px;
    }

    .mode-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:transparent;
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition:transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease, background 180ms ease, color 180ms ease;
    }

    .mode-btn:hover{
      border-color:var(--accent);
    }

    .mode-btn.active{
      background: var(--chip-active-bg);
      border-color: rgba(58,159,99,0.85);
      color:#061018;
      font-weight:600;
    }

    /* FOOTER */
    footer{
      border-top:1px solid rgba(255,255,255,0.05);
      padding:20px;
      font-size:12px;
      text-align:center;
      opacity:0.85;
      margin-top:40px;
    }

    footer .tagline{
      margin-bottom:6px;
      font-size:13px;
    }

    footer .links{
      display:flex;
      justify-content:center;
      gap:18px;
      font-size:13px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       YOUR-KEYS SPECIFIC STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    :root{
      --card-border: rgba(148,163,184,0.25);
      --genesis-gold:#f5c842;
      --keys-accent:#f5c842;
      --keys-accent-soft:#d4a012;
      --keys-chip-bg: linear-gradient(90deg, rgba(245,200,66,0.55), rgba(212,160,18,0.55));
    }

    /* Your Keys header in gold */
    h1.keys-title{
      color: var(--keys-accent);
    }

    /* Gold mode buttons for dashboard actions */
    .mode-btn.keys-btn{
      border-color: rgba(245,200,66,0.5);
    }

    .mode-btn.keys-btn:hover{
      border-color: var(--keys-accent);
    }

    .mode-btn.keys-btn.active{
      background: var(--keys-chip-bg);
      border-color: rgba(212,160,18,0.85);
      color:#061018;
      font-weight:600;
    }

    /* KEY CARDS */
    .keys-grid{
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:22px;
    }

    .key-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:18px;
      padding:24px;
      position:relative;
      overflow:hidden;
      transition:
        border-color 220ms ease,
        box-shadow 220ms ease,
        transform 220ms ease;
    }

    .key-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:18px;
      background:radial-gradient(circle at top, rgba(102,214,154,0.08), rgba(2,6,23,0.0) 62%);
      opacity:0.9;
    }

    .key-card > *{ position:relative; }

    .key-card:hover{
      transform:translateY(-2px);
      border-color:rgba(102,214,154,0.35);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.30),
        0 0 18px rgba(102,214,154,0.10);
    }

    .key-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }

    .key-id{
      font-size:20px;
      font-weight:600;
    }

    .genesis-badge{
      background:linear-gradient(90deg, var(--genesis-gold), #d4a012);
      color:#000;
      font-size:10px;
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }

    .key-glyphs{
      font-size:24px;
      letter-spacing:4px;
      margin-bottom:20px;
      font-family:"Segoe UI Symbol", "Apple Symbols", sans-serif;
    }

    .key-meta{
      display:flex;
      gap:24px;
      margin-bottom:20px;
      font-size:13px;
      color:var(--text-soft);
    }

    .key-meta span{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .key-meta a{ color:var(--accent); }

    /* ACTION BUTTONS ROW */
    .key-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .action-btn{
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 16px;
      background:rgba(15, 23, 42, 0.6);
      border:1px solid var(--card-border);
      border-radius:12px;
      font-size:13px;
      color:var(--text-main);
      cursor:pointer;
      transition:all 0.2s;
      text-decoration:none;
    }

    .action-btn:hover{
      border-color:var(--accent);
      background:rgba(102, 214, 154, 0.08);
    }

    .action-btn .label{ font-weight:500; }

    .action-btn .status{
      color:var(--text-soft);
      font-size:12px;
    }

    .action-btn .status.open{ color:var(--accent); }

    .action-btn .icon{ font-size:18px; }

    /* MINT MORE LINK */
    .mint-more{ margin-top:24px; }

    /* LOADING */
    .loading{
      color:var(--text-soft);
      font-size:14px;
      margin-top:22px;
    }

    /* RESPONSIVE */
    @media (max-width:600px){
      .key-header{ flex-direction:column; align-items:flex-start; gap:8px; }
      .key-meta{ flex-direction:column; gap:8px; }
      .key-actions{ flex-direction:column; }
      .action-btn{ width:100%; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior:auto !important; }
      .key-card{ transition:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="nav-inner">
    <a href="index.html" class="logo-link" aria-label="Z1N Protocol home">
      <div class="logo-dot">Î©</div>
      <div class="logo-text">Z1N PROTOCOL</div>
    </a>

    <nav class="nav-links">
      <a href="about.html">About</a>
      <a href="live-stats.html">Live Stats</a>
      <a href="artefacts.html">Artefacts</a>
      <a href="nbi-artefacts.html">4 NBIs</a>
      <a href="mint-key.html">Mint your Key</a>
      <a href="/your-keys.html" class="active-keys">Your Keys</a>
    </nav>
  </div>
</header>

<main class="page">
  <h1 class="keys-title">Your Keys</h1>

  <p class="lead">
    Your Keys are soulbound proofs of presence in the Field â€” each one a unique coordinate in the 21M-Key manifold.
  </p>

  <p class="lead-small">
    From here you can manage your signals, attestations, and artefacts. Each Key unlocks its own dashboard.
  </p>

  <!-- STATE: Not connected -->
  <div id="connectState">
    <div class="mode-row">
      <button id="btnConnect" class="mode-btn keys-btn active" type="button">Connect Wallet</button>
    </div>
  </div>

  <!-- STATE: Loading -->
  <div id="loadingState" class="loading" style="display:none;">
    Loading your Keys...
  </div>

  <!-- STATE: Connected (shows wallet address) -->
  <div id="connectedInfo" style="display:none; margin-bottom:20px;">
    <p class="lead-small" style="margin-bottom:12px;">
      Connected: <span id="walletAddress" style="color:var(--keys-accent); font-family:monospace;"></span>
    </p>
    <div class="mode-row" style="margin-top:0;">
      <button id="btnSwitch" class="mode-btn keys-btn" type="button">Switch Wallet</button>
      <button id="btnRefresh" class="mode-btn keys-btn" type="button">â†» Refresh Keys</button>
    </div>
  </div>

  <!-- STATE: No keys -->
  <div id="noKeysState" style="display:none;">
    <p class="lead-small" style="margin-bottom:16px;">
      This wallet has no Z1N Keys. If you own a Key on another wallet, use Switch Wallet above.
    </p>
    <div class="mode-row" style="margin-top:0;">
      <a href="mint-key.html" class="mode-btn">Mint your first Key</a>
    </div>
  </div>

  <!-- STATE: Has keys -->
  <div id="keysContainer" class="keys-grid" style="display:none;">
    <!-- Keys will be rendered here -->
  </div>

  <div id="mintMoreSection" class="mint-more" style="display:none;">
    <a href="mint-key.html" class="mode-btn">+ Mint another Key</a>
  </div>
</main>

<footer>
  <div class="tagline">Your presence is real Â· The Field remembers</div>
  <div class="links">
    <a href="https://github.com/z1nprotocol" target="_blank" rel="noreferrer">GitHub</a>
    <a href="https://x.com/z1n_AI" target="_blank" rel="noreferrer">X</a>
  </div>
</footer>

<script>
(function() {
  "use strict";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var Z1N_KEY = '0x71B31cb8FC0e4D538c2865FeBBfC8C56f41a00d6';
  var RPC_URLS = [
    'https://rpc-amoy.polygon.technology',
    'https://polygon-amoy.drpc.org',
    'https://polygon-amoy-bor-rpc.publicnode.com'
  ];
  var RPC_URL = RPC_URLS[0];
  var EXPLORER = 'https://amoy.polygonscan.com';

  // Glyph symbols (21 sacred symbols)
  var GLYPHS = ['â—‡', 'â—†', 'â—‹', 'â—', 'â–³', 'â–½', 'â–¡', 'â– ', 'â˜†', 'â˜…', 'â—', 'â—‰', 'â¬¡', 'â¬¢', 'âˆ…', 'âˆ', 'âŠ•', 'âŠ—', 'âŒ¬', 'âŸ', 'Î©'];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ELEMENTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var connectState = document.getElementById('connectState');
  var connectedInfo = document.getElementById('connectedInfo');
  var walletAddressEl = document.getElementById('walletAddress');
  var btnSwitch = document.getElementById('btnSwitch');
  var btnRefresh = document.getElementById('btnRefresh');
  var loadingState = document.getElementById('loadingState');
  var noKeysState = document.getElementById('noKeysState');
  var keysContainer = document.getElementById('keysContainer');
  var mintMoreSection = document.getElementById('mintMoreSection');
  var btnConnect = document.getElementById('btnConnect');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var provider = null;
  var currentAccount = null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RPC HELPER (with fallback)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function rpcCall(method, params) {
    console.log('RPC call:', method, params);
    
    for (var i = 0; i < RPC_URLS.length; i++) {
      try {
        var response = await fetch(RPC_URLS[i], {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: method, params: params })
        });
        var data = await response.json();
        console.log('RPC result from', RPC_URLS[i], ':', data);
        if (data.error) throw new Error(data.error.message);
        return data.result;
      } catch (e) {
        console.warn('RPC failed for', RPC_URLS[i], ':', e.message);
        if (i === RPC_URLS.length - 1) throw e;
      }
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTRACT HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  function getKeyBalance(address) {
    var selector = '0x70a08231';
    var paddedAddr = address.slice(2).toLowerCase().padStart(64, '0');
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: selector + paddedAddr }, 'latest'])
      .then(function(result) { return parseInt(result, 16); });
  }

  function getTokenOfOwnerByIndex(address, index) {
    var selector = '0x2f745c59';
    var paddedAddr = address.slice(2).toLowerCase().padStart(64, '0');
    var paddedIdx = index.toString(16).padStart(64, '0');
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: selector + paddedAddr + paddedIdx }, 'latest'])
      .then(function(result) { return parseInt(result, 16); });
  }

  function isGenesis(tokenId) {
    var selector = '0x63240e4e';
    var paddedId = tokenId.toString(16).padStart(64, '0');
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: selector + paddedId }, 'latest'])
      .then(function(result) { return parseInt(result, 16) === 1; });
  }

  function getGlyphs(tokenId) {
    var selector = '0x0c85e85e';
    var paddedId = tokenId.toString(16).padStart(64, '0');
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: selector + paddedId }, 'latest'])
      .then(function(result) {
        var len = parseInt(result.slice(0, 66), 16);
        var pack = BigInt('0x' + result.slice(66));
        return { len: len, pack: pack };
      });
  }

  function getVotingPower(tokenId) {
    var selector = '0x9168ae72';
    var paddedId = tokenId.toString(16).padStart(64, '0');
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: selector + paddedId }, 'latest'])
      .then(function(result) { return parseInt(result, 16) / 1e18; })
      .catch(function() { return 1; });
  }

  function decodeGlyphs(len, pack) {
    var symbols = [];
    for (var i = 0; i < len; i++) {
      var idx = Number((pack >> BigInt(i * 8)) & BigInt(0xFF));
      if (idx < GLYPHS.length) {
        symbols.push(GLYPHS[idx]);
      }
    }
    return symbols.join(' ');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function shortenAddress(addr) {
    return addr.slice(0, 6) + '...' + addr.slice(-4);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UI STATES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showState(state) {
    connectState.style.display = state === 'connect' ? 'block' : 'none';
    connectedInfo.style.display = (state === 'loading' || state === 'nokeys' || state === 'keys') ? 'block' : 'none';
    loadingState.style.display = state === 'loading' ? 'block' : 'none';
    noKeysState.style.display = state === 'nokeys' ? 'block' : 'none';
    keysContainer.style.display = state === 'keys' ? 'flex' : 'none';
    mintMoreSection.style.display = state === 'keys' ? 'block' : 'none';
    
    // Update wallet address display
    if (currentAccount) {
      walletAddressEl.textContent = shortenAddress(currentAccount);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER KEY CARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderKeyCard(key) {
    var card = document.createElement('div');
    card.className = 'key-card';

    var genesisHtml = key.genesis ? '<span class="genesis-badge">âš’ Genesis</span>' : '';

    card.innerHTML = 
      '<div class="key-header">' +
        '<span class="key-id">Key #' + key.tokenId + '</span>' +
        genesisHtml +
      '</div>' +
      '<div class="key-glyphs">' + key.glyphSymbols + '</div>' +
      '<div class="key-meta">' +
        '<span>ğŸ“… Minted Epoch ' + key.epoch + '</span>' +
        '<span>âš¡ Voting Power ' + key.votingPower + 'x</span>' +
        '<span><a href="' + EXPLORER + '/token/' + Z1N_KEY + '?a=' + key.tokenId + '" target="_blank">View on chain â†—</a></span>' +
      '</div>' +
      '<div class="key-actions">' +
        '<a href="signals.html?key=' + key.tokenId + '" class="action-btn">' +
          '<span class="icon">ğŸ“¡</span>' +
          '<span class="label">Signals</span>' +
          '<span class="status open">1/2 open</span>' +
        '</a>' +
        '<a href="signals.html?key=' + key.tokenId + '&tab=attest" class="action-btn">' +
          '<span class="icon">âœ“</span>' +
          '<span class="label">Attestations</span>' +
          '<span class="status open">2/2 open</span>' +
        '</a>' +
        '<a href="my-artefacts.html?key=' + key.tokenId + '" class="action-btn">' +
          '<span class="icon">â—ˆ</span>' +
          '<span class="label">Artefacts</span>' +
          '<span class="status">1 live</span>' +
        '</a>' +
      '</div>';

    return card;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOAD KEYS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadKeys() {
    showState('loading');
    console.log('Loading keys for:', currentAccount);
    
    // Reset no keys message
    noKeysState.querySelector('p').textContent = 'This wallet has no Z1N Keys. If you own a Key on another wallet, use Switch Wallet above.';

    try {
      var balance = await getKeyBalance(currentAccount);
      console.log('Key balance:', balance);

      if (balance === 0) {
        console.log('No keys found for this wallet');
        showState('nokeys');
        return;
      }

      var keys = [];

      for (var i = 0; i < balance; i++) {
        var tokenId = await getTokenOfOwnerByIndex(currentAccount, i);
        console.log('Found tokenId:', tokenId);
        var genesis = await isGenesis(tokenId);
        var glyphData = await getGlyphs(tokenId);
        var votingPower = await getVotingPower(tokenId);
        
        var epoch = Math.floor(tokenId / 2) + 1;

        keys.push({
          tokenId: tokenId,
          genesis: genesis,
          glyphSymbols: decodeGlyphs(glyphData.len, glyphData.pack),
          epoch: epoch,
          votingPower: votingPower
        });
      }

      keysContainer.innerHTML = '';
      keys.forEach(function(key) {
        keysContainer.appendChild(renderKeyCard(key));
      });

      showState('keys');

    } catch (err) {
      console.error('Error loading keys:', err);
      // Show error in UI for debugging
      noKeysState.querySelector('p').textContent = 'RPC Error: ' + err.message + '. Try clicking Refresh Keys.';
      showState('nokeys');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GET ETHEREUM PROVIDER (prefer MetaMask when multiple wallets)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getProvider() {
    if (window.ethereum?.providers) {
      // Multiple wallets - find MetaMask
      return window.ethereum.providers.find(function(p) { return p.isMetaMask; }) || window.ethereum;
    }
    return window.ethereum;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONNECT WALLET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function connectWallet() {
    var eth = getProvider();
    if (!eth) {
      alert('Please install a Web3 wallet');
      return;
    }

    btnConnect.textContent = 'Connecting...';

    try {
      var accounts = await eth.request({ method: 'eth_requestAccounts' });
      if (accounts[0]) {
        currentAccount = accounts[0];
        provider = eth;
        loadKeys();
      }
    } catch (e) {
      console.error(e);
      btnConnect.textContent = 'Connect Wallet';
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SWITCH WALLET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function switchWallet() {
    var eth = getProvider();
    if (!eth) return;

    try {
      // Request wallet to show account picker
      await eth.request({
        method: 'wallet_requestPermissions',
        params: [{ eth_accounts: {} }]
      });
      // After permission granted, get the new account
      var accounts = await eth.request({ method: 'eth_requestAccounts' });
      if (accounts[0]) {
        currentAccount = accounts[0];
        provider = eth;
        loadKeys();
      }
    } catch (e) {
      console.error('Switch error:', e);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  btnConnect.onclick = connectWallet;
  btnSwitch.onclick = switchWallet;
  btnRefresh.onclick = function() {
    if (currentAccount) loadKeys();
  };

  // Listen for account changes
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', function(accounts) {
      if (accounts[0]) {
        currentAccount = accounts[0];
        loadKeys();
      } else {
        showState('connect');
      }
    });
  }

  // Auto-connect if already connected
  (async function() {
    var eth = getProvider();
    if (eth) {
      try {
        var accounts = await eth.request({ method: 'eth_accounts' });
        if (accounts[0]) {
          provider = eth;
          currentAccount = accounts[0];
          loadKeys();
        }
      } catch (e) {}
    }
  })();

})();
</script>

</body>
</html>
