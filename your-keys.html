<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Z1N Protocol – Your Keys</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#050812;
      --card-bg:#020617;
      --text-main:#ffffff;
      --text-soft:#9aa3bb;

      --accent:#66d69a;
      --accent-soft:#3a9f63;

      --border-soft: rgba(148,163,184,0.35);
      --border-strong: rgba(102,214,154,0.75);

      --chip-active-bg: linear-gradient(90deg, rgba(102,214,154,0.55), rgba(58,159,99,0.55));
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    html{
      scrollbar-gutter: stable;
      overflow-y: scroll;
      scroll-behavior:smooth;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ opacity:0.9; }

    /* HEADER — align like artefacts.html */
    header{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom:1px solid rgba(255,255,255,0.05);
      margin-bottom:20px;
    }

    .nav-inner{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .logo-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .logo-dot{
      width:24px;
      height:24px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      line-height:1;
    }

    .logo-text{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.7;
    }

    .nav-links{
      display:flex;
      gap:22px;
      font-size:13px;
      opacity:0.85;
    }

    .nav-links a{ position:relative; }
    .nav-links a.active{ color:var(--accent); }
    .nav-links a.active-keys{ color:var(--keys-accent, #f5c842); }

    .nav-links a.active::after{
      content:"";
      position:absolute;
      left:0;
      bottom:-4px;
      width:100%;
      height:2px;
      border-radius:999px;
      background:linear-gradient(to right, var(--accent), var(--accent-soft));
    }

    .nav-links a.active-keys::after{
      content:"";
      position:absolute;
      left:0;
      bottom:-4px;
      width:100%;
      height:2px;
      border-radius:999px;
      background:linear-gradient(to right, #f5c842, #d4a012);
    }

    @media(max-width:900px){
      .nav-inner{ padding:0 16px; }
      .nav-links{
        font-size:12px;
        gap:14px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
    }

    /* PAGE */
    .page{
      max-width:1200px;
      margin:0 auto;
      padding:40px 24px 72px;
    }

    @media(max-width:900px){
      .page{ padding:32px 18px 56px; }
    }

    h1{
      font-size:40px;
      letter-spacing:-0.02em;
      margin:0 0 10px 0;
    }

    .lead{
      font-size:17px;
      line-height:1.6;
      opacity:0.85;
      max-width:900px;
      margin-bottom:6px;
    }

    .lead-small{
      font-size:14px;
      line-height:1.6;
      opacity:0.7;
      max-width:900px;
      margin-bottom:18px;
    }

    /* MODE BUTTONS — mint-key style */
    .mode-row{
      display:flex;
      gap:12px;
      margin-top:55px;
      margin-bottom:22px;
    }

    .mode-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:transparent;
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition:transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease, background 180ms ease, color 180ms ease;
    }

    .mode-btn:hover{
      border-color:var(--accent);
    }

    .mode-btn.active{
      background: var(--chip-active-bg);
      border-color: rgba(58,159,99,0.85);
      color:#061018;
      font-weight:600;
    }

    /* FOOTER */
    footer{
      border-top:1px solid rgba(255,255,255,0.05);
      padding:20px;
      font-size:12px;
      text-align:center;
      opacity:0.85;
      margin-top:40px;
    }

    footer .tagline{
      margin-bottom:6px;
      font-size:13px;
    }

    footer .links{
      display:flex;
      justify-content:center;
      gap:18px;
      font-size:13px;
    }

    /* ══════════════════════════════════════════════════════════════════
       YOUR-KEYS SPECIFIC STYLES
       ══════════════════════════════════════════════════════════════════ */

    :root{
      --card-border: rgba(148,163,184,0.25);
      --genesis-gold:#f5c842;
      --keys-accent:#f5c842;
      --keys-accent-soft:#d4a012;
      --keys-chip-bg: linear-gradient(90deg, rgba(245,200,66,0.55), rgba(212,160,18,0.55));
    }

    /* Your Keys header in gold */
    h1.keys-title{
      color: var(--keys-accent);
    }

    /* Gold mode buttons for dashboard actions */
    .mode-btn.keys-btn{
      border-color: rgba(245,200,66,0.5);
    }

    .mode-btn.keys-btn:hover{
      border-color: var(--keys-accent);
    }

    .mode-btn.keys-btn.active{
      background: var(--keys-chip-bg);
      border-color: rgba(212,160,18,0.85);
      color:#061018;
      font-weight:600;
    }

    /* Wallet selector grid buttons */
    #walletOptions .mode-btn {
      width: 100%;
      justify-content: center;
    }

    /* KEY CARDS - Grid layout for multiple (max 5 per row) */
    .keys-grid{
      display:grid !important;
      grid-template-columns: repeat(5, 1fr) !important;
      gap:16px;
      margin-top:22px;
    }
    
    /* Responsive: fewer columns on smaller screens */
    @media (max-width: 1400px) {
      .keys-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 1100px) {
      .keys-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 800px) {
      .keys-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 500px) {
      .keys-grid {
        grid-template-columns: 1fr;
      }
    }

    .key-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:14px;
      padding:20px;
      position:relative;
      overflow:hidden;
      transition:
        border-color 220ms ease,
        box-shadow 220ms ease,
        transform 220ms ease;
    }

    .key-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      border-radius:14px;
      background:radial-gradient(circle at top, rgba(102,214,154,0.08), rgba(2,6,23,0.0) 62%);
      opacity:0.9;
    }

    .key-card > *{ position:relative; }

    .key-card:hover{
      transform:translateY(-2px);
      border-color:rgba(245,200,66,0.35);
      box-shadow:
        0 4px 14px rgba(0,0,0,0.25),
        0 0 14px rgba(245,200,66,0.08);
    }

    .key-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .key-id{
      font-size:18px;
      font-weight:600;
    }

    .genesis-badge{
      background:linear-gradient(90deg, var(--genesis-gold), #d4a012);
      color:#000;
      font-size:9px;
      font-weight:700;
      padding:3px 8px;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }

    .key-glyphs{
      font-size:16px;
      letter-spacing:1px;
      margin-bottom:10px;
      font-family:"Segoe UI Symbol", "Apple Symbols", sans-serif;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .key-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:14px;
      font-size:11px;
      color:var(--text-soft);
    }

    .key-meta span{
      display:flex;
      align-items:center;
      gap:4px;
    }

    .key-meta a{ color:var(--accent); }

    /* CARD SECTIONS */
    .card-section{
      padding-top:12px;
      margin-top:12px;
      border-top:1px solid rgba(148,163,184,0.15);
    }

    .section-header{
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.1em;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    /* STATUS GRID (Signals/Attestations) */
    .status-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px;
    }

    .status-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 10px;
      background:rgba(15, 23, 42, 0.4);
      border:1px solid rgba(148,163,184,0.2);
      border-radius:6px;
      font-size:11px;
      color:var(--text-main);
      text-decoration:none;
      transition:all 0.2s;
    }

    .status-item:hover{
      border-color:var(--keys-accent);
      background:rgba(245, 200, 66, 0.08);
    }

    .status-label{
      color:var(--text-soft);
    }

    .status-filled{
      color:#4ade80;
      font-size:14px;
      text-shadow: 0 0 2px rgba(74, 222, 128, 0.5);
    }

    .status-open{
      color:var(--keys-accent);
      font-size:14px;
    }

    /* Unified dot indicators */
    .dot-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid;
    }
    
    .dot-indicator.filled {
      background: #4ade80;
      border-color: #4ade80;
    }
    
    .dot-indicator.open {
      background: transparent;
      border-color: var(--keys-accent);
    }

    /* ARTEFACTS SECTION */
    .artefact-stats{
      display:flex;
      gap:16px;
      margin-bottom:10px;
      font-size:12px;
    }

    .artefact-stat{
      color:var(--text-soft);
    }

    .artefact-stat .count{
      color:var(--text-main);
      font-weight:600;
    }

    .artefact-actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px;
    }

    .mint-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      background:rgba(15, 23, 42, 0.4);
      border:1px solid rgba(245, 200, 66, 0.35);
      border-radius:6px;
      font-size:11px;
      color:var(--text-main);
      cursor:pointer;
      transition:all 0.2s ease;
      text-decoration:none;
      text-align:center;
    }

    .mint-btn:hover{
      border-color:var(--keys-accent);
      background:rgba(245, 200, 66, 0.15);
    }

    .mint-btn:active{
      background:rgba(212, 160, 18, 0.35);
      border-color:var(--keys-accent-soft);
    }

    /* MINT MORE LINK */
    .mint-more{ margin-top:24px; }

    /* LOADING */
    .loading{
      color:var(--text-soft);
      font-size:14px;
      margin-top:22px;
    }

    /* RESPONSIVE */
    @media (max-width:600px){
      .key-header{ flex-direction:column; align-items:flex-start; gap:8px; }
      .key-meta{ flex-direction:column; gap:8px; }
      .key-actions{ flex-direction:column; }
      .action-btn{ width:100%; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior:auto !important; }
      .key-card{ transition:none; }
    }

    /* STEALTH TOGGLE */
    .settings-section {
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      padding-top: 12px;
      margin-top: 8px;
    }

    .stealth-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-container {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }

    .toggle-container input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(148, 163, 184, 0.3);
      border-radius: 22px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: var(--text-soft);
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-container input:checked + .toggle-slider {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .toggle-container input:checked + .toggle-slider:before {
      transform: translateX(18px);
      background-color: #ffffff;
    }

    .toggle-label {
      font-size: 12px;
      color: var(--text-soft);
    }

    .stealth-toggle:has(input:checked) .toggle-label {
      color: #ffffff;
    }

    .stealth-info {
      font-size: 14px;
      color: var(--text-soft);
      cursor: help;
      opacity: 0.7;
      position: relative;
    }

    .stealth-info:hover {
      opacity: 1;
      color: var(--keys-accent);
    }

    /* Tooltip for stealth info */
    .stealth-info[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      max-width: 280px;
      white-space: normal;
      z-index: 100;
      border: 1px solid var(--card-border);
      margin-bottom: 5px;
    }
  </style>
</head>

<body>
<header>
  <div class="nav-inner">
    <a href="index.html" class="logo-link" aria-label="Z1N Protocol home">
      <div class="logo-dot">Ω</div>
      <div class="logo-text">Z1N PROTOCOL</div>
    </a>

    <nav class="nav-links">
      <a href="about.html">About</a>
      <a href="live-stats.html">Live Stats</a>
      <a href="artefacts.html">Artefacts</a>
      <a href="nbi-artefacts.html">4 NBIs</a>
      <a href="mint-key.html">Mint your Key</a>
      <a href="/your-keys.html" class="active-keys">Your Keys</a>
    </nav>
  </div>
</header>

<main class="page">
  <h1 class="keys-title">Your Keys</h1>

  <p class="lead">
    Your Keys are soulbound proofs of presence in the Field — each one a unique coordinate in the 21M-Key manifold.
  </p>

  <p class="lead-small">
    From here you can manage your signals, attestations, and artefacts. Each Key unlocks its own dashboard.
  </p>

  <!-- STATE: Not connected -->
  <div id="connectState">
    <div class="mode-row">
      <button id="btnConnect" class="mode-btn keys-btn active" type="button">Connect Wallet</button>
    </div>
  </div>

  <!-- STATE: Loading -->
  <div id="loadingState" class="loading" style="display:none;">
    Loading your Keys...
  </div>

  <!-- STATE: Connected (shows wallet address) -->
  <div id="connectedInfo" style="display:none; margin-bottom:20px;">
    <p class="lead-small" style="margin-bottom:12px;">
      Connected: <span id="walletAddress" style="color:var(--keys-accent); font-family:monospace;"></span>
    </p>
    
    <!-- Multi-wallet selector (hidden by default) -->
    <div id="multiWalletSelector" style="display:none; margin-bottom:16px; padding:14px; background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.3); border-radius:10px;">
      <p style="font-size:13px; color:#fbbf24; margin-bottom:6px;">⚠️ Multiple wallets connected</p>
      <p style="font-size:12px; color:var(--text-soft); margin-bottom:12px;">Select which wallet to use below, or connect only one wallet in your wallet app.</p>
      <div id="walletOptions" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:8px;"></div>
    </div>
    
    <div class="mode-row" style="margin-top:0;">
      <button id="btnSwitch" class="mode-btn keys-btn" type="button">Switch Wallet</button>
    </div>
  </div>

  <!-- STATE: No keys -->
  <div id="noKeysState" style="display:none;">
    <p class="lead-small" style="margin-bottom:16px;">
      This wallet has no Z1N Keys. If you own a Key on another wallet, use Switch Wallet above.
    </p>
    <div class="mode-row" style="margin-top:0;">
      <a href="mint-key.html" class="mode-btn">Mint your first Key</a>
    </div>
  </div>

  <!-- STATE: Has keys -->
  <div id="keysToolbar" style="display:none; margin-bottom:16px;">
    <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
      <div class="mode-row" style="margin-top:0; margin-bottom:0;">
        <button id="btnRefresh" class="mode-btn keys-btn" type="button">↻ Refresh</button>
      </div>
      <span style="font-size:12px; color:var(--text-soft);">Current Epoch: <span id="currentEpoch" style="color:var(--keys-accent); font-weight:600;">—</span></span>
    </div>
  </div>

  <div id="keysContainer" class="keys-grid" style="display:none;">
    <!-- Keys will be rendered here -->
  </div>

  <div id="mintMoreSection" class="mint-more" style="display:none;">
    <a href="mint-key.html" class="mode-btn">+ Mint another Key</a>
  </div>
</main>

<footer>
  <div class="tagline">Your presence is real · The Field remembers</div>
  <div class="links">
    <a href="https://github.com/z1nprotocol" target="_blank" rel="noreferrer">GitHub</a>
    <a href="https://x.com/z1n_AI" target="_blank" rel="noreferrer">X</a>
  </div>
</footer>

<script>
(function() {
  "use strict";

  // ═══════════════════════════════════════════════════════════════════
  // CONFIG
  // ═══════════════════════════════════════════════════════════════════
  var Z1N_KEY = '0x71B31cb8FC0e4D538c2865FeBBfC8C56f41a00d6';
  var Z1N_CORE = '0xade14831356722154A39D40a8EBd4ee1FD4c7D6a';
  var Z1N_SIGNAL = '0x85f0A512cd246A6e659E2D188763482F587dc9f7';
  var Z1N_ARTEFACT = '0xCCf86c34Bbf38C7FEDB621D66ea691AA51Ebbf05';
  var Z1N_STATIC_ARTEFACT = '0x315a67275841E3cCE0f7e8B84B7B7B4F588016AA';
  var RPC_URLS = [
    'https://rpc-amoy.polygon.technology',
    'https://polygon-amoy.drpc.org',
    'https://polygon-amoy-bor-rpc.publicnode.com'
  ];
  var RPC_URL = RPC_URLS[0];
  var EXPLORER = 'https://amoy.polygonscan.com';

  // Function selectors (keccak256 first 4 bytes - calculated)
  var SEL = {
    // Z1NKey (ERC721Enumerable)
    balanceOf: '0x70a08231',              // balanceOf(address)
    tokenOfOwnerByIndex: '0x2f745c59',    // tokenOfOwnerByIndex(address,uint256)
    isGenesis: '0xf1e25ea8',              // isGenesis(uint256)
    glyphs: '0x887296c3',                 // glyphs(uint256) returns (uint8,uint40)
    glyphEpochOf: '0x5e5cd9a5',           // glyphEpochOf(uint256)
    // Z1NCore
    currentEpoch: '0x76671808',           // currentEpoch()
    // Z1NSignal
    signalCount: '0xfd68f0e5',            // signalCount(uint256,uint256)
    attestCount: '0xfe6569d7',            // attestCount(uint256,uint256)
    remainingSignals: '0xcf819017',       // remainingSignals(uint256)
    remainingAttests: '0x3738130b',       // remainingAttests(uint256)
    // Z1NArtefact
    primaryArtefactOfKey: '0xff84f877',   // primaryArtefactOfKey(uint256)
    // Z1NStaticArtefact
    staticArtefactOfKey: '0x8d6786a8',    // staticArtefactOfKey(uint256)
  };

  // Glyph symbols - EXACT match with Z1NSymbolsLib (index 0-20)
  var GLYPHS = [
    '∞',  // 0:  Infinity       - Being
    'π',  // 1:  Pi             - Being
    '⋮',  // 2:  Ellipsis       - Being
    '⊕',  // 3:  Direct sum     - Being
    '⊗',  // 4:  Tensor         - Being
    '∴',  // 5:  Therefore      - Reflection
    '∵',  // 6:  Because        - Reflection
    '↔',  // 7:  Bidirectional  - Reflection
    '↻',  // 8:  Cycle          - Reflection
    '△',  // 9:  Triangle       - Reflection
    '◇',  // 10: Diamond        - Structure
    '○',  // 11: Circle         - Structure
    '●',  // 12: Filled circle  - Structure
    '□',  // 13: Square         - Structure
    '☰',  // 14: Trigram heaven - Structure
    '☷',  // 15: Trigram earth  - Creativity
    '⚑',  // 16: Flag           - Creativity
    '✱',  // 17: Star           - Creativity
    '⊥',  // 18: Orthogonal     - Creativity
    '≡',  // 19: Identical      - Creativity
    '◊'   // 20: Alchemical     - Creativity
  ];

  // ═══════════════════════════════════════════════════════════════════
  // ELEMENTS
  // ═══════════════════════════════════════════════════════════════════
  var connectState = document.getElementById('connectState');
  var connectedInfo = document.getElementById('connectedInfo');
  var walletAddressEl = document.getElementById('walletAddress');
  var btnSwitch = document.getElementById('btnSwitch');
  var loadingState = document.getElementById('loadingState');
  var noKeysState = document.getElementById('noKeysState');
  var keysToolbar = document.getElementById('keysToolbar');
  var keysContainer = document.getElementById('keysContainer');
  var mintMoreSection = document.getElementById('mintMoreSection');
  var btnConnect = document.getElementById('btnConnect');
  var btnRefresh = document.getElementById('btnRefresh');

  // ═══════════════════════════════════════════════════════════════════
  // STATE
  // ═══════════════════════════════════════════════════════════════════
  var provider = null;
  var currentAccount = null;
  var allConnectedAccounts = [];

  // ═══════════════════════════════════════════════════════════════════
  // URL HELPERS
  // ═══════════════════════════════════════════════════════════════════
  function getUrlParam(name) {
    var params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // ═══════════════════════════════════════════════════════════════════
  // WALLET SELECTOR (for multiple connected accounts)
  // ═══════════════════════════════════════════════════════════════════
  function showWalletSelector(accounts) {
    var selector = document.getElementById('multiWalletSelector');
    var options = document.getElementById('walletOptions');
    
    if (accounts.length <= 1) {
      selector.style.display = 'none';
      return;
    }
    
    selector.style.display = 'block';
    options.innerHTML = '';
    
    accounts.forEach(function(addr, idx) {
      var isSelected = addr.toLowerCase() === currentAccount?.toLowerCase();
      var btn = document.createElement('button');
      btn.className = 'mode-btn keys-btn' + (isSelected ? ' active' : '');
      btn.style.cssText = 'width:100%; padding:10px 12px; font-family:monospace; font-size:12px; text-align:center;';
      btn.innerHTML = (isSelected ? '✓ ' : '') + addr.slice(0, 6) + '...' + addr.slice(-4);
      btn.dataset.address = addr;
      btn.onclick = function() {
        selectWallet(addr);
      };
      options.appendChild(btn);
    });
  }
  
  function selectWallet(addr) {
    currentAccount = addr;
    walletAddressEl.textContent = shortenAddress(addr);
    
    // Re-render the wallet selector to update checkmarks
    showWalletSelector(allConnectedAccounts);
    
    // Reload keys for selected wallet
    loadKeys();
  }

  // ═══════════════════════════════════════════════════════════════════
  // RPC HELPER (with fallback)
  // ═══════════════════════════════════════════════════════════════════
  async function rpcCall(method, params) {
    console.log('RPC call:', method, params);
    
    for (var i = 0; i < RPC_URLS.length; i++) {
      try {
        var response = await fetch(RPC_URLS[i], {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: method, params: params })
        });
        var data = await response.json();
        console.log('RPC result from', RPC_URLS[i], ':', data);
        if (data.error) throw new Error(data.error.message);
        return data.result;
      } catch (e) {
        console.warn('RPC failed for', RPC_URLS[i], ':', e.message);
        if (i === RPC_URLS.length - 1) throw e;
      }
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // CONTRACT HELPERS (with correct selectors from keccak256)
  // ═══════════════════════════════════════════════════════════════════
  
  // Helper to encode uint256
  function encodeUint256(val) {
    return val.toString(16).padStart(64, '0');
  }
  
  // Helper to encode address
  function encodeAddress(addr) {
    return addr.slice(2).toLowerCase().padStart(64, '0');
  }
  
  // balanceOf(address) - 0x70a08231
  function getKeyBalance(address) {
    var data = SEL.balanceOf + encodeAddress(address);
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest'])
      .then(function(result) { 
        var balance = parseInt(result, 16);
        console.log('Key balance for', address, '=', balance);
        return balance;
      });
  }

  // tokenOfOwnerByIndex(address,uint256) - 0x2f745c59
  function getTokenOfOwnerByIndex(address, index) {
    var data = SEL.tokenOfOwnerByIndex + encodeAddress(address) + encodeUint256(index);
    return rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest'])
      .then(function(result) { return parseInt(result, 16); });
  }

  // isGenesis(uint256) - 0xf1e25ea8
  async function isGenesis(tokenId) {
    try {
      var data = SEL.isGenesis + encodeUint256(tokenId);
      var result = await rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest']);
      var isGen = parseInt(result, 16) === 1;
      console.log('isGenesis(' + tokenId + ') =', isGen);
      return isGen;
    } catch (e) {
      console.log('isGenesis call failed, using tokenId < 21000 fallback:', e.message);
      return tokenId < 21000;
    }
  }

  // glyphs(uint256) - 0x887296c3 - returns (uint8 len, uint40 pack)
  async function getGlyphs(tokenId) {
    var paddedId = encodeUint256(tokenId);
    var result = { len: 0, pack: BigInt(0), epoch: null };
    
    try {
      // glyphs(uint256) → (uint8, uint40)
      var data = SEL.glyphs + paddedId;
      var response = await rpcCall('eth_call', [{ to: Z1N_KEY, data: data }, 'latest']);
      
      if (response && response !== '0x' && response.length >= 130) {
        // ABI decode: (uint8, uint40) - both padded to 32 bytes
        var len = parseInt(response.slice(2, 66), 16);
        var pack = BigInt('0x' + response.slice(66, 130));
        
        if (len === 6 || len === 7) {
          console.log('glyphs(' + tokenId + ') = len:', len, 'pack:', pack.toString(16));
          result.len = len;
          result.pack = pack;
        }
      }
      
      // glyphEpochOf(uint256) - 0x5e5cd9a5
      var epochData = SEL.glyphEpochOf + paddedId;
      var epochResponse = await rpcCall('eth_call', [{ to: Z1N_KEY, data: epochData }, 'latest']);
      if (epochResponse && epochResponse !== '0x' && epochResponse.length >= 66) {
        var epochVal = parseInt(epochResponse, 16);
        if (epochVal >= 0 && epochVal < 100000) {
          result.epoch = epochVal;
          console.log('glyphEpochOf(' + tokenId + ') =', epochVal);
        }
      }
      
    } catch (e) {
      console.log('getGlyphs failed for token', tokenId, ':', e.message);
    }
    
    return result;
  }

  // signalCount(uint256,uint256) - 0xfd68f0e5
  async function getSignalCount(tokenId, epoch) {
    try {
      var data = SEL.signalCount + encodeUint256(tokenId) + encodeUint256(epoch);
      var result = await rpcCall('eth_call', [{ to: Z1N_SIGNAL, data: data }, 'latest']);
      var count = parseInt(result, 16);
      console.log('signalCount(' + tokenId + ', ' + epoch + ') =', count);
      return count;
    } catch (e) {
      console.log('signalCount failed:', e.message);
      return 0;
    }
  }

  // attestCount(uint256,uint256) - 0xfe6569d7
  async function getAttestCount(tokenId, epoch) {
    try {
      var data = SEL.attestCount + encodeUint256(tokenId) + encodeUint256(epoch);
      var result = await rpcCall('eth_call', [{ to: Z1N_SIGNAL, data: data }, 'latest']);
      var count = parseInt(result, 16);
      console.log('attestCount(' + tokenId + ', ' + epoch + ') =', count);
      return count;
    } catch (e) {
      console.log('attestCount failed:', e.message);
      return 0;
    }
  }

  // Get artefact counts for a key
  // primaryArtefactOfKey(uint256) - 0xff84f877 on Z1NArtefact
  // staticArtefactOfKey(uint256) - 0x8d6786a8 on Z1NStaticArtefact
  async function getArtefactCounts(tokenId) {
    var counts = { live: 0, static: 0 };
    
    try {
      // Check if key has a primary live artefact
      var liveData = SEL.primaryArtefactOfKey + encodeUint256(tokenId);
      var liveResult = await rpcCall('eth_call', [{ to: Z1N_ARTEFACT, data: liveData }, 'latest']);
      if (liveResult && liveResult !== '0x') {
        var liveId = parseInt(liveResult, 16);
        if (liveId > 0) {
          counts.live = 1;
        }
      }
    } catch (e) {
      console.log('primaryArtefactOfKey failed:', e.message);
    }
    
    try {
      // Check if key has a static artefact
      var staticData = SEL.staticArtefactOfKey + encodeUint256(tokenId);
      var staticResult = await rpcCall('eth_call', [{ to: Z1N_STATIC_ARTEFACT, data: staticData }, 'latest']);
      if (staticResult && staticResult !== '0x') {
        var staticId = parseInt(staticResult, 16);
        if (staticId > 0) {
          counts.static = 1;
        }
      }
    } catch (e) {
      console.log('staticArtefactOfKey failed:', e.message);
    }
    
    console.log('artefactCounts(' + tokenId + ') = live:', counts.live, 'static:', counts.static);
    return counts;
  }

  // Get current epoch from Core contract - 0x76671808
  async function getCurrentEpoch() {
    try {
      var result = await rpcCall('eth_call', [{ to: Z1N_CORE, data: SEL.currentEpoch }, 'latest']);
      var epoch = parseInt(result, 16);
      console.log('currentEpoch() =', epoch);
      return epoch;
    } catch (e) {
      console.log('currentEpoch call failed:', e.message);
      return null;
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // GLYPH DECODING (5-bit unpacking - matches Z1NSymbolsLib)
  // ═══════════════════════════════════════════════════════════════════
  // Z1NSymbolsLib packs glyphs as:
  //   packed |= uint40(idx) << (5 * (MAX_FUSE - 1 - i))
  // Where MAX_FUSE = 7, so slots are at bits: 30, 25, 20, 15, 10, 5, 0
  function decodeGlyphs(len, pack) {
    if (len === 0 || pack === BigInt(0)) {
      return null; // No glyphs assigned yet
    }
    
    var MAX_FUSE = 7;
    var symbols = [];
    
    for (var i = 0; i < len; i++) {
      // Extract 5 bits from correct position
      var shift = BigInt(5 * (MAX_FUSE - 1 - i));
      var idx = Number((pack >> shift) & BigInt(0x1F)); // 0x1F = 5 bits
      
      if (idx < GLYPHS.length) {
        symbols.push(GLYPHS[idx]);
      }
    }
    
    return '<span style="color:#fff">' + symbols.join('</span><span style="color:#5d6680;margin:0 2px">·</span><span style="color:#fff">') + '</span>';
  }

  // ═══════════════════════════════════════════════════════════════════
  // HELPERS
  // ═══════════════════════════════════════════════════════════════════
  function shortenAddress(addr) {
    return addr.slice(0, 6) + '...' + addr.slice(-4);
  }

  // ═══════════════════════════════════════════════════════════════════
  // UI STATES
  // ═══════════════════════════════════════════════════════════════════
  function showState(state) {
    connectState.style.display = state === 'connect' ? 'block' : 'none';
    connectedInfo.style.display = (state === 'loading' || state === 'nokeys' || state === 'keys') ? 'block' : 'none';
    loadingState.style.display = state === 'loading' ? 'block' : 'none';
    noKeysState.style.display = state === 'nokeys' ? 'block' : 'none';
    keysToolbar.style.display = state === 'keys' ? 'block' : 'none';
    keysContainer.style.display = state === 'keys' ? 'grid' : 'none';
    mintMoreSection.style.display = state === 'keys' ? 'block' : 'none';
    
    // Update wallet address display
    if (currentAccount) {
      walletAddressEl.textContent = shortenAddress(currentAccount);
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // STEALTH MODE
  // ═══════════════════════════════════════════════════════════════════
  function isStealthEnabled(keyId) {
    try {
      var settings = JSON.parse(localStorage.getItem('z1n_stealth_keys') || '{}');
      return settings[keyId] === true;
    } catch (e) {
      return false;
    }
  }

  function toggleStealth(keyId, enabled) {
    try {
      var settings = JSON.parse(localStorage.getItem('z1n_stealth_keys') || '{}');
      settings[keyId] = enabled;
      localStorage.setItem('z1n_stealth_keys', JSON.stringify(settings));
      
      // Update label color
      var checkbox = document.getElementById('stealth-' + keyId);
      if (checkbox) {
        var label = checkbox.closest('.stealth-toggle').querySelector('.toggle-label');
        if (label) {
          label.style.color = enabled ? '#ffffff' : '';
        }
      }
      
      console.log('Stealth mode for Key #' + keyId + ':', enabled ? 'ON' : 'OFF');
    } catch (e) {
      console.error('Failed to save stealth setting:', e);
    }
  }

  // Make toggleStealth globally accessible
  window.toggleStealth = toggleStealth;
  window.isStealthEnabled = isStealthEnabled;

  // ═══════════════════════════════════════════════════════════════════
  // RENDER KEY CARD
  // ═══════════════════════════════════════════════════════════════════
  function renderKeyCard(key) {
    var card = document.createElement('div');
    card.className = 'key-card';
    card.style.cursor = 'pointer';
    
    // Click on card goes to key detail page
    card.onclick = function(e) {
      // Don't navigate if clicking on a link/button inside
      if (e.target.tagName === 'A' || e.target.closest('a')) return;
      window.location.href = 'key.html?id=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount);
    };

    var genesisHtml = key.genesis ? '<span class="genesis-badge">✶ Genesis</span>' : '';
    
    // Epoch display
    var epochDisplay = key.epoch !== null ? key.epoch : '—';

    // Signal status indicators (filled = green, open = yellow border)
    var signal1Status = key.signalsUsed >= 1 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    var signal2Status = key.signalsUsed >= 2 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    var attest1Status = key.attestsUsed >= 1 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';
    var attest2Status = key.attestsUsed >= 2 ? '<span class="dot-indicator filled"></span>' : '<span class="dot-indicator open"></span>';

    card.innerHTML = 
      '<div class="key-header">' +
        '<span class="key-id">Key #' + key.tokenId + '</span>' +
        genesisHtml +
      '</div>' +
      '<div class="key-glyphs">' + (key.glyphSymbols || '<span style="opacity:0.5; font-size:14px;">Glyphs pending...</span>') + '</div>' +
      '<div class="key-meta">' +
        '<span>Minted Epoch ' + epochDisplay + '</span>' +
        '<span><a href="' + EXPLORER + '/token/' + Z1N_KEY + '?a=' + key.tokenId + '" target="_blank" onclick="event.stopPropagation()">View on chain ↗</a></span>' +
      '</div>' +
      
      // SIGNALS SECTION
      '<div class="card-section">' +
        '<div class="section-header">Signals</div>' +
        '<div class="status-grid">' +
          '<a href="signals.html?key=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount) + '&slot=1" class="status-item" onclick="event.stopPropagation()">' +
            '<span class="status-label">Signal 1</span>' + signal1Status +
          '</a>' +
          '<a href="signals.html?key=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount) + '&slot=2" class="status-item" onclick="event.stopPropagation()">' +
            '<span class="status-label">Signal 2</span>' + signal2Status +
          '</a>' +
          '<a href="signals.html?key=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount) + '&tab=attest&slot=1" class="status-item" onclick="event.stopPropagation()">' +
            '<span class="status-label">Attest 1</span>' + attest1Status +
          '</a>' +
          '<a href="signals.html?key=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount) + '&tab=attest&slot=2" class="status-item" onclick="event.stopPropagation()">' +
            '<span class="status-label">Attest 2</span>' + attest2Status +
          '</a>' +
        '</div>' +
      '</div>' +
      
      // ARTEFACTS SECTION
      '<div class="card-section">' +
        '<div class="section-header">Artefacts</div>' +
        '<div class="artefact-stats">' +
          '<span class="artefact-stat">◈ Live: <span class="count">' + key.liveArtefacts + '</span></span>' +
          '<span class="artefact-stat">◇ Static: <span class="count">' + key.staticArtefacts + '</span></span>' +
        '</div>' +
        '<div class="artefact-actions">' +
          '<a href="mint-live-artefact.html?key=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount) + '" class="mint-btn" onclick="event.stopPropagation()">+ Mint Live</a>' +
          '<a href="mint-static-artefact.html?key=' + key.tokenId + '&wallet=' + encodeURIComponent(currentAccount) + '" class="mint-btn" onclick="event.stopPropagation()">+ Mint Static</a>' +
        '</div>' +
      '</div>' +
      
      // SETTINGS SECTION
      '<div class="card-section settings-section">' +
        '<div class="section-header">Settings</div>' +
        '<div class="stealth-toggle" onclick="event.stopPropagation()">' +
          '<label class="toggle-container">' +
            '<input type="checkbox" id="stealth-' + key.tokenId + '" onchange="toggleStealth(' + key.tokenId + ', this.checked)"' + (isStealthEnabled(key.tokenId) ? ' checked' : '') + '>' +
            '<span class="toggle-slider"></span>' +
          '</label>' +
          '<span class="toggle-label">Stealth Mode</span>' +
          '<span class="stealth-info" title="When enabled, PoG signals are sent via the Stealth Relayer for enhanced privacy. No protocol fee, your wallet identity is protected on-chain. Requires relayer service.">ⓘ</span>' +
        '</div>' +
      '</div>';

    return card;
  }

  // ═══════════════════════════════════════════════════════════════════
  // LOAD KEYS
  // ═══════════════════════════════════════════════════════════════════
  async function loadKeys() {
    showState('loading');
    console.log('Loading keys for:', currentAccount);
    console.log('Contract address:', Z1N_KEY);
    
    // Reset no keys message
    noKeysState.querySelector('p').textContent = 'This wallet has no Z1N Keys. If you own a Key on another wallet, use Switch Wallet above.';

    try {
      // Get current epoch from Core contract
      var currentEpochNum = await getCurrentEpoch();
      document.getElementById('currentEpoch').textContent = currentEpochNum !== null ? currentEpochNum : '—';
      
      console.log('Step 1: Getting balance...');
      var balance = await getKeyBalance(currentAccount);
      console.log('Key balance:', balance);

      if (balance === 0) {
        console.log('No keys found for this wallet');
        showState('nokeys');
        return;
      }

      var keys = [];

      for (var i = 0; i < balance; i++) {
        console.log('Step 2: Getting tokenId for index', i);
        var tokenId = await getTokenOfOwnerByIndex(currentAccount, i);
        console.log('Found tokenId:', tokenId);
        
        console.log('Step 3: Checking genesis status...');
        var genesis = await isGenesis(tokenId);
        console.log('Genesis:', genesis);
        
        console.log('Step 4: Getting glyphs...');
        var glyphData = await getGlyphs(tokenId);
        console.log('Glyphs:', glyphData);
        
        // Get glyph epoch (when glyphs were assigned)
        var mintEpoch = glyphData.epoch !== null && glyphData.epoch !== undefined ? glyphData.epoch : null;
        
        // Get signal and attest counts for current epoch
        console.log('Step 5: Getting signal/attest status...');
        var signalsUsed = 0;
        var attestsUsed = 0;
        if (currentEpochNum !== null) {
          signalsUsed = await getSignalCount(tokenId, currentEpochNum);
          attestsUsed = await getAttestCount(tokenId, currentEpochNum);
        }
        
        // Get artefact counts
        console.log('Step 6: Getting artefact counts...');
        var artefacts = await getArtefactCounts(tokenId);

        keys.push({
          tokenId: tokenId,
          genesis: genesis,
          glyphSymbols: decodeGlyphs(glyphData.len, glyphData.pack),
          epoch: mintEpoch,
          signalsUsed: signalsUsed,
          attestsUsed: attestsUsed,
          liveArtefacts: artefacts.live,
          staticArtefacts: artefacts.static
        });
      }

      keysContainer.innerHTML = '';
      keys.forEach(function(key) {
        keysContainer.appendChild(renderKeyCard(key));
      });

      showState('keys');

    } catch (err) {
      console.error('Error loading keys:', err);
      // Show error in UI for debugging
      noKeysState.querySelector('p').textContent = 'RPC Error: ' + err.message + '. Try refreshing the page.';
      showState('nokeys');
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // GET ETHEREUM PROVIDER (prefer MetaMask when multiple wallet extensions installed)
  // ═══════════════════════════════════════════════════════════════════
  function getProvider() {
    if (window.ethereum?.providers) {
      // Multiple wallets - find MetaMask
      return window.ethereum.providers.find(function(p) { return p.isMetaMask; }) || window.ethereum;
    }
    return window.ethereum;
  }

  // ═══════════════════════════════════════════════════════════════════
  // CONNECT WALLET
  // ═══════════════════════════════════════════════════════════════════
  async function connectWallet() {
    var eth = getProvider();
    if (!eth) {
      alert('Please install a Web3 wallet');
      return;
    }

    btnConnect.textContent = 'Connecting...';

    try {
      var accounts = await eth.request({ method: 'eth_requestAccounts' });
      if (accounts && accounts.length > 0) {
        allConnectedAccounts = accounts;
        
        // Check if wallet was specified in URL (from Signals page back link)
        var walletParam = getUrlParam('wallet');
        if (walletParam) {
          var walletLower = walletParam.toLowerCase();
          var found = accounts.find(function(a) { return a.toLowerCase() === walletLower; });
          if (found) {
            currentAccount = found;
          } else {
            currentAccount = accounts[0];
          }
        } else {
          currentAccount = accounts[0];
        }
        
        provider = eth;
        
        // Show wallet selector if multiple accounts
        showWalletSelector(accounts);
        
        loadKeys();
      }
    } catch (e) {
      console.error(e);
      btnConnect.textContent = 'Connect Wallet';
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // SWITCH WALLET (opens MM account picker)
  // ═══════════════════════════════════════════════════════════════════
  async function switchWallet() {
    var eth = getProvider();
    if (!eth) {
      alert('No wallet detected');
      return;
    }

    try {
      // Request wallet to show account picker
      // This opens the wallet's native account selection UI
      await eth.request({
        method: 'wallet_requestPermissions',
        params: [{ eth_accounts: {} }]
      });
    } catch (e) {
      // User cancelled or wallet doesn't support this method
      console.log('Permission request cancelled or not supported:', e.message);
    }
    
    // Always refresh accounts after permission request (even if cancelled)
    try {
      var accounts = await eth.request({ method: 'eth_requestAccounts' });
      if (accounts && accounts.length > 0) {
        allConnectedAccounts = accounts;
        currentAccount = accounts[0];
        provider = eth;
        
        // Show wallet selector if multiple accounts
        showWalletSelector(accounts);
        
        loadKeys();
      }
    } catch (e) {
      console.error('Failed to get accounts:', e);
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // INIT
  // ═══════════════════════════════════════════════════════════════════
  btnConnect.onclick = connectWallet;
  btnSwitch.onclick = switchWallet;
  btnRefresh.onclick = function() {
    if (currentAccount) loadKeys();
  };

  // NOTE: We intentionally do NOT listen to accountsChanged
  // The user controls which wallet is active within Z1N, not MetaMask

  // Auto-connect if already connected
  (async function() {
    var eth = getProvider();
    if (eth) {
      try {
        var accounts = await eth.request({ method: 'eth_accounts' });
        if (accounts && accounts.length > 0) {
          provider = eth;
          allConnectedAccounts = accounts;
          
          // Check if wallet was specified in URL
          var walletParam = getUrlParam('wallet');
          if (walletParam) {
            var walletLower = walletParam.toLowerCase();
            var found = accounts.find(function(a) { return a.toLowerCase() === walletLower; });
            if (found) {
              currentAccount = found;
            } else {
              currentAccount = accounts[0];
            }
          } else {
            currentAccount = accounts[0];
          }
          
          // Show wallet selector if multiple accounts
          showWalletSelector(accounts);
          
          loadKeys();
        }
      } catch (e) {}
    }
  })();

})();
</script>

</body>
</html>
